{% for emp_data in report %}
<div class="card mb-4">
  <div class="card-header employee-header p-4">
    <div class="d-flex align-items-center">
      <div class="employee-avatar bg-white bg-opacity-25 text-white p-3 rounded me-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; border: 3px solid rgba(255, 255, 255, 0.3);">
        {{ emp_data.personnel.nom_prenom|slice:":1"|upper }}
      </div>
      <div class="employee-info">
        <h2 class="employee-name mb-2">{{ emp_data.personnel.nom_prenom }}</h2>
        <div class="employee-badges d-flex flex-wrap gap-2">
          <span class="badge bg-primary"><i class="fas fa-building"></i> {{ emp_data.personnel.service.name|default:"Non affecté" }}</span>
          <span class="badge bg-primary"><i class="fas fa-user-tag"></i> {{ emp_data.personnel.poste.label|default_if_none:"Poste non défini" }}</span>
          <span class="badge bg-primary"><i class="fas fa-id-badge"></i> # {{ emp_data.personnel.employee.anviz_id|default:"NC" }}</span>
          <span class="badge bg-primary"><i class="fas fa-coins"></i> {{ emp_data.totals.taux_horaire|floatformat:2 }} DZD/H</span>
        </div>
      </div>
    </div>
    <button class="btn btn-outline-light rounded-pill sync-btn mt-3" data-bs-toggle="modal" data-bs-target="#addHeuresModal">
      <i class="fas fa-plus me-2"></i>
      <span class="d-none d-md-inline">Ajouter Heures</span>
    </button>
  </div>
  <div class="card-body">
    <div class="presence-indicator p-4 bg-light rounded mb-4">
      <div class="d-flex justify-content-between mb-2">
        <div class="presence-title"><i class="fas fa-calendar-check"></i> Taux de présence</div>
        <div class="presence-percentage" data-target="{{ emp_data.totals.taux_presence }}">0.0%</div>
      </div>
      <div class="progress" style="height: 20px;">
        <div class="progress-bar progress-fill" role="progressbar" style="width: {{ emp_data.totals.taux_presence|floatformat:0 }}%" aria-valuenow="{{ emp_data.totals.taux_presence|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
      <div class="col">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="metric-icon bg-primary text-white p-2 rounded me-3"><i class="fas fa-clock"></i></div>
              <div class="metric-title">Heures Travaillées</div>
            </div>
            <div class="metric-value">{{ emp_data.totals.regular_hours_formatted }}</div>
            <span class="text-success">+ {{ emp_data.salaire.salaire_base|floatformat:2 }} DZD</span>
            <div class="mt-3 pt-3 border-top">
              <div class="d-flex justify-content-between text-muted">
                <span>Ind. repas</span>
                <span class="text-success">+ {{ emp_data.salaire.indemnites.repas|floatformat:2 }} DZD</span>
              </div>
              <div class="d-flex justify-content-between text-muted">
                <span>Ind. transport</span>
                <span class="text-success">+ {{ emp_data.salaire.indemnites.transport|floatformat:2 }} DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="metric-icon bg-primary text-white p-2 rounded me-3"><i class="fas fa-stopwatch"></i></div>
              <div class="metric-title">Heures Supplémentaires</div>
            </div>
            <div class="metric-value">{{ emp_data.totals.validated_regular_formatted }}</div>
            <span class="text-success">+{{ emp_data.totals.validated_overtime_amount|floatformat:2 }} DZD</span>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="metric-icon bg-primary text-white p-2 rounded me-3"><i class="fas fa-calendar-alt"></i></div>
              <div class="metric-title">Jours Fériés</div>
            </div>
            <div class="metric-value">{{ emp_data.totals.holidays_count }} jour(s)</div>
            <span class="text-success">+{{ emp_data.totals.paid_holidays_amount|default:0|floatformat:2 }} DZD</span>
            <div class="mt-3 pt-3 border-top">
              <div class="d-flex justify-content-between">
                <span class="public-holiday-overtime">+ {{ emp_data.totals.validated_holiday_formatted }}</span>
                <span class="text-success">+{{ emp_data.totals.public_holiday_overtime_amount|default:0|floatformat:2 }} DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="metric-icon bg-primary text-white p-2 rounded me-3"><i class="fas fa-exclamation-triangle"></i></div>
              <div class="metric-title">Absences & Retards</div>
            </div>
            <div class="metric-value">{{ emp_data.totals.absence }} absence(s)</div>
            <span class="text-danger">-{{ emp_data.totals.absence_amount|floatformat:2 }} DZD</span>
            <div class="mt-3 pt-3 border-top">
              <div class="d-flex justify-content-between text-muted">
                <span>{{ emp_data.totals.late_formatted }} retard</span>
                <span class="text-danger">-{{ emp_data.totals.late_amount|floatformat:2 }} DZD</span>
              </div>
              <div class="d-flex justify-content-between text-muted">
                <span>{{ emp_data.totals.early_formatted }} départ</span>
                <span class="text-danger">-{{ emp_data.totals.early_leave_amount|floatformat:2 }} DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card salary-card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="deduction-item p-3">
              <div class="deduction-label">IRG</div>
              <div class="deduction-value">-{{ emp_data.salaire.deductions.irg|floatformat:2 }} DZD</div>
              <div class="deduction-label">CNAS</div>
              <div class="deduction-value">-{{ emp_data.salaire.deductions.cnas|floatformat:2 }} DZD</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="deduction-item p-3">
              <div class="deduction-label"><i class="fas fa-wallet"></i> Salaire Net à Payer</div>
              <div class="salary-amount">{{ emp_data.salaire.salaire_net|floatformat:2 }} DZD</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="deduction-item p-3">
              <div class="deduction-label"><i class="fas fa-wallet"></i> Avances Sur Salaire</div>
              <div class="salary-amount">{{ emp_data.salaire.avances|floatformat:2 }} DZD</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="deduction-item p-3">
              <div class="deduction-label"><i class="fas fa-wallet"></i> Salaire Net à Payer Après Avance</div>
              <div class="salary-amount">{{ emp_data.salaire.salaire_net_apres_avance|floatformat:2 }} DZD</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="daily-details">
      <div class="d-flex justify-content-between mb-3">
        <div class="section-title"><i class="fas fa-calendar-day"></i> Détails Journaliers</div>
        <div class="days-count">{{ emp_data.days|length }} jours analysés</div>
      </div>
      <table class="table daily-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Plages Horaires</th>
            <th>Total</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for day in emp_data.days %}
          <tr class="{% if not day.entries and not day.is_absent %} table-info {% elif day.is_holiday %} table-success {% elif day.is_weekend %} table-primary {% elif day.is_absent %} table-danger {% endif %}">
            <td>
              <div class="date-main">{{ day.date|date:"d/m/Y" }}</div>
              <div class="date-sub">{{ day.date|date:"l"|capfirst }}</div>
            </td>
            <td>
              {% for pair in day.pairs %}
              <div class="time-pair d-flex">
                {% if pair.0 %}
                <div class="time-entry me-2">
                  <span class="time-value">{{ pair.0.check_time|time:"H:i" }}</span>
                  {% if day.early_overtime != '-' %}
                  <span class="badge bg-warning text-dark">⏪ {{ day.early_overtime }}</span>
                  {% endif %}
                </div>
                {% endif %}
                {% if pair.1 %}
                <div class="time-entry">
                  <span class="time-value">{{ pair.1.check_time|time:"H:i" }}</span>
                  {% if day.late_overtime != '-' %}
                  <span class="badge bg-warning text-dark">⏩ {{ day.late_overtime }}</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </td>
            <td>
              <div class="total-main">{{ day.total|default:"-" }}</div>
              {% if day.overtime != '-' %}
              <div class="total-details">
                <span class="badge bg-info">{{ day.overtime }}</span>
              </div>
              {% endif %}
              {% if day.late_minutes != '-' %}
              <div class="total-details">
                <span class="badge bg-danger">Retard: {{ day.late_minutes }}</span>
              </div>
              {% endif %}
              {% if day.early_leave_minutes != '-' %}
              <div class="total-details">
                <span class="badge bg-danger">Départ: {{ day.early_leave_minutes }}</span>
              </div>
              {% endif %}
            </td>
            <td>
              {% if not day.entries and not day.is_absent %}
              <span class="badge bg-secondary"><i class="fas fa-bed"></i> Repos</span>
              {% elif day.is_holiday %}
              <span class="badge bg-success"><i class="fas fa-flag"></i> Férié</span>
              {% elif day.is_weekend %}
              <span class="badge bg-primary"><i class="fas fa-umbrella-beach"></i> Week-end</span>
              {% elif day.is_absent %}
              <span class="badge bg-danger"><i class="fas fa-bed"></i> Absence</span>
              {% elif day.late_minutes != '-' %}
              <span class="badge bg-warning"><i class="fas fa-clock"></i> Retard</span>
              {% else %}
              <span class="badge bg-success"><i class="fas fa-check-circle"></i> Conforme</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endfor %}