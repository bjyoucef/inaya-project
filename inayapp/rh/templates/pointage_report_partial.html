<!-- pointage_report_partial.html -->
{% for emp_data in report %}
<div class="dashboard-card mb-4">
  <!-- En-tête employé -->
  <div class="p-4 border-bottom">
    <div class="d-flex align-items-center gap-3">
      <div class="avatar-circle bg-primary text-white fs-3 fw-bold shadow-sm">
        {{ emp_data.personnel.nom_prenom|slice:":1"|upper }}
      </div>
      <div>
        <h2 class="h5 mb-1 fw-600">{{ emp_data.personnel.nom_prenom }}</h2>
        <div class="d-flex gap-2">
          <span class="badge bg-light text-dark">
            <i class="bi bi-building me-1"></i>
            {{ emp_data.personnel.service.name|default:"Non affecté" }}
          </span>
          <span class="badge bg-light text-dark">
            <i class="fas fa-user-tag me-1"></i>
            {{ emp_data.personnel.poste.label|default_if_none:"Poste non défini" }}
          </span>
          <span class="badge bg-light text-dark">
            #{{ emp_data.personnel.employee.anviz_id|default:"NC" }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistiques principales -->
  <div class="p-4">
    <!-- Taux de présence -->
    <div class="mb-4">
      <div class="presence-header mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">
            <i class="fas fa-calendar-check me-2"></i>Taux de présence
          </h5>
          <span
            class="badge fs-6 {% if emp_data.totals.taux_presence >= 75 %} bg-success {% elif emp_data.totals.taux_presence >= 50 %} bg-warning {% else %} bg-danger {% endif %}"
          >
            {{ emp_data.totals.taux_presence|floatformat:1 }}%
          </span>
        </div>
        <div class="progress rounded-pill" style="height: 20px">
          <div
            class="progress-bar {% if emp_data.totals.taux_presence >= 75 %} bg-success {% elif emp_data.totals.taux_presence >= 50 %} bg-warning {% else %} bg-danger {% endif %}"
            role="progressbar"
            style="width: {{ emp_data.totals.taux_presence|floatformat:0 }}%;"
            aria-valuenow="{{ emp_data.totals.taux_presence|floatformat:0 }}"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
      </div>

      <!-- Grille métriques -->
      <div class="metric-grid row g-3">
        <!-- Heures normales -->
        <div class="col">
          <div class="metric-glance">
            <div class="text-muted small mb-2">Heures travaillées</div>
            <div class="d-flex align-items-center justify-content-between">
              <div class="h4 mb-0">
                {{ emp_data.totals.regular_hours_formatted }}
              </div>
              <div class="text-success">
                +{{ emp_data.salaire.salaire_base|floatformat:2 }} DZD
              </div>
            </div>
            <div class="mt-2">
              <div class="d-flex justify-content-between small">
                <span>Indemnité repas</span>
                <span
                  >+{{ emp_data.salaire.indemnites.repas|floatformat:2 }}
                  DZD</span
                >
              </div>
              <div class="d-flex justify-content-between small">
                <span>Indemnité transport</span>
                <span
                  >+{{ emp_data.salaire.indemnites.transport|floatformat:2 }}
                  DZD</span
                >
              </div>
            </div>
          </div>
        </div>
<!-- Dans la section des heures supplémentaires -->
<div class="col">
    <div class="metric-glance">
      <div class="text-muted small mb-2">Heures supplémentaires Validées</div>
      <div class="d-flex flex-column gap-2">
        <div class="d-flex justify-content-between">
          <span>{{ emp_data.totals.validated_regular_formatted }}</span>
          <span class="text-success">
            +{{ emp_data.totals.validated_overtime_amount|floatformat:2 }} DZD
          </span>
        </div>
        <div class="progress" style="height: 4px;">
          <div class="progress-bar bg-success" 
               style="width: {{ emp_data.totals.validation_ratio }}%"></div>
        </div>

        <div class="d-flex justify-content-between small">
          <span>Non validées</span>
          <span class="text-danger">
            {{ emp_data.totals.non_validated_regular|floatformat:2 }}h
          </span>
        </div>
      </div>
    </div>
  </div>
        


        <!-- Jours fériés -->
        <div class="col">
          <div class="metric-glance">
            <div class="text-muted small mb-2">Jours fériés</div>
            <div class="d-flex flex-column gap-2">
              <div class="d-flex justify-content-between">
                <span
                  >{{ emp_data.totals.public_holiday_overtime_formatted }}</span
                >
                <span class="text-success"
                  >+{{ emp_data.totals.public_holiday_overtime_amount|default:0|floatformat:2 }} DZD</span
                >
              </div>
              <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-success" 
                     style="width: {{ emp_data.totals.validation_ratio }}%"></div>
              </div>
              <div class="d-flex justify-content-between small">
                <span>Non travaillés</span>
                <span
                  >+{{ emp_data.totals.paid_holidays_amount|default:0|floatformat:2 }} DZD</span
                >
              </div>
              <div class="d-flex justify-content-between small">
                <span>Validées</span>
                <span class="text-success">
                  {{ emp_data.totals.validated_holiday|floatformat:2 }}h
                </span>
              </div>
              <div class="d-flex justify-content-between small">
                <span>Non validées</span>
                <span class="text-danger">
                  {{ emp_data.totals.non_validated_holiday|floatformat:2 }}h
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Absences & retards -->
        <div class="col">
          <div class="metric-glance">
            <div class="text-muted small mb-2">Absences & retards</div>
            <div class="d-flex flex-column gap-2">
              <div class="d-flex justify-content-between">
                <span>{{ emp_data.totals.absence }} absences</span>
                <span class="text-danger"
                  >-{{ emp_data.totals.absence_amount|floatformat:2 }} DZD</span
                >
              </div>
              <div class="d-flex justify-content-between small">
                <span>{{ emp_data.totals.late }} min retard</span>
                <span
                  >-{{ emp_data.totals.late_amount|floatformat:2 }} DZD</span
                >
              </div>
              <div class="d-flex justify-content-between small">
                <span>{{ emp_data.totals.early_leave }} min départ</span>
                <span
                  >-{{ emp_data.totals.early_leave_amount|floatformat:2 }}
                  DZD</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Déductions -->
        <div class="col">
          <div class="metric-glance">
            <div class="text-muted small mb-2">Déductions</div>
            <div class="d-flex flex-column gap-2">
              <div class="d-flex justify-content-between">
                <span>IRG</span>
                <span class="text-danger"
                  >-{{ emp_data.salaire.deductions.irg|floatformat:2 }}
                  DZD</span
                >
              </div>
              <div class="d-flex justify-content-between">
                <span>CNAS</span>
                <span class="text-danger"
                  >-{{ emp_data.salaire.deductions.cnas|floatformat:2 }}
                  DZD</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Net -->
      <div class="alert alert-success border-0 shadow-sm mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="fas fa-wallet fa-2x me-3"></i>
            <h4 class="mb-0">Salaire Net à Payer</h4>
          </div>
          <span class="display-5 fw-bold"
            >{{ emp_data.salaire.salaire_net|floatformat:2 }} DZD</span
          >
        </div>
      </div>
    </div>

    <!-- Détails journaliers -->
    <div class="p-4 border-top">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Détails journaliers</h5>
        <span class="badge bg-light text-dark"
          >{{ emp_data.days|length }} jours</span
        >
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="bg-light">
            <tr>
              <th class="ps-4">Date</th>
              <th>Plages horaires</th>
              <th class="text-end">Total</th>
              <th class="text-end">Heures supp.</th>
              <th class="text-end">Retard</th>
              <th class="text-end">Départ</th>
              <th class="pe-4">Statut</th>
            </tr>
          </thead>
          <tbody>
            {% for day in emp_data.days %}
            <tr
              class="{% if day.is_holiday %}table-success{% elif day.is_weekend %}table-info{% elif not day.entries %}table-danger{% endif %}"
            >
              <td>
                <div class="fw-500">{{ day.date|date:"d/m/Y" }}</div>
                <div class="text-muted small">
                  {{ day.date|date:"l"|capfirst }}
                </div>
              </td>

              <td>
                {% for pair in day.pairs %}
                
                <div class="time-range-chip mb-2">
                  <!-- Entrée -->
                  <div class="d-flex align-items-center gap-2">
                    <span class="start-time">{{ pair.0.check_time|time:"H:i" }}</span>
                    {% with first_pair=day.pairs|first %} 
                    {% if day.early_overtime != '-' or day.is_holiday_worked or day.is_weekend %}
                    <div class="text-muted small">
                      ⏪ {{ day.early_overtime }}
                    </div>

                    {% for att in day.pointages %} 
                    {% if att.check_time == first_pair.0.check_time %}
                    <form
                      method="post"
                      data-url="{% url 'validate_overtime' att.id %}?{{ request.GET.urlencode }}"
                      class="d-inline js-ov-form"
                    >
                      {% csrf_token %}
                      <button
                        type="submit"
                        class="btn btn-sm btn-outline-{{ att.ov_validated|yesno:'danger,success' }} js-ov-btn"
                        data-pointage-id="{{ att.id }}"
                      >
                        {% if att.ov_validated %}Annuler{% else %}Valider{% endif %}
                      </button>
                    </form>

                    {% endif %} {% endfor %} {% endif %} {% endwith %}
                  </div>

                  <!-- Sortie -->
                  {% if pair.1.check_time %}
                  <div class="d-flex align-items-center gap-2 mt-1">
                    <span class="end-time">{{ pair.1.check_time|time:"H:i" }}</span>
                    {% with last_pair=day.pairs|last %} 
                    {% if day.late_overtime != '-' or day.is_holiday_worked or day.is_weekend %}
                    <div class="text-muted small">
                      ⏩ {{ day.late_overtime }}
                    </div>
                    {% comment %} on récupère l’objet Pointage correspondant à
                    la sortie {% endcomment %} 
                    {% for att in day.pointages %} 
                    {% if att.check_time == last_pair.1.check_time %}
                    <form
                      method="post"
                      data-url="{% url 'validate_overtime' att.id %}?{{ request.GET.urlencode }}"
                      class="d-inline js-ov-form"
                    >
                      {% csrf_token %}
                      <button
                        type="submit"
                        class="btn btn-sm btn-outline-{{ att.ov_validated|yesno:'danger,success' }} js-ov-btn"
                        data-pointage-id="{{ att.id }}"
                      >
                        {% if att.ov_validated %}Annuler{% else %}Valider{% endif %}
                      </button>
                    </form>

                    {% endif %} {% endfor %} {% endif %} {% endwith %}
                  </div>
                  {% endif %}
                </div>
                
                {% endfor %}
              </td>

              <td class="text-end fw-semibold">{{ day.total|default:"-" }}</td>

              <td class="text-end">
                <div class="overtime-details">
                  {% if day.overtime != '-' %}
                  <div class="text-success">{{ day.overtime }}</div>
                  {% endif %}
                </div>
              </td>

              <td class="text-end">
                {% if day.late_minutes %}
                <span class="text-danger">{{ day.late_minutes }}</span>
                {% endif %}
              </td>

              <td class="text-end">
                {% if day.early_leave_minutes %}
                <span class="text-warning">{{ day.early_leave_minutes }}</span>
                {% endif %}
              </td>

              <td class="pe-4">
                {% if day.is_holiday %}
                <span
                  class="badge bg-success bg-opacity-10 text-success d-flex align-items-center gap-1"
                >
                  <i class="fas fa-flag"></i>
                  Férié
                </span>
                {% elif day.is_weekend %}
                <span
                  class="badge bg-primary bg-opacity-10 text-primary d-flex align-items-center gap-1"
                >
                  <i class="fas fa-umbrella-beach"></i>
                  Week-end
                </span>
                {% elif not day.entries %}
                <span
                  class="badge bg-danger bg-opacity-10 text-danger d-flex align-items-center gap-1"
                >
                  <i class="fas fa-bed"></i>
                  Absence
                </span>
                {% elif day.late_minutes %}
                <span
                  class="badge bg-warning bg-opacity-10 text-warning d-flex align-items-center gap-1"
                >
                  <i class="fas fa-clock"></i>
                  Retard
                </span>
                {% else %}
                <span
                  class="badge bg-success bg-opacity-10 text-success d-flex align-items-center gap-1"
                >
                  <i class="fas fa-check-circle"></i>
                  Conforme
                </span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endfor %}
