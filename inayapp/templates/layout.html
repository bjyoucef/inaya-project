{% load static %} 
{% load permissions_tags %}

<!DOCTYPE html>
<html lang="fr" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Inaya - Application de gestion médicale">

    <title>INAYA | {{ title|default:"Gestion Médicale" }}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icon/favicon.ico' %}">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/bootstrap-icons.min.css' %}" rel="stylesheet">
    <link href="{% static 'fontawesomefree/css/all.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <link href="{% static 'css/toastify.css' %}" rel="stylesheet">
    <link href="{% static 'css/choices.min.css' %}" rel="stylesheet">
</head>

<body class="d-flex flex-column">
    <!-- Preloader -->
    <div id="js-preloader" class="js-preloader" role="status" aria-label="Chargement">
    <div class="preloader-inner">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 841.9 500">
            <style>
                .st0 { fill: #7a6ad8; }
            </style>
            <path class="st0" d="M401.2,37.2c7.4-10.2,14.5-20.3,21.8-30.1c0.7-1,2.7-1,4.2-1.4c14.8,26.9,29.2,53.4,43.9,79.8
	c8.7,15.7,18.6,30.9,24.1,48.2c4.1,13,5.4,26.2,4,40c-1.4,14.8-5,28.6-12.4,41.4c-3.3,5.7-7.3,11.1-11.6,16.1
	c-6.6,7.6-13.6,15-20.9,21.9c-9.9,9.4-20.3,18.2-30.3,27.5c-16.6,15.4-27.2,34.6-33.8,55.9c-3.2,10.1-5.5,20.8-5.9,31.3
	c-0.5,15.5,4,30.1,13.7,42.9c-0.7-5-1.8-10-2.2-15.1c-0.5-7.9-1-15.9-0.8-23.8c0.2-7.3,1.1-14.7,1.9-22c1.7-15.6,8.2-29.3,16.9-42.1
	c9.1-13.2,21-23.7,32.9-34.3c12.3-10.9,23.4-23.2,34.5-35.3c8.9-9.8,17.2-20.1,25.5-30.4c5.7-7,11.2-14.3,16.6-21.6
	c9.1-12.2,21.3-20.4,35.2-25.9c21.5-8.5,43.1-16.8,62.3-30c13.7-9.4,25.2-20.7,34.7-34.2c2-2.8,4.3-5.4,6.8-7.7
	c1.2-1.1,3.1-1.4,4.6-2c0.6,1.6,1.8,3.2,1.7,4.8c-0.5,6-1,12-2.3,17.9c-5,22.8-11.7,45.1-20.8,66.5c-8.7,20.5-19.4,39.9-34.3,57
	c-16,18.4-35.6,31.8-55.9,44.4c-17.2,10.6-35.3,19.9-52.8,30.1c-13.4,7.8-21.3,20.5-26.6,34.4c-7.4,19.4-12.4,39.6-15.3,60.2
	c-2.5,18.4-4.8,37-13.1,53.8c-6.5,13.2-14.1,25.9-21.4,38.8c-1.5,2.6-3.1,2.7-5.4-0.2c-13.7-17.1-26.4-34.7-35.5-54.7
	c-7.5-16.6-13.4-33.8-15.5-52c-1-8.8-1.9-17.7-1.9-26.5c0-14.1,3.7-27.5,8.9-40.5c6.5-16.5,15.9-31.3,28.4-43.6
	c10.4-10.2,22.5-18.8,34.3-27.4c20.2-14.8,33.5-34.4,40.1-58.1c3.5-12.6,1.1-25.6-2.3-38.2c-7.2-27-18.8-52.2-32-76.7
	c-7.2-13.4-15.4-26.4-23.2-39.5c-1.8-3-2.9-1.5-4.3,0.7c-8.3,12.9-17.1,25.4-25.1,38.5c-9.2,14.9-18.3,30-26.3,45.5
	c-6.8,13.2-10.4,27.5-11.9,42.6c-2.1,21.2,6.9,37.8,18.5,53.9c7.5,10.3,15.2,20.6,22.9,30.8c2.5,3.3,5.6,6.1,7.7,9.5
	c1,1.6,0.1,4.4,0,6.6c-2.1-0.5-4.5-0.5-6.1-1.6c-11.2-7.6-18.1-19.2-26.5-29.3c-9.7-11.8-17.5-24.7-21.6-39.6
	c-4.1-15-5.4-30-3.8-45.5c1.8-17.7,6.7-34.3,15.4-49.4c10.7-18.7,23.1-36.5,34.7-54.6C397.5,42.1,399.3,39.8,401.2,37.2 M609.5,205
	c9.5-17.9,19-35.7,28.3-53.2c-12.4,9.4-24.2,20.1-37.6,28.2c-23.3,14.1-36.3,18.5-43.9,17.4c18.4-15,36.3-29.5,54.1-44.1
	c-0.4-0.6-0.8-1.1-1.2-1.7c-17.9,8.8-36.2,17.2-53.7,26.7c-8.2,4.5-15.8,10.5-22.3,17.3c-10.2,10.6-18,23.1-24.3,36.5
	c-8,17-19.4,31.4-36,43.4c2.7-0.6,4.1-0.6,5.1-1.2c11.8-6,21.4-14.9,30.5-24.4c9.5-10,18.7-20.4,28.9-29.7
	c16.4-15,36.4-24,57.3-31.2c5.6-2,8.9-0.4,9.9,5.3c0.6,3.6,0.5,7.7-0.7,11.1c-2.9,8-6.7,15.7-10.1,23.5
	C601,222.6,604.2,213.6,609.5,205 M551,271.5c9.5-6.3,18.9-12.7,25.6-22.2c-3.2,1.6-5.7,3.9-8.5,6c-21,16.3-45,26-70.7,31.6
	c-22.7,4.9-42.6,14.2-57,33.1c-7.3,9.6-14.1,19.8-15.5,32.2c-1.4,11.5-2.6,23.1-2.9,34.7c-0.3,12.2,0.4,24.5,0.9,36.7
	c0.2,5,1.2,10.1,1.8,15.1c0.5,0.1,0.9,0.2,1.4,0.3c0.9-1.5,2.1-2.9,2.7-4.6c5.1-14.6,5.3-30,7-45.1c1.4-12,2.2-24,4.1-35.9
	c2-12.4,8.2-23.2,17-31.9c11.8-11.6,26.9-18.1,41.9-24.5C516.6,289.6,534.3,282.5,551,271.5z"/>
            <path class="st0" d="M185.9,157c-3.9-11-8.2-21.5-7.9-33.1c0-1.6,0.8-4.4,1.6-4.6c1.7-0.3,4,0.3,5.4,1.4c3.9,3.1,7.2,6.8,11.1,9.8
	c9.7,7.3,18.9,15.7,29.6,21.1c22.2,11.1,45.3,20.3,67.9,30.7c16.1,7.5,32.9,13.9,47.4,24.7c16.6,12.3,29,28,37,47
	c3.6,8.5,5.9,17.2,5.1,26.5c-1.8,19.2-16.4,34.4-34.9,33.2c-9.1-0.6-18.2-4-26.9-7.1c-17.1-6.3-32.4-16.1-46-28.1
	c-13.6-12.1-26.2-25.4-38.8-38.5c-13.1-13.6-23.4-29.4-32.6-45.8C197.2,182.3,191.9,169.7,185.9,157 M328,219.5
	c-7.6-4.8-14.9-10.2-22.9-14.3c-8.8-4.5-18.6-7.2-27.2-11.9c-22.5-12.5-44.5-25.7-66.8-38.5c-3.8-2.2-7.7-4.1-11.5-6.2
	c-0.3,0.4-0.6,0.7-0.9,1.1c4,7.2,7.9,14.6,12.1,21.7c7.4,12.8,14.5,25.7,22.4,38.2c13.7,21.7,28.6,42.6,48.8,58.8
	c7.5,6,15.4,12.3,24.1,15.9c13.9,5.7,28.5,9.4,43,13.6c3.2,0.9,7.2,1.2,10.3,0.1c7.6-2.7,14.1-16.6,10.7-24
	c-4.3-9.4-9.5-18.5-15.4-27C347.7,236.5,339.1,227.2,328,219.5z"/>
            <path class="st0" d="M402.2,201.6c5.9,11.6,15,19.8,25.1,27.5c-5.5,1.3-13.2-0.8-19.7-5c-15.3-10-26-24-30.1-41.5
	c-6.3-26.7-0.2-50.8,21-69.3c6.3-5.5,14.8-8.7,22.4-12.7c1.3-0.7,3-0.5,5.4-0.8C393.2,128.3,386,162.1,402.2,201.6z"/>
        </svg>
        <div class="dots" aria-hidden="true">
                {% for i in "1234567" %}<span class="dot"></span>{% endfor %}
        </div>
    </div>
</div>

<!-- Header with login/logout -->
<header class="header sticky-top py-2 shadow-sm" style="background-color: #7a6ad8;">
    <nav class="container-fluid d-flex justify-content-between align-items-center">
            <a href="{% url 'home' %}" class="brand-logo d-flex align-items-center gap-2 text-decoration-none">
                <img src="{% static 'icon/logo_inaya.svg' %}" alt="Accueil" width="40" height="40">
                <span class="text-white fs-5 fw-semibold">INAYA</span>
            </a>
            {% if user.is_authenticated %}
            <div class="dropdown">
        <button id="userDropdown" class="btn btn-transparent text-white dropdown-toggle d-flex align-items-center gap-2"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Menu utilisateur">
                        <i class="fas fa-user-circle fs-5"></i>
                        <span class="d-none d-md-inline">{{ user.first_name }} {{ user.last_name }}</span>
                </button>

        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown"
            style="min-width: 200px; z-index: 1030;">
            <li>
                <a class="dropdown-item d-flex align-items-center gap-2" href="{% url 'admin:index' %}">
                    <i class="fas fa-cog"></i> Administration
                </a>
            </li>
                    <li>
                <hr class="dropdown-divider m-0">
                    </li>
                    <li>
                <form method="post" action="{% url 'admin:logout' %}">
                            {% csrf_token %}
                    <button type="submit" class="dropdown-item d-flex align-items-center gap-2 text-danger"
                        aria-label="Déconnexion">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                            </button>
                        </form>
                    </li>
                </ul>
        </div>
        {% else %}
            <a href="{% url 'admin:login' %}" class="btn btn-outline-light">
                    <i class="fas fa-sign-in-alt me-2"></i>Connexion
            </a>
        {% endif %}
        <div class="theme-switcher end">
    <button type="button" 
            class="btn btn-link text-white" 
            id="themeToggle"
            aria-label="Changer le thème"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Thème clair/sombre">
        <i class="fas fa-adjust"></i>
    </button>
</div>
    </nav>
</header>

    <!-- Main Content -->
<div class="container-fluid flex-grow-1">
    <div class="row flex-grow-0">


<aside class="sidebar col-lg-2 d-flex flex-column">
  <nav class="sidebar-nav flex-grow-1 sticky-top">
    <ul class="nav flex-column">
      {% for group in menu_groups %}
        {% has_permission request.user group.permission as can_view_group %}
        {% if can_view_group %}

          {% group_is_active group as is_active %}

          <li class="nav-item">
<a 
  class="nav-link dropdown-toggle nav-group-toggle d-flex align-items-center mb-2 mt-2 rounded-3 text-white bg-gradient border border-white border-opacity-25 shadow-sm"
  data-bs-toggle="collapse"
  href="#menu-{{ group.id }}"
  role="button"
  aria-expanded="{{ is_active|yesno:'true,false' }}"
>
  <i class="{{ group.icon }} fs-5"></i>
  <span class="flex-grow-1 d-flex justify-content-center">{{ group.name }}</span>
</a>


            <div class="collapse {% if is_active %}show{% endif %}" id="menu-{{ group.id }}">
              <ul class="nav flex-column">
                {% for item in group.items.all %}
                  {% has_permission request.user item.permission as can_view_item %}
                  {% if can_view_item %}
                    <li class="nav-item">
                      <a href="{{ item.route }}"
                         class="nav-link d-flex align-items-center gap-2 py-2 px-4 text-white{% if request.path == item.route %} active{% endif %}"
                         aria-current="{% if request.path == item.route %}page{% endif %}">
                        <i class="{{ item.icon }}"></i>
                        {{ item.label }}
                        {% include 'partials/menu-badges.html' with item=item %}
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </nav>
</aside>


            <!-- Content Area -->
            <main class="col-lg-10">
                <div class="container-fluid py-4 px-3">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</div>
<!-- Bon ordre à garder -->
<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/toastify-js.js' %}"></script>
<script src="{% static 'js/custom.js' %}"></script>

{% if messages %}
{% for message in messages %}
    <script>
    Toastify({
        text: "{{ message|escapejs }}",
        duration: 5000,
        gravity: "bottom",
        position: "right",
        style: {
            background: "{{ message.bg_color }}",
            borderRadius: "20px",
        },
        close: true,
    }).showToast();
    </script>
{% endfor %}
{% endif %}


<script>
document.addEventListener('DOMContentLoaded', function() {
    const getStoredTheme = () => localStorage.getItem('theme');
    const setStoredTheme = theme => localStorage.setItem('theme', theme);

    const getSystemTheme = () => {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 
            'dark' : 'light';
    };

    const applyTheme = (theme) => {
        document.documentElement.setAttribute('data-bs-theme', theme);
        const btn = document.querySelector('#themeToggle');
        btn.innerHTML = theme === 'dark' ? 
            '<i class="fas fa-sun"></i>' : 
            '<i class="fas fa-moon"></i>';
        
        // Enregistrement côté serveur pour utilisateurs connectés
        {% if user.is_authenticated %}
        fetch('/update-theme/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({theme: theme})
})
.then(response => {
    if (!response.ok) {
        throw new Error('Erreur réseau');
    }
    return response.json();
})
.then(data => {
    if(data.status !== 'success') {
        console.error('Erreur:', data.message);
    }
})
.catch(error => {
    console.error('Erreur:', error);
});
        {% endif %}
    };

    // Initialisation avec priorité : stockage local > système > light
    const initialTheme = getStoredTheme() || getSystemTheme() || 'light';
    applyTheme(initialTheme);

    // Gestion du clic
    document.querySelector('#themeToggle').addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        setStoredTheme(newTheme);
    });

});
</script>


</body>
</html>
