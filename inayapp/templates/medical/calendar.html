{% extends "layout.html" %} 
{% load static %}

{% block content %}

<div class="row mb-3">
    <div class="col-md-4">
        <select class="form-select" id="filter-medecin">
            <option value="">Tous les médecins</option>
            {% for medecin in medecins %}
            <option value="{{ medecin.id }}">{{ medecin.nom_complet }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <select class="form-select" id="filter-statut">
            <option value="">Tous les statuts</option>
            {% for statut in statuts %}
            <option value="{{ statut.0 }}">{{ statut.1 }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="container-fluid">
    <div id="calendar"></div>
</div>

<!-- Modal pour les détails -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Détails du Rendez-vous</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Patient:</strong> <span id="modal-patient"></span></p>
                <p><strong>Médecin:</strong> <span id="modal-medecin"></span></p>
                <p><strong>Motif:</strong> <span id="modal-motif"></span></p>
                <p><strong>Statut:</strong> <span id="modal-statut"></span></p>
                <p><strong>Notes:</strong> <span id="modal-notes"></span></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 100%;
        margin: 20px auto;
        padding: 0 10px;
    }
    .fc-event {
        cursor: pointer;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/locales/fr.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'fr',
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay listWeek'
        },
        events: '{% url "rendezvous_json" %}',
        eventClick: function(info) {
            const event = info.event
            document.getElementById('modal-patient').textContent = event.extendedProps.patient
            document.getElementById('modal-medecin').textContent = event.extendedProps.medecin
            document.getElementById('modal-motif').textContent = event.extendedProps.motif
            document.getElementById('modal-statut').textContent = event.extendedProps.statut
            document.getElementById('modal-notes').textContent = event.extendedProps.notes
            new bootstrap.Modal(document.getElementById('eventModal')).show()
        },
        eventDidMount: function(info) {
            info.el.setAttribute('data-bs-toggle', 'tooltip')
            info.el.setAttribute('title', 
                `Statut: ${info.event.extendedProps.statut}\nMotif: ${info.event.extendedProps.motif}`
            )
            new bootstrap.Tooltip(info.el)
        },
        businessHours: {
            daysOfWeek: [1, 2, 3, 4, 5],
            startTime: '08:00',
            endTime: '18:00'
        },
        slotMinTime: '07:00',
        slotMaxTime: '20:00',
        allDaySlot: false,
        navLinks: true,
        nowIndicator: true,
        dayMaxEvents: true,
    })
    calendar.render()
})



document.getElementById('filter-medecin').addEventListener('change', function() {
    calendar.refetchEvents()
})

document.getElementById('filter-statut').addEventListener('change', function() {
    calendar.refetchEvents()
})

// Modifiez la fonction de récupération des événements
events: function(fetchInfo, successCallback, failureCallback) {
    const params = new URLSearchParams({
        medecin: document.getElementById('filter-medecin').value,
        statut: document.getElementById('filter-statut').value,
        start: fetchInfo.start.toISOString(),
        end: fetchInfo.end.toISOString()
    })
    
    fetch(`{% url 'rendezvous_json' %}?${params}`)
        .then(response => response.json())
        .then(data => successCallback(data))
        .catch(error => failureCallback(error))
}
</script>
{% endblock %}