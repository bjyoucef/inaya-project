{% extends "layout.html" %}
{% load static %}
{% load custom_filters %}
{% block content %}



<link rel="stylesheet" href="{% static 'css/choices.min.css' %}">


<div class="container-lg">
        <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h2 mb-0 text-primary">
                <i class="bi bi-file-medical me-2"></i>Nouvelle Prestation
            </h1>
        <p class="text-muted">Remplissez les informations ci-dessous pour enregistrer une nouvelle prestation</p>
        </div>
        <a href="{% url 'medical:prestation_list' %}" class="btn btn-soft-secondary">
            <i class="bi bi-arrow-left me-2"></i>Retour
        </a>
    </div>
{% if errors %}
    <div class="alert alert-danger mb-4">
        <h4 class="alert-heading">Erreurs de validation</h4>
        <ul class="mb-0">
            {% for e in errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
</div>
{% endif %}

<form method="post">
  {% csrf_token %}

        <!-- Section Informations de base -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-clipboard-pulse me-2"></i>Informations Générales
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="patientSelect" class="form-label">Patient</label>
                        <select name="patient" id="patientSelect" class="form-select" required>
                            <option value="">Choisir un patient...</option>
        {% for p in patients %}
        <option value="{{ p.id }}">{{ p.nom_complet }}</option>
        {% endfor %}
      </select>
    </div>

                    <div class="col-md-6">
                        <label for="medecinSelect" class="form-label">Médecin</label>
                        <select name="medecin" id="medecinSelect" class="form-select" required>
                            <option value="">Choisir un médecin...</option>
        {% for m in medecins %}
        <option value="{{ m.id }}">{{ m.nom_complet }}</option>
        {% endfor %}
      </select>
    </div>

<div class="col-md-4">
    <label for="dateInput" class="form-label">Date de réalisation</label>
    <input type="date" 
           name="date_prestation" 
           id="dateInput" 
           class="form-control"
           value="{{ now|date:'Y-m-d' }}" 
           required>
</div>

                    <div class="col-md-4">
                            <label for="statutSelect">Statut de la prestation</label>
                        <select name="statut" id="statutSelect" class="form-select" required>
        {% for v,l in statut_choices %}
        <option value="{{ v }}">{{ l }}</option>
        {% endfor %}
      </select>
    </div>

                    <div class="col-12">
                        <label for="observationsTextarea" class="form-label">Observations</label>
                        <textarea name="observations" id="observationsTextarea" class="form-control" rows="2"
                            placeholder="Notes et observations relatives à la prestation..."></textarea>
                    </div>
                </div>
    </div>
  </div>

        <!-- Section Actes Médicaux -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="h4">
                    <i class="bi bi-heart-pulse me-2"></i>Actes Médicaux
                </h2>
            </div>
            <div class="card-body">
                <div id="actes-container" class="mb-4">
                    <!-- En-tête -->
                    <div class="row g-3 mb-2 text-muted small fw-bold border-bottom pb-1">
                        <div class="col-md-4">Acte médical</div>
                        <div class="col-md-3">Convention</div>
                        <div class="col-md-2">Statut Convention</div>
                        <div class="col-md-2">Tarif appliqué</div>
                        <div class="col-md-1"></div>
                    </div>
                    <!-- Ligne modèle (cachée) -->
                        <div class="acte-row row g-3 mb-2 align-items-center">
                            <div class="col-md-4">
        <select name="actes[]" class="form-control acte-select" required>
          <option value="">Sélectionner un acte...</option>
          {% for a in patients %}{% endfor %}

        </select>
      </div>
      <div class="col-md-3">
        <select name="conventions[]" class="form-control convention-select">
          <option value="">Tarif de base</option>
        </select>
      </div>
    <div class="col-md-2 statut-convention" style="display: none;">
        <select name="convention_accordee[]" class="form-select">
            <option value="oui">Accordée</option>
            <option value="non" selected>Non accordée</option>
        </select>
    </div>
                            <div class="col-md-2">
          <div class="input-group">
        <input type="text" name="tarifs[]" class="form-control tarif-input text-end" readonly>
           <span class="input-group-text">DA</span>
        </div>
      </div>
                            <div class="col-md-1">
                            <button type="button" class="btn btn-icon btn-danger remove-acte">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
    </div>
  </div>

                <!-- Bouton Ajout -->
                <button type="button" id="add-acte" class="btn btn-outline-primary w-100">
                    <i class="bi bi-plus-lg me-2"></i>Ajouter un acte médical
                </button>

                <div class="mt-4 p-3 bg-light rounded-3">
                    <h4 class="mb-0 text-end">
                        Total : <span id="total" class="text-primary">0.00</span> DA
                    </h4>
                </div>
            </div>
                </div>

        <!-- Actions -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="reset" class="btn btn-soft-secondary btn-lg">
                <i class="bi bi-x-lg me-2"></i>Annuler
            </button>
            <button type="submit" class="btn btn-success btn-lg px-5">
                <i class="bi bi-check2-circle me-2"></i>Enregistrer
            </button>
        </div>
      </form>
</div>


<!-- Scripts -->
<script src="{% static 'js/choices.min.js' %}"></script>


<script>
        // Initialisation des selects
    new Choices("#medecinSelect", { 
        searchEnabled: true,
        removeItemButton: true,
        placeholder: true
    });
    new Choices("#patientSelect", {
        searchEnabled: true,
        removeItemButton: true,
        placeholder: true
    });




const actesData = {{ actes_json|safe }};

function updateTarif(row) {
  const [acteSel, convSel] = row.querySelectorAll('.acte-select, .convention-select');
  const tarifInput      = row.querySelector('.tarif-input');
  const statutDiv       = row.querySelector('.statut-convention');
  const statutSelect    = statutDiv.querySelector('select');

  // Si une convention est sélectionnée, on affiche et on rend required
  if (convSel.value) {
    statutDiv.style.display = 'block';
    statutSelect.required   = true;
  } else {
    statutDiv.style.display = 'none';
    statutSelect.required   = false;
    statutSelect.value      = 'non';
  }

  // Si aucun acte, on vide le tarif
  if (!acteSel.value) {
    tarifInput.value = '';
    updateTotal();
    return;
  }

  // Récupère le tarif via l’API
  fetch(`/medical/get-tarif/?acte_id=${acteSel.value}&convention_id=${convSel.value}`)
    .then(r => r.json())
    .then(json => {
      tarifInput.value = json.tarif.toFixed(2);
      updateTotal();
    });
}

function updateTotal() {
  let sum = 0;
  document.querySelectorAll('.tarif-input')
    .forEach(i => sum += parseFloat(i.value) || 0);
  document.getElementById('total').textContent = sum.toFixed(2);
}

function initRow(row) {
  const acteSel = row.querySelector('.acte-select');
  const convSel = row.querySelector('.convention-select');

  // Remplissage de la liste des actes
  acteSel.innerHTML = '<option value="">--</option>' +
    actesData.map(a => `<option value="${a.id}">${a.code} – ${a.libelle}</option>`).join('');

  // Lorsqu’on change d’acte, on (re)remplit les conventions et on met à jour le tarif
  acteSel.onchange = () => {
    const a = actesData.find(x => x.id == acteSel.value);
    convSel.innerHTML = '<option value="">Tarif de base</option>';
    if (a) {
      a.conventions.forEach(c => {
        convSel.insertAdjacentHTML('beforeend',
          `<option value="${c.id}">${c.nom}</option>`);
      });
    }
    updateTarif(row);
  };

  // Lorsqu’on change de convention, on update le tarif (et l’affichage du statut)
  convSel.onchange = () => updateTarif(row);

  // Initialisation du statut à “non” et masquage
  const statutDiv = row.querySelector('.statut-convention');
  statutDiv.style.display = 'none';
  statutDiv.querySelector('select').value = 'non';

  // Bouton suppression de la ligne
  row.querySelector('.remove-acte').onclick = () => {
    row.remove();
    updateTotal();
  };
}

// Initialisation des lignes existantes
document.querySelectorAll('.acte-row').forEach(initRow);

// Bouton “Ajouter un acte médical”
document.getElementById('add-acte').onclick = () => {
  const container = document.getElementById('actes-container');
  const prototype = container.querySelector('.acte-row');
  const clone     = prototype.cloneNode(true);

  // Vider tous les champs du clone et réinitialiser le statut
  clone.querySelectorAll('input, select').forEach(el => el.value = '');
  const statutDiv = clone.querySelector('.statut-convention');
  statutDiv.style.display = 'none';
  statutDiv.querySelector('select').required = false;

  container.appendChild(clone);
  initRow(clone);
};

</script>
{% endblock %}
