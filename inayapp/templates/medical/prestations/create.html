{% extends "layout.html" %}
{% load tz %}
{% load static %}
{% load custom_filters %}
{% block content %}



<link rel="stylesheet" href="{% static 'css/choices.min.css' %}">


<div class="container-lg">
    <h1 class="mb-4">Création de prestation médicale</h1>

{% if errors %}
    <div class="alert alert-danger mb-4">
        <h4 class="alert-heading">Erreurs de validation</h4>
        <ul class="mb-0">
            {% for e in errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
</div>
{% endif %}

<form method="post">
  {% csrf_token %}

        <!-- Section Informations de base -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-clipboard-pulse me-2"></i>Informations générales
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="patientSelect" class="form-label">Patient</label>
                        <select name="patient" id="patientSelect" class="form-select" required>
                            <option value="">Choisir un patient...</option>
        {% for p in patients %}
        <option value="{{ p.id }}">{{ p.nom_complet }}</option>
        {% endfor %}
      </select>
    </div>

                    <div class="col-md-6">
                        <label for="medecinSelect" class="form-label">Médecin</label>
                        <select name="medecin" id="medecinSelect" class="form-select" required>
                            <option value="">Choisir un médecin...</option>
        {% for m in medecins %}
        <option value="{{ m.id }}">{{ m.nom_complet }}</option>
        {% endfor %}
      </select>
    </div>

                    <div class="col-md-4">
                        <label for="dateInput" class="form-label">Date de réalisation</label>
                        <input type="datetime-local" name="date_prestation" id="dateInput" class="form-control"
                            value="{{ now|localtime|date:'Y-m-d\\TH:i' }}" required>
  </div>

                    <div class="col-md-4">
                        <label for="statutSelect" class="form-label">Statut</label>
                        <select name="statut" id="statutSelect" class="form-select" required>
        {% for v,l in statut_choices %}
        <option value="{{ v }}">{{ l }}</option>
        {% endfor %}
      </select>
    </div>

                    <div class="col-md-12">
                        <label for="observationsTextarea" class="form-label">Observations</label>
                        <textarea name="observations" id="observationsTextarea" class="form-control" rows="1"
                            placeholder="Notes et observations relatives à la prestation..."></textarea>
                    </div>
                </div>
    </div>
  </div>

        <!-- Section Actes médicaux -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-heart-pulse me-2"></i>Actes médicaux
            </div>
            <div class="card-body">
                <div id="actes-container" class="mb-4">

                    <div class="row g-3 mb-2 fw-bold">
                        <div class="col-md-5">Acte médical</div>
                        <div class="col-md-4">Convention</div>
                        <div class="col-md-2">Tarif</div>
                        <div class="col-md-1"></div>
                    </div>
                    <!-- Ligne modèle (cachée) -->
                        <div class="acte-row row g-3 mb-2 align-items-center">
                            <div class="col-md-5">
        <select name="actes[]" class="form-control acte-select" required>
          <option value="">Sélectionner un acte...</option>
          {% for a in patients %}{# dummy to force loop context #}{% endfor %}
          {% comment %}on remplira via JS depuis actes_json{% endcomment %}
        </select>
      </div>
      <div class="col-md-4">
        <select name="conventions[]" class="form-control convention-select">
          <option value="">Tarif de base</option>
        </select>
      </div>
                            <div class="col-md-2">
          <div class="input-group">
        <input type="text" name="tarifs[]" class="form-control tarif-input text-end" readonly>
           <span class="input-group-text">€</span>
        </div>
      </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-danger remove-acte w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
    </div>
  </div>

                <button type="button" id="add-acte" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter un acte
                </button>

                <div class="mt-4 p-3 bg-light rounded-3">
                    <h4 class="mb-0 text-end">
                        Total : <span id="total" class="text-primary">0.00</span> €
                    </h4>
                </div>
            </div>
                </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="submit" class="btn btn-lg btn-primary">
                <i class="bi bi-save me-2"></i>Enregistrer la prestation
            </button>
        </div>
      </form>
</div>


<!-- Scripts -->
<script src="{% static 'js/choices.min.js' %}"></script>


<script>
        // Initialisation des selects
    new Choices("#medecinSelect", { 
        searchEnabled: true,
        removeItemButton: true,
        placeholder: true
    });
    new Choices("#patientSelect", {
        searchEnabled: true,
        removeItemButton: true,
        placeholder: true
    });




  const actesData = {{ actes_json|safe }};

  function updateTarif(row) {
    const acteId = row.querySelector('.acte-select').value;
    const conventionId = row.querySelector('.convention-select').value;
    const tarifInput = row.querySelector('.tarif-input');
    if (!acteId) {
      tarifInput.value = '';
      updateTotal();
      return;
    }
fetch(`/medical/get-tarif/?acte_id=${acteId}&convention_id=${conventionId}`)
      .then(r => r.json())
      .then(json => {
        tarifInput.value = json.tarif.toFixed(2);
        updateTotal();
      });
  }

  function updateTotal() {
    let sum = 0;
    document.querySelectorAll('.tarif-input')
      .forEach(i => sum += parseFloat(i.value) || 0);
    document.getElementById('total').textContent = sum.toFixed(2);
  }

  function initRow(row) {
    const acteSel = row.querySelector('.acte-select');
    const convSel = row.querySelector('.convention-select');

    // remplir la liste des actes
    acteSel.innerHTML = '<option value="">--</option>'
      + actesData.map(a => `<option value="${a.id}">${a.code} – ${a.libelle}</option>`).join('');

    acteSel.onchange = () => {
      const a = actesData.find(x => x.id == acteSel.value);
      convSel.innerHTML = '<option value="">Tarif de base</option>';
      if (a) {
        a.conventions.forEach(c =>
          convSel.insertAdjacentHTML('beforeend',
            `<option value="${c.id}">${c.nom}</option>`)
        );
      }
      updateTarif(row);
    };
    convSel.onchange = () => updateTarif(row);

    row.querySelector('.remove-acte').onclick = () => {
      row.remove();
      updateTotal();
    };
  }

  document.querySelectorAll('.acte-row').forEach(initRow);
  document.getElementById('add-acte').onclick = () => {
    const container = document.getElementById('actes-container');
    const clone = container.querySelector('.acte-row').cloneNode(true);
    clone.querySelectorAll('input, select').forEach(e => e.value = '');
    container.appendChild(clone);
    initRow(clone);
  };
</script>
{% endblock %}
