{% for emp_data in report %}
<div class="employee-report border-0 shadow-lg mb-4 overflow-hidden">
  <!-- En-tête Employee amélioré -->
  <div class="card-header bg-primary text-white border-0 py-3 position-relative">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="avatar-circle bg-white text-primary fs-3 fw-bold shadow-sm">
          {{ emp_data.personnel.nom_prenom|slice:":1"|upper }}
        </div>
        <div>
          <h2 class="h4 mb-1 fw-bold">{{ emp_data.personnel.nom_prenom }}</h2>
          <div class="d-flex gap-2 flex-wrap">
            <span class="badge bg-white-20 text-white rounded-pill">
              <i class="fas fa-building me-1"></i>
              {{ emp_data.personnel.service.name|default_if_none:"Non affecté" }}
            </span>
            <span class="badge bg-white-20 text-white rounded-pill">
              <i class="fas fa-user-tag me-1"></i>
              {{ emp_data.personnel.poste.label|default_if_none:"Poste non défini" }}
            </span>
          </div>
        </div>
      </div>
      <div class="text-end ms-auto">
        <div class="text-uppercase small opacity-75">Matricule</div>
        <div class="h4 mb-0 font-monospace">#{{ emp_data.personnel.employee.anviz_id|default_if_none:"NC" }}</div>
      </div>
    </div>
  </div>

  <!-- Corps principal - Version compactée pour meilleure lisibilité -->
  <div class="card-body bg-light">

    <!-- Section Statistiques Principales -->
    <!-- Taux de Présence -->
    <div class="presence-header mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Taux de présence</h5>
        <span class="badge fs-6 
            {% if emp_data.totals.taux_presence >= 75 %}
            bg-success
            {% elif emp_data.totals.taux_presence >= 50 %}
            bg-warning
            {% else %}
            bg-danger
            {% endif %}">
          {{ emp_data.totals.taux_presence|floatformat:1 }}%
        </span>
      </div>
      <div class="progress rounded-pill" style="height: 20px;">
        <div class="progress-bar 
            {% if emp_data.totals.taux_presence >= 75 %}
            bg-success
            {% elif emp_data.totals.taux_presence >= 50 %}
            bg-warning
            {% else %}
            bg-danger
            {% endif %}" role="progressbar" style="width: {{ emp_data.totals.taux_presence|floatformat:0 }}%;"
          aria-valuenow="{{ emp_data.totals.taux_presence|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <!-- Heures Normales -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card metric-card h-100">
          <div class="card-header bg-success text-white">
            <i class="fas fa-clock me-2"></i>Heures Travaillées
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="h4 mb-0">{{ emp_data.totals.regular_hours_formatted }}</span>
              <span class="badge bg-success fs-6">
                +{{ emp_data.salaire.salaire_base|floatformat:2 }} DZD
              </span>
            </div>
            <div class="list-group list-group-flush">
              <div class="list-group-item d-flex justify-content-between">
                <span>Indemnité repas</span>
                <span class="text-success">+{{ emp_data.salaire.indemnites.repas|floatformat:2 }} DZD</span>
              </div>
              <div class="list-group-item d-flex justify-content-between">
                <span>Indemnité transport</span>
                <span class="text-success">+{{ emp_data.salaire.indemnites.transport|floatformat:2 }} DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Heures Supplémentaires -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card metric-card h-100">

          <div class="card-header bg-warning text-dark">
            <i class="fas fa-bolt me-2"></i>Heures Supplémentaires
          </div>

          <div class="card-body">
            <div class="list-group list-group-flush">
              <div class="list-group-item">
                <div class="d-flex justify-content-between mb-2">
                  <span>{{ emp_data.totals.overtime_formatted }}</span>
                  <span class="text-success">+{{ emp_data.totals.regular_overtime_amount|floatformat:2 }} DZD</span>
                </div>
                <small class="text-muted">Heures supp. normales</small>
              </div>
              <div class="list-group-item">
                <div class="d-flex justify-content-between mb-2">
                  <span><i class="fas fa-clock-rotate-left me-2"></i>{{ emp_data.totals.early_overtime_formatted
                    }}</span>
                  <span class="text-success">+{{ emp_data.totals.early_overtime_amount|floatformat:2 }} DZD</span>
                </div>
                <small class="text-muted">Suppl. avant horaire</small>
              </div>
              <div class="list-group-item">
                <div class="d-flex justify-content-between mb-2">
                  <span><i class="fas fa-clock-rotate-left fa-flip-horizontal me-2"></i>{{
                    emp_data.totals.late_overtime_formatted }}</span>
                  <span class="text-success">+{{ emp_data.totals.late_overtime_amount|floatformat:2 }} DZD</span>
                </div>
                <small class="text-muted">Suppl. après horaire</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Jours Fériés -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card metric-card h-100">
          <div class="card-header bg-danger text-white">
            <i class="fas fa-flag me-2"></i>Jours Fériés
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-500">{{ emp_data.totals.public_holiday_overtime_formatted }}</div>
                  <small class="text-muted">Travaillés</small>
                </div>
                <span class="text-success">+{{ emp_data.totals.public_holiday_overtime_amount|default:0|floatformat:2 }}
                  DZD</span>
              </div>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-500">{{ emp_data.totals.paid_holidays|default:"0" }}</div>
                  <small class="text-muted">Non travaillés</small>
                </div>
                <span class="text-success">+{{ emp_data.totals.paid_holidays_amount|default:0|floatformat:2 }}
                  DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Absences & Retards -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card metric-card h-100">
          <div class="card-header bg-danger text-white">
            <i class="fas fa-exclamation-triangle me-2"></i>Absences & Retards
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              <div class="list-group-item d-flex justify-content-between">
                <span>{{ emp_data.totals.absence }} absences</span>
                <span class="text-danger">-{{ emp_data.totals.absence_amount|floatformat:2 }} DZD</span>
              </div>
              <div class="list-group-item d-flex justify-content-between">
                <span><i class="fas fa-clock me-2"></i>{{ emp_data.totals.late }} min</span>
                <span class="text-danger">-{{ emp_data.totals.late_amount|floatformat:2 }} DZD</span>
              </div>
              <div class="list-group-item d-flex justify-content-between">
                <span><i class="fas fa-running me-2"></i>{{ emp_data.totals.early_leave }} min</span>
                <span class="text-danger">-{{ emp_data.totals.early_leave_amount|floatformat:2 }} DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Déductions -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card metric-card h-100">
          <div class="card-header bg-info text-white">
            <i class="fas fa-file-invoice-dollar me-2"></i>Déductions
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              <div class="list-group-item d-flex justify-content-between">
                <span>IRG</span>
                <span class="text-danger">-{{ emp_data.salaire.deductions.irg|floatformat:2 }} DZD</span>
              </div>
              <div class="list-group-item d-flex justify-content-between">
                <span>CNAS</span>
                <span class="text-danger">-{{ emp_data.salaire.deductions.cnas|floatformat:2 }} DZD</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Total Net -->
    <div class="alert alert-success border-0 shadow-sm mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <i class="fas fa-wallet fa-2x me-3"></i>
          <h4 class="mb-0">Salaire Net à Payer</h4>
        </div>
        <span class="display-5 fw-bold">{{ emp_data.salaire.salaire_net|floatformat:2 }} DZD</span>
      </div>
    </div>

    <!-- Détails Journaliers amélioré -->
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-header bg-secondary text-white py-2">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Détails Journaliers</h5>
          <span class="badge bg-white-20">{{ emp_data.days|length }} jours</span>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="bg-light">
              <tr>
                <th class="ps-4">Date</th>
                <th>Plages horaires</th>
                <th class="text-end">Total</th>
                <th class="text-end">Heures supp.</th>
                <th class="text-end">Retard</th>
                <th class="text-end">Départ</th>
                <th class="pe-4">Statut</th>
              </tr>
            </thead>
            <tbody>
              {% for day in emp_data.days %}
              <tr
                class="{% if day.is_holiday %}table-success{% elif day.is_weekend %}table-info{% elif not day.entries %}table-danger{% endif %}">
                <td class="ps-4">
                  <div class="fw-semibold">{{ day.date|date:"d/m/Y" }}</div>
                  <div class="text-muted small">{{ day.date|date:"l"|capfirst }}</div>
                </td>

                <td>
                  {% for pair in day.pairs %}
                  <div class="time-range-badge">
                    <span class="start-time">{{ pair.0|time:"H:i" }}</span>
                    <span class="separator">→</span>
                    <span class="end-time">{% if pair.1 %}{{ pair.1|time:"H:i" }}{% else %}--:--{% endif %}</span>
                  </div>
                  {% empty %}
                  <span class="text-muted">-</span>
                  {% endfor %}
                </td>

                <td class="text-end fw-semibold">{{ day.total|default:"-" }}</td>

                <td class="text-end">
                  <div class="overtime-details">
                    {% if day.overtime != '-' %}
                    <div class="text-success">{{ day.overtime }}</div>
                    {% endif %}
                    {% if day.early_overtime != '-' %}
                    <div class="text-muted small">⏪ {{ day.early_overtime }}</div>
                    {% endif %}
                    {% if day.late_overtime != '-' %}
                    <div class="text-muted small">⏩ {{ day.late_overtime }}</div>
                    {% endif %}
                  </div>
                </td>

                <td class="text-end">
                  {% if day.late_minutes %}
                  <span class="text-danger">{{ day.late_minutes }}</span>
                  {% else %}-{% endif %}
                </td>

                <td class="text-end">
                  {% if day.early_leave_minutes %}
                  <span class="text-warning">{{ day.early_leave_minutes }}</span>
                  {% else %}-{% endif %}
                </td>

                <td class="pe-4">
                  {% if day.is_holiday %}
                  <span class="badge bg-success bg-opacity-10 text-success d-flex align-items-center gap-1">
                    <i class="fas fa-flag"></i>
                    Férié
                  </span>
                  {% elif day.is_weekend %}
                  <span class="badge bg-primary bg-opacity-10 text-primary d-flex align-items-center gap-1">
                    <i class="fas fa-umbrella-beach"></i>
                    Week-end
                  </span>
                  {% elif not day.entries %}
                  <span class="badge bg-danger bg-opacity-10 text-danger d-flex align-items-center gap-1">
                    <i class="fas fa-bed"></i>
                    Absence
                  </span>
                  {% elif day.late_minutes %}
                  <span class="badge bg-warning bg-opacity-10 text-warning d-flex align-items-center gap-1">
                    <i class="fas fa-clock"></i>
                    Retard
                  </span>
                  {% else %}
                  <span class="badge bg-success bg-opacity-10 text-success d-flex align-items-center gap-1">
                    <i class="fas fa-check-circle"></i>
                    Conforme
                  </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}