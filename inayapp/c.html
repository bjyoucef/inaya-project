

<script>
    // Mise à jour du JavaScript existant pour inclure la gestion des paiements

    // Ajouter cette fonction après les fonctions existantes
    function calculerStatutPaiement() {
        const montantPaye = toNumber(document.getElementById('montantPayeCaisse')?.value, 0);
        const montantFacture = calculerMontantTotalFacture(); // Utilise la fonction existante

        const difference = montantPaye - montantFacture;

        // Mise à jour des affichages
        const calculsPaiement = document.getElementById('calculsPaiement');
        const alertePaiement = document.getElementById('alertePaiement');

        if (montantPaye > 0 || montantFacture > 0) {
            calculsPaiement.style.display = 'block';

            // Mise à jour des montants
            document.getElementById('montantFacturePaiement').textContent = formatDA(montantFacture);
            document.getElementById('montantPayePaiement').textContent = formatDA(montantPaye);
            document.getElementById('montantDifference').textContent = formatDA(Math.abs(difference));

            // Mise à jour de la carte différence
            const cardDifference = document.getElementById('cardDifference');
            const titreDifference = document.getElementById('titreDifference');
            const montantDifferenceEl = document.getElementById('montantDifference');

            // Résumé financier
            document.getElementById('montantPayeResume').textContent = montantPaye.toFixed(2);
            document.getElementById('montantFactureResume').textContent = montantFacture.toFixed(2);

            const statutFinancier = document.getElementById('statutFinancier');
            const libelleStatut = document.getElementById('libelle-statut');
            const montantAction = document.getElementById('montant-action');
            const actionText = document.getElementById('action-text');
            const montantActionValue = document.getElementById('montant-action-value');

            if (montantPaye === 0) {
                // Aucun paiement
                cardDifference.className = 'card border-secondary';
                titreDifference.className = 'card-title text-secondary';
                titreDifference.innerHTML = '<i class="bi bi-dash-circle me-1"></i>Aucun paiement';
                montantDifferenceEl.className = 'text-secondary';

                alertePaiement.innerHTML = `
                <div class="alert alert-secondary">
                    <i class="bi bi-info-circle me-2"></i>
                    Aucun paiement enregistré
                </div>
            `;
                alertePaiement.style.display = 'block';

                libelleStatut.textContent = 'Aucun paiement';
                libelleStatut.className = 'fs-4 fw-bold text-secondary';
                montantAction.style.display = 'none';

            } else if (difference > 0) {
                // Surplus - la clinique doit verser au médecin
                cardDifference.className = 'card border-success';
                titreDifference.className = 'card-title text-success';
                titreDifference.innerHTML = '<i class="bi bi-arrow-up-circle me-1"></i>Surplus';
                montantDifferenceEl.className = 'text-success';

                alertePaiement.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Surplus de ${formatDA(difference)}</strong><br>
                    La clinique doit verser ${formatDA(difference)} au médecin.
                </div>
            `;
                alertePaiement.style.display = 'block';

                libelleStatut.textContent = 'Surplus à verser';
                libelleStatut.className = 'fs-4 fw-bold text-success';
                montantAction.style.display = 'block';
                actionText.textContent = 'À verser au médecin :';
                montantActionValue.textContent = formatDA(difference);
                montantActionValue.className = 'fs-5 fw-bold text-success';

            } else if (difference < 0) {
                // Complément - le médecin doit payer à la clinique
                cardDifference.className = 'card border-warning';
                titreDifference.className = 'card-title text-warning';
                titreDifference.innerHTML = '<i class="bi bi-arrow-down-circle me-1"></i>Complément';
                montantDifferenceEl.className = 'text-warning';

                alertePaiement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Complément de ${formatDA(Math.abs(difference))} requis</strong><br>
                    Le médecin doit payer ${formatDA(Math.abs(difference))} à la clinique.
                </div>
            `;
                alertePaiement.style.display = 'block';

                libelleStatut.textContent = 'Complément requis';
                libelleStatut.className = 'fs-4 fw-bold text-warning';
                montantAction.style.display = 'block';
                actionText.textContent = 'Dû par le médecin :';
                montantActionValue.textContent = formatDA(Math.abs(difference));
                montantActionValue.className = 'fs-5 fw-bold text-warning';

            } else {
                // Équilibré
                cardDifference.className = 'card border-primary';
                titreDifference.className = 'card-title text-primary';
                titreDifference.innerHTML = '<i class="bi bi-check-circle me-1"></i>Équilibré';
                montantDifferenceEl.className = 'text-primary';

                alertePaiement.innerHTML = `
                <div class="alert alert-primary">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Paiement équilibré</strong><br>
                    Le montant payé correspond exactement au montant facturé.
                </div>
            `;
                alertePaiement.style.display = 'block';

                libelleStatut.textContent = 'Équilibré';
                libelleStatut.className = 'fs-4 fw-bold text-primary';
                montantAction.style.display = 'none';
            }
        } else {
            calculsPaiement.style.display = 'none';
            alertePaiement.style.display = 'none';
        }
    }

    function calculerMontantTotalFacture() {
        // Utilise le calcul existant
        const prixBloc = calculerPrixBloc();
        const recapActesEl = document.getElementById('recapActes');
        const recapSupplementsEl = document.getElementById('recapSupplements');
        const recapEconomiesEl = document.getElementById('recapEconomies');
        const impactProduitsActesEl = document.getElementById('impactProduitsActes');
        const recapProdSuppEl = document.getElementById('recapProdSupp');

        const totalActes = toNumber(recapActesEl?.textContent, 0);
        const supplements = toNumber(recapSupplementsEl?.textContent, 0);
        const economies = toNumber(recapEconomiesEl?.textContent, 0);
        const impactProduitsActes = toNumber((impactProduitsActesEl?.textContent || '').replace(' DA', ''), 0);
        const totalProdSupp = toNumber(recapProdSuppEl?.textContent, 0);

        return prixBloc + totalActes + supplements + impactProduitsActes + totalProdSupp - economies;
    }

    // Modifier la fonction calculerTotalGeneral existante
    function calculerTotalGeneral() {
        const montantTotal = calculerMontantTotalFacture();

        // Mise à jour des affichages existants
        const totalGeneralEl = document.getElementById('totalGeneral');
        if (totalGeneralEl) totalGeneralEl.textContent = montantTotal.toFixed(2);

        // Nouveaux affichages pour la section finale
        const elements = [
            'prixBlocFinal', 'recapActesFinal', 'recapEconomiesFinal',
            'recapSupplementsFinal', 'recapProdSuppFinal', 'totalGeneralFinal'
        ];

        elements.forEach(id => {
            const sourceId = id.replace('Final', '');
            const sourceEl = document.getElementById(sourceId);
            const targetEl = document.getElementById(id);
            if (sourceEl && targetEl) {
                targetEl.textContent = sourceEl.textContent;
            }
        });

        // Recalculer le statut de paiement
        calculerStatutPaiement();
    }

    // Ajouter l'événement sur le champ montant payé
    document.addEventListener('DOMContentLoaded', function () {
        // ... code existant ...

        // Nouveau : écouter les changements sur le montant payé
        const montantPayeInput = document.getElementById('montantPayeCaisse');
        if (montantPayeInput) {
            montantPayeInput.addEventListener('input', function () {
                calculerStatutPaiement();
                updateProgress();
            });
        }
    });
</script>