{% extends "layout.html" %}
{% load humanize %}

{% block content %}
<style>
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    height: 100%;
  }

  .detail-table {
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
  }

  .toggle-details[aria-expanded="true"] i {
    transform: rotate(180deg);
  }
</style>

<div class="container-fluid py-4">
  <!-- En-tête -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">Tableau de bord - {{ medecin }}</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
        <i class="bi bi-download me-2"></i>Exporter
      </button>
    </div>
  </div>

  <!-- Filtres -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="m-0 fw-bold">Filtres</h6>
      <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
        <i class="bi bi-sliders"></i>
      </button>
    </div>
    <div class="collapse show" id="filterCollapse">
      <div class="card-body pt-0">
        <form method="get" class="row g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small text-muted mb-1">Date début</label>
            <input type="date" name="date_debut" class="form-control" value="{{ date_debut }}">
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label small text-muted mb-1">Date fin</label>
            <input type="date" name="date_fin" class="form-control" value="{{ date_fin }}">
          </div>
          <div class="col-12 col-md-6 col-lg-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-funnel me-2"></i>Appliquer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Cartes de statistiques -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <div class="d-flex align-items-center">
          <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3">
            <i class="bi bi-cash-coin text-primary fs-4"></i>
          </div>
          <div>
            <div class="text-muted small">Total Honoraires</div>
            <div class="h4 mb-0 fw-bold">{{ stats.total_honoraires|floatformat:2|intcomma }} DA</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <div class="d-flex align-items-center">
          <div class="bg-success bg-opacity-10 p-2 rounded-circle me-3">
            <i class="bi bi-people text-success fs-4"></i>
          </div>
          <div>
            <div class="text-muted small">Patients</div>
            <div class="h4 mb-0 fw-bold">{{ stats.total_patients|intcomma }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3">
      <div class="stat-card">
        <div class="d-flex align-items-center">
          <div class="bg-info bg-opacity-10 p-2 rounded-circle me-3">
            <i class="bi bi-clipboard-pulse text-info fs-4"></i>
          </div>
          <div>
            <div class="text-muted small">Actes médicaux</div>
            <div class="h4 mb-0 fw-bold">{{ stats.total_actes|intcomma }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphiques -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
      <div class="chart-card p-3">
        <h6 class="fw-bold mb-3">Répartition par convention</h6>
        <canvas id="conventionChart"></canvas>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="chart-card p-3">
        <h6 class="fw-bold mb-3">Top 10 des actes</h6>
        <canvas id="actesChart"></canvas>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="chart-card p-3">
        <h6 class="fw-bold mb-3">Évolution des honoraires</h6>
        <canvas id="evolutionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Tableau patients -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="m-0 fw-bold">Détail par patient</h6>
      <div class="col-md-3">
        <input type="text" class="form-control form-control-sm" placeholder="Rechercher..." id="searchInput">
      </div>
    </div>

    <div class="table-responsive rounded-3">
      <table class="table data-table mb-0">
        <thead>
          <tr>
            <th>Patient</th>
            <th class="text-end">Actes</th>
            <th class="text-end">Honoraires</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in patients %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="me-2">
                  <i class="bi bi-person-circle text-muted"></i>
                </div>
                <div>
                  {{ p.prestation__patient__last_name }} {{ p.prestation__patient__first_name }}
                </div>
              </div>
            </td>
            <td class="text-end">{{ p.nombre_actes }}</td>
            <td class="text-end">{{ p.total_honoraires|floatformat:2|intcomma }} DA</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse"
                data-bs-target="#patient{{ forloop.counter }}">
                <i class="bi bi-chevron-down"></i>
              </button>
            </td>
          </tr>
          <tr class="collapse">
            <td colspan="4" class="p-0">
              <div class="detail-table m-3">
                <table class="table table-sm mb-0">
                  <thead class="small">
                    <tr>
                      <th>Date</th>
                      <th>Acte</th>
                      <th>Convention</th>
                      <th class="text-end">Montant</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for acte in actes_details %}
                    {% if acte.prestation__patient_id == p.prestation__patient_id %}
                    <tr>
                      <td>{{ acte.prestation__date_prestation|date:"d/m/Y" }}</td>
                      <td>{{ acte.acte__libelle }}</td>
                      <td>{{ acte.convention__nom|default:"-" }}</td>
                      <td class="text-end">{{ acte.honoraire_medecin|floatformat:2 }} DA</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Recherche
    document.getElementById('searchInput').addEventListener('input', function (e) {
      const value = e.target.value.toLowerCase();
      document.querySelectorAll('.data-table tbody tr').forEach(row => {
        if (row.classList.contains('collapse')) return;
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(value) ? '' : 'none';
      });
    });

    // Animation des boutons de détail
    document.querySelectorAll('.toggle-details').forEach(btn => {
      btn.addEventListener('click', function () {
        this.querySelector('i').classList.toggle('bi-chevron-up');
      });
    });
  });
</script>

<!-- Scripts Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // [Conserver les scripts Chart.js existants]
</script>
{% endblock %}