function initRow(row) {
const acteSel = row.querySelector('.acte-select');
const convSel = row.querySelector('.convention-select');

// Configuration commune pour Choices
const choicesConfig = {
searchEnabled: true,
removeItemButton: false,
placeholderValue: null,
shouldSort: false,
itemSelectText: '',
classNames: {
containerInner: 'choices__inner',
input: 'choices__input',
}
};

// Initialisation du select des actes
const acteChoices = new Choices(acteSel, {
...choicesConfig,
choices: actesData.map(a => ({
value: a.id,
label: `${a.code} - ${a.libelle}`
}))
});

// Initialisation du select des conventions
const conventionChoices = new Choices(convSel, choicesConfig);

// Stockage des instances Choices
acteSel.choicesInstance = acteChoices;
convSel.choicesInstance = conventionChoices;

// Gestion du changement d'acte
acteSel.addEventListener('change', () => {
const a = actesData.find(x => x.id === acteSel.value);
const newConventions = a?.conventions?.map(c => ({
value: c.id,
label: c.nom
})) || [];

// Mise Ã  jour des conventions
conventionChoices.setChoices([
{value: '', label: 'Tarif de base'},
...newConventions
]);

updateTarif(row);
});

// Gestion du changement de convention
convSel.addEventListener('change', () => updateTarif(row));

// Gestion de la suppression
row.querySelector('.remove-acte').addEventListener('click', () => {
// Destruction des instances Choices
acteChoices.destroy();
conventionChoices.destroy();
row.remove();
updateTotal();
});
}

// Modification de la fonction de clonage pour conserver le template original
document.getElementById('add-acte').onclick = () => {
const template = document.querySelector('.acte-row:not([data-initialized])');
const clone = template.cloneNode(true);
clone.removeAttribute('data-initialized');
document.getElementById('actes-container').appendChild(clone);
initRow(clone);
};

// Initialisation des lignes existantes
document.querySelectorAll('.acte-row').forEach(row => {
row.setAttribute('data-initialized', true);
initRow(row);
});
</script>
{% endblock %}