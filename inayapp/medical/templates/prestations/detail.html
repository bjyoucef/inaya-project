{% extends "layout.html" %}
{% load permissions_tags %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-procedures me-2"></i>Prestation #{{ prestation.id }}
        </h1>
<div class="btn-group">
    {% has_permission user 'medical.generate_bon_paiement' as can_generate_bon %}
    {% if can_generate_bon and has_actes_especes %}
    <a href="{% url 'medical:export_bon_paiement_especes' prestation.id %}" class="btn btn-success me-2"
        title="Exporter le bon de paiement espèces">
        <i class="fas fa-file-invoice-dollar me-2"></i>Bon de paiement espèces
    </a>
    {% endif %}

    {% has_permission user 'medical.change_prestationkt' as can_edit %}
    {% if can_edit %}
    <a href="{% url 'medical:prestation_update' prestation.id %}" class="btn btn-warning me-2">
        <i class="fas fa-edit me-2"></i>Modifier
    </a>
    {% endif %}

    {% has_permission user 'medical.delete_prestationkt' as can_delete %}
    {% if can_delete and prestation.statut != 'PAYE' %}
    <a href="{% url 'medical:prestation_delete' prestation.id %}" class="btn btn-danger me-2"
        onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette prestation ?')">
        <i class="fas fa-trash me-2"></i>Supprimer
    </a>
    {% endif %}

    <a href="{% url 'medical:prestation_list' %}" class="btn btn-light">
        <i class="fas fa-arrow-left me-2"></i>Retour aux prestations
    </a>
</div>
    </div>

    <div class="row">
        <!-- Colonne Informations Générales -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 bg-primary">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-info-circle me-2"></i>Détails de la prestation
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="small text-muted mb-1">Patient</label>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user me-2 text-primary"></i>
                                {{ prestation.patient.nom_complet }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted mb-1">Médecin</label>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-md me-2 text-success"></i>
                                {{ prestation.medecin.nom_complet }}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="small text-muted mb-1">Date</label>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar me-2 text-info"></i>
                                {{ prestation.date_prestation|date:"d/m/Y" }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted mb-1">Statut</label>
                            <div>
                                {% if prestation.statut == 'PLANIFIE' %}
                                    <span class="badge bg-warning">{{ prestation.get_statut_display }}</span>
                                {% elif prestation.statut == 'REALISE' %}
                                    <span class="badge bg-info">{{ prestation.get_statut_display }}</span>
                                {% elif prestation.statut == 'PAYE' %}
                                    <span class="badge bg-success">{{ prestation.get_statut_display }}</span>
                                {% elif prestation.statut == 'ANNULE' %}
                                    <span class="badge bg-danger">{{ prestation.get_statut_display }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ prestation.get_statut_display }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if prestation.observations %}
                    <div class="alert alert-light border-left-primary mb-3">
                        <label class="small text-muted mb-1"><strong>Observations</strong></label>
                        <p class="mb-0">{{ prestation.observations }}</p>
                    </div>
                    {% endif %}

                    <!-- Détails des paiements avec indicateur espèces -->
<div class="mt-3">
                        <h6 class="text-muted mb-3">Répartition financière</h6>

                        <!-- NOUVEAU: Alertes pour les types de paiement -->
                        {% with has_especes=False has_convention=False %}
                            {% for acte in prestation.actes_details.all %}
                                {% if not acte.convention or acte.convention.nom|lower == "urgence" %}
                                    {% with has_especes=True %}{% endwith %}
                                {% else %}
                                    {% with has_convention=True %}{% endwith %}
                                {% endif %}
                            {% endfor %}

                            {% if has_especes %}
                                <div class="alert alert-success py-2 mb-2">
                                    <i class="fas fa-money-bill-wave me-2"></i>
                                    <small><strong>Paiement espèces disponible</strong> - Vous pouvez générer un bon de paiement</small>
                                </div>
                            {% endif %}

                            {% if has_convention %}
                                <div class="alert alert-info py-2 mb-3">
                                    <i class="fas fa-handshake me-2"></i>
                                    <small><strong>Facturation convention</strong> - Certains actes seront facturés séparément</small>
                                </div>
                            {% endif %}
                        {% endwith %}

                        <div class="d-flex justify-content-between small mb-2">
                            <span><i class="fas fa-handshake me-1 text-info"></i>Actes conventionnés:</span>
                            <span class="fw-bold">{{ total_actes_convention|floatformat:2 }} DA</span>
                        </div>
                        <div class="d-flex justify-content-between small mb-2">
                            <span><i class="fas fa-money-bill me-1 text-success"></i>Actes en espèces:</span>
                            <span class="fw-bold">{{ total_actes_espece|floatformat:2 }} DA</span>
                        </div>
                        <div class="d-flex justify-content-between small mb-2">
                            <span><i class="fas fa-pills me-1 text-warning"></i>Consommations supplémentaires:</span>
                            <span class="fw-bold">{{ total_consommations|floatformat:2 }} DA</span>
                        </div>
                        <div class="d-flex justify-content-between small mb-3">
                            <span><i class="fas fa-plus me-1 text-secondary"></i>Frais supplémentaires:</span>
                            <span class="fw-bold">{{ prix_supplementaire|floatformat:2 }} DA</span>
                        </div>

                        <!-- Totaux par type -->
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="card bg-success text-white">
                                    <div class="card-body py-2 text-center">
                                        <div class="small">Total espèces</div>
                                        <div class="h5 mb-0">{{ total_espece|floatformat:2 }} DA</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-info text-white">
                                    <div class="card-body py-2 text-center">
                                        <div class="small">Total convention</div>
                                        <div class="h5 mb-0">{{ total_convention|floatformat:2 }} DA</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Total général -->
                        <div class="card bg-primary text-white mt-2">
                            <div class="card-body py-2 text-center">
                                <div class="small">TOTAL GÉNÉRAL</div>
                                <div class="h4 mb-0">{{ total_general|floatformat:2 }} DA</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NOUVEAU : Résumé des conventions (si applicable) -->
            {% if stats_conventions.total_avec_convention > 0 %}
            <div class="card shadow mt-4">
                <div class="card-header py-3 bg-info">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-chart-pie me-2"></i>Résumé des Conventions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="text-primary">
                                <div class="h4 mb-0">{{ stats_conventions.total_avec_convention }}</div>
                                <div class="small text-muted">Avec convention</div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="text-success">
                                <div class="h4 mb-0">{{ stats_conventions.conventions_accordees }}</div>
                                <div class="small text-muted">Accordées</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-warning">
                                <div class="h4 mb-0">{{ stats_conventions.dossiers_complets }}</div>
                                <div class="small text-muted">Dossiers complets</div>
    </div>
    </div>
                        <div class="col-6">
                            <div class="text-info">
                                <div class="h4 mb-0">{{ stats_conventions.facturables_convention }}</div>
                                <div class="small text-muted">Facturables</div>
    </div>
    </div>
        </div>

                    <!-- Barre de progression -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Progression</span>
                            <span class="small fw-bold">
                                {{ stats_conventions.facturables_convention }}/{{ stats_conventions.total_avec_convention }}
                            </span>
    </div>
                        <div class="progress" style="height: 6px;">
                            {% if stats_conventions.total_avec_convention > 0 %}
                                {% widthratio stats_conventions.facturables_convention stats_conventions.total_avec_convention 100 as pourcentage %}
                                <div class="progress-bar bg-success" role="progressbar"
                                     style="width: {{ pourcentage }}%"></div>
                            {% endif %}
</div>
</div>
                    
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Colonne Actes Réalisés -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3 bg-primary">
                    <h6 class="m-0 font-weight-bold text-white">
                        <i class="fas fa-clipboard-list me-2"></i>Actes réalisés et conventions
                    </h6>
                </div>
                <div class="card-body">
                    {% for acte_detail in actes %}
                    <div class="card mb-3 border-start border-3 {% if acte_detail.peut_facturer_convention %}border-success{% elif acte_detail.convention %}border-warning{% else %}border-secondary{% endif %}">
                        <div class="card-body">
                            <div class="row">
                                <!-- Informations de l'acte -->
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="card-title text-primary mb-1">
                                                {{ acte_detail.acte.code }} - {{ acte_detail.acte.libelle }}

                                                <!-- NOUVEAU: Indicateur de paiement espèces -->
                                                {% if not acte_detail.convention or acte_detail.convention.nom|lower == "urgence" %}
                                                    <span class="badge bg-success ms-2">
                                                        <i class="fas fa-money-bill-wave me-1"></i>Espèces
                                                    </span>
                                                {% endif %}
                                            </h6>
                                            <p class="text-muted small mb-2">{{ acte_detail.acte.service.nom }}</p>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold fs-5 text-primary">
                                                {{ acte_detail.tarif_conventionne|floatformat:2 }} DA
                                            </div>
                                            {% if acte_detail.honoraire_medecin %}
                                            <div class="small text-success">
                                                Honoraire: {{ acte_detail.honoraire_medecin|floatformat:2 }} DA
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- NOUVEAU : Statut de convention détaillé -->
                                    <div class="convention-status mb-3">
                                        {% if acte_detail.convention %}
                                            <div class="d-flex flex-wrap gap-1 mb-2">
                                                {% if acte_detail.convention.nom|lower == "urgence" %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ acte_detail.convention.nom }}
                                                    </span>
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-money-bill me-1"></i>Paiement espèces
                                                    </span>
                                                {% else %}
                                                <span class="badge bg-info">{{ acte_detail.convention.nom }}</span>

                                                {% if acte_detail.convention_accordee is True %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-circle me-1"></i>Accordée
                                        </span>
                                                {% elif acte_detail.convention_accordee is False %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times-circle me-1"></i>Refusée
                        </span>
                                                {% else %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>En attente
                                                    </span>
                                                {% endif %}

                                                {% if acte_detail.dossier_convention_complet %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-file-check me-1"></i>Dossier complet
                        </span>
                        {% else %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-file-times me-1"></i>Dossier incomplet
                                                    </span>
                                                {% endif %}

                                                {% if acte_detail.peut_facturer_convention %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-credit-card me-1"></i>Facturable en convention
                        </span>
                        {% endif %}
                                                {% endif %}
                                            </div>

                                            <!-- Alerte selon le statut -->
                                            {% if acte_detail.convention.nom|lower == "urgence" %}
                                                <div class="alert alert-warning py-2 mb-2">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Acte d'urgence</strong> - Paiement en espèces uniquement
                                                </div>
                                            {% elif not acte_detail.convention_accordee and acte_detail.convention_accordee is not None %}
                                                <div class="alert alert-danger py-2 mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    <strong>Convention refusée</strong> - Cet acte sera facturé en espèces
                                                </div>
                                            {% elif not acte_detail.dossier_convention_complet and acte_detail.convention_accordee is True %}
                                                <div class="alert alert-warning py-2 mb-2">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Dossier incomplet</strong> - Finaliser le dossier pour facturer en convention
                                                </div>
                                            {% elif acte_detail.peut_facturer_convention %}
                                                <div class="alert alert-success py-2 mb-2">
                                                    <i class="fas fa-check-circle me-2"></i>
                                                    <strong>Prêt pour facturation</strong> - Peut être facturé en convention
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-money-bill me-1"></i>Sans convention (espèces)
                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Commentaire s'il existe -->
                            {% if acte_detail.commentaire %}
                            <div class="mt-3 pt-3 border-top">
                                <label class="form-label text-muted small"><strong>Commentaire médical</strong></label>
                                <p class="mb-0 small">{{ acte_detail.commentaire }}</p>
                            </div>
                            {% endif %}

                            <!-- Consommations de produits -->
                            {% if acte_detail.consommations.exists %}
                            <div class="mt-3 pt-3 border-top">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-pills me-2"></i>Consommations de produits
        </h6>
        <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
              <tr>
                <th>Produit</th>
                                                <th class="text-center">Qté incluse</th>
                                                <th class="text-center">Qté utilisée</th>
                                                <th class="text-center">Écart</th>
                                                <th class="text-end">Prix unitaire</th>
                                                <th class="text-end">Montant</th>
              </tr>
            </thead>
            <tbody>
                                            {% for conso in acte_detail.consommations.all %}
              <tr>
                                                <td>
                                                    <div class="fw-bold">{{ conso.produit.code_produit }}</div>
                                                    <small class="text-muted">{{ conso.produit.nom }}</small>
                                                </td>
                                                <td class="text-center">{{ conso.quantite_defaut }}</td>
                                                <td class="text-center">{{ conso.quantite_reelle }}</td>
                                                <td class="text-center">
                                                    {% with ecart=conso.quantite_reelle|add:"-"|add:conso.quantite_defaut %}
                                                        {% if ecart|floatformat:0|add:0 > 0 %}
                                                            <span class="text-warning fw-bold">+{{ ecart }}</span>
                                                        {% elif ecart|floatformat:0|add:0 < 0 %}
                                                            <span class="text-info fw-bold">{{ ecart }}</span>
                                                        {% else %}
                                                            <span class="text-muted">0</span>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                                <td class="text-end">{{ conso.prix_unitaire|floatformat:2 }} DA</td>
                                                <td class="text-end fw-bold">
                                                    {% if conso.montant_solde %}
                                                        {{ conso.montant_solde|floatformat:2 }} DA
                                                    {% else %}
                                                        {% widthratio conso.quantite_reelle 1 conso.prix_unitaire as montant_total %}
                                                        {{ montant_total|floatformat:2 }} DA
                                                    {% endif %}
                                                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
  {% endif %}
                        </div>
                    </div>
{% endfor %}
                </div>
            </div>
    </div>
</div>
<!-- Section changement de statut (à ajouter après les détails) -->
{% has_permission user 'medical.change_status_prestationkt' as can_change_status %}
{% if can_change_status %}
<div class="col-lg-12 mt-4">
    <div class="card shadow">
        <div class="card-header py-3 bg-secondary">
            <h6 class="m-0 font-weight-bold text-white">
                <i class="fas fa-exchange-alt me-2"></i>Gestion du Statut
            </h6>
        </div>
        <div class="card-body">
            <p>Statut actuel: <span class="badge bg-info">{{ prestation.get_statut_display }}</span></p>

            {% if prestation.statut == 'PLANIFIE' %}
            {% has_permission user 'medical.realiser_prestationkt' as can_realize %}
            {% if can_realize %}
            <button class="btn btn-success me-2 change-status-btn" data-prestation-id="{{ prestation.id }}"
                data-new-status="REALISE">
                <i class="fas fa-check me-2"></i>Marquer comme Réalisé
            </button>
            {% endif %}

            {% has_permission user 'medical.annuler_prestationkt' as can_cancel %}
            {% if can_cancel %}
            <button class="btn btn-secondary change-status-btn" data-prestation-id="{{ prestation.id }}"
                data-new-status="ANNULE">
                <i class="fas fa-times me-2"></i>Annuler
            </button>
            {% endif %}

            {% elif prestation.statut == 'REALISE' %}
            {% has_permission user 'medical.payer_prestationkt' as can_pay %}
            {% if can_pay %}
            <button class="btn btn-primary change-status-btn" data-prestation-id="{{ prestation.id }}"
                data-new-status="PAYE">
                <i class="fas fa-credit-card me-2"></i>Marquer comme Payé
            </button>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
</div>

<script>
// Script pour le changement de statut via AJAX
document.addEventListener('DOMContentLoaded', function() {
    const changeStatusButtons = document.querySelectorAll('.change-status-btn');

    changeStatusButtons.forEach(button => {
        button.addEventListener('click', function() {
            const prestationId = this.dataset.prestationId;
            const newStatus = this.dataset.newStatus;
            const statusNames = {
                'REALISE': 'Réalisé',
                'PAYE': 'Payé',
                'ANNULE': 'Annulé'
            };

            if (confirm(`Êtes-vous sûr de vouloir changer le statut vers "${statusNames[newStatus]}" ?`)) {
                // Désactiver le bouton pendant la requête
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Traitement...';

                fetch(`/medical/prestations/${prestationId}/change-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Recharger la page pour voir les changements
                        location.reload();
                    } else {
                        alert('Erreur: ' + data.message);
                        // Réactiver le bouton en cas d'erreur
                        this.disabled = false;
                        this.innerHTML = this.dataset.originalText;
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Une erreur est survenue lors du changement de statut');
                    // Réactiver le bouton en cas d'erreur
                    this.disabled = false;
                    this.innerHTML = this.dataset.originalText;
                });
            }
        });

        // Sauvegarder le texte original pour la restauration en cas d'erreur
        button.dataset.originalText = button.innerHTML;
    });
});
</script>
{% endblock %}