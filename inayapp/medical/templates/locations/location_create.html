{% extends "layout.html" %}
{% load static custom_filters_medical %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="bg-primary bg-gradient text-white rounded-4 p-4 mb-4 shadow">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h2 mb-2"><i class="bi bi-building me-3"></i>Location de Bloc Opératoire</h1>
        <p class="mb-0 opacity-90">Interface simplifiée avec gestion unifiée des produits et actes</p>
      </div>
      <a class="btn btn-light" href="{% url 'medical:location_bloc_list' %}">
        <i class="bi bi-arrow-left me-2"></i>Retour
      </a>
    </div>
  </div>

  <form method="post" id="prestationBlocForm" novalidate>
    {% csrf_token %}
    <input type="hidden" name="action" id="actionInput" value="submit">

    <!-- 1. Informations générales -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <i class="bi bi-info-circle me-2"></i>Informations générales
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Patient <span class="text-danger">*</span></label>
            <select name="patient" id="patientSelect" class="form-select" required>
              <option value="">-- Choisir un patient --</option>
              {% for p in patients %}
                <option value="{{ p.id }}" {% if form_data.patient|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>
                  {{ p.nom_complet }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Médecin responsable <span class="text-danger">*</span></label>
            <select name="medecin" id="medecinSelect" class="form-select" required>
              <option value="">-- Choisir un médecin --</option>
              {% for m in medecins %}
                <option value="{{ m.id }}" {% if form_data.medecin|stringformat:"s" == m.id|stringformat:"s" %}selected{% endif %}>
                  Dr. {{ m.nom_complet }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Date et Heure d'opération <span class="text-danger">*</span></label>
            <input type="text" id="datetimepicker" class="form-control" required>
            <input type="hidden" name="date_operation" id="date_operation" value="{{ form_data.date_operation|default:now|date:'Y-m-d' }}">
            <input type="hidden" name="heure_operation" id="heure_operation" value="{{ form_data.heure_operation|default:'' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Durée réelle (minutes) <span class="text-danger">*</span></label>
            <div class="input-group">
              <input type="number" min="1" class="form-control" name="duree_reelle" id="dureeReelle"
                value="{{ form_data.duree_reelle|default:'' }}" placeholder="Ex: 135" required>
              <span class="input-group-text">min</span>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Nom de l'intervention <span class="text-danger">*</span></label>
            <input type="text" name="nom_acte" id="nomActe" class="form-control"
              value="{{ form_data.nom_acte|default:'' }}" placeholder="Ex: Appendicectomie laparoscopique" required>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Observations</label>
            <textarea name="observations" class="form-control" rows="2" 
              placeholder="Notes additionnelles...">{{ form_data.observations|default:'' }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Sélection du bloc et mode de tarification -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <i class="bi bi-hospital me-2"></i>Configuration du bloc et tarification
      </div>
      <div class="card-body">
        <!-- Mode de tarification -->
        <div class="row mb-4">
          <div class="col-12">
            <h6 class="fw-bold mb-3">Mode de tarification</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card h-100 pricing-card border-2 {% if form_data.type_tarification == 'DUREE' or not form_data.type_tarification %}border-primary{% endif %}"
                     onclick="LocationManager.chooseTarif('DUREE')" style="cursor: pointer;">
                  <input class="d-none" id="tarif_duree" type="radio" name="type_tarification" value="DUREE"
                    {% if form_data.type_tarification == 'DUREE' or not form_data.type_tarification %}checked{% endif %}>
                  <div class="card-body text-center">
                    <i class="bi bi-clock fs-2 text-primary"></i>
                    <h5 class="mt-2">Tarification à la durée</h5>
                    <p class="text-muted">Prix calculé selon la durée réelle</p>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card h-100 pricing-card border-2 {% if form_data.type_tarification == 'FORFAIT' %}border-primary{% endif %}"
                     onclick="LocationManager.chooseTarif('FORFAIT')" style="cursor: pointer;">
                  <input class="d-none" id="tarif_forfait" type="radio" name="type_tarification" value="FORFAIT"
                    {% if form_data.type_tarification == 'FORFAIT' %}checked{% endif %}>
                  <div class="card-body text-center">
                    <i class="bi bi-box fs-2 text-primary"></i>
                    <h5 class="mt-2">Tarification forfaitaire</h5>
                    <p class="text-muted">Prix fixe avec éléments inclus</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sélection du bloc -->
        <div class="row mb-4">
          <div class="col-12">
            <h6 class="fw-bold mb-3">Sélection du bloc opératoire</h6>
            <div class="row g-3">
              {% for bloc in blocs %}
              <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card h-100 pricing-card border-2 {% if form_data.bloc|stringformat:'s' == bloc.id|stringformat:'s' %}border-primary{% endif %}"
                     onclick="LocationManager.selectBloc(this,'bloc_{{ bloc.id }}')" style="cursor: pointer;">
                  <input class="d-none" type="radio" id="bloc_{{ bloc.id }}" name="bloc" value="{{ bloc.id }}"
                    data-bloc-id="{{ bloc.id }}" {% if form_data.bloc|stringformat:'s' == bloc.id|stringformat:'s' %}checked{% endif %}>
                  <div class="card-body text-center">
                    <h6 class="card-title">{{ bloc.nom_bloc }}</h6>
                    <div class="h4 text-primary">{{ bloc.prix_base|floatformat:2 }} DA</div>
                    <small class="text-muted d-block mb-2">90 min incluses</small>
                    <hr>
                    <small class="d-block mb-2">+ {{ bloc.prix_supplement_30min|floatformat:2 }} DA / 30min</small>
                    {% if bloc.description %}
                    <p class="small text-muted">{{ bloc.description }}</p>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Sélection forfait (conditionnel) -->
        <div id="forfait-selection" class="row {% if form_data.type_tarification != 'FORFAIT' %}d-none{% endif %}">
          <div class="col-12">
            <h6 class="fw-bold mb-3">Sélection du forfait</h6>
            <div class="row g-3">
              {% for f in forfaits %}
              <div class="col-xl-3 col-lg-4 col-md-6">
                <div class="card h-100 pricing-card border-2 {% if form_data.forfait|stringformat:'s' == f.id|stringformat:'s' %}border-primary{% endif %}"
                     onclick="LocationManager.selectForfait(this,'forfait_{{ f.id }}')" data-forfait-id="{{ f.id }}" style="cursor: pointer;">
                  <input class="d-none" type="radio" id="forfait_{{ f.id }}" name="forfait" value="{{ f.id }}"
                    {% if form_data.forfait|stringformat:'s' == f.id|stringformat:'s' %}checked{% endif %}>
                  <div class="card-body">
                    <h6 class="card-title">{{ f.nom }}</h6>
                    <p class="small text-muted">{{ f.description }}</p>
                    <div class="h5 text-primary">{{ f.prix|floatformat:2 }} DA</div>
                    <small class="text-muted"><i class="bi bi-clock"></i> {{ f.duree }} min incluses</small>
                    <div class="mt-2">
                    {% if f.produits.exists %}
                      <span class="badge bg-success me-1">
                        <i class="bi bi-box-seam"></i> {{ f.produits.count }} produit(s)
                      </span>
                      {% endif %}
                      {% if f.actes_inclus.exists %}
                      <span class="badge bg-info">
                        <i class="bi bi-clipboard-check"></i> {{ f.actes_inclus.count }} acte(s)
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. ACTES UNIFIÉS -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-info text-white">
        <i class="bi bi-clipboard-check me-2"></i>Gestion des actes
        <div class="float-end">
          <small class="opacity-75">Inclus + Supplémentaires</small>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Actes inclus :</strong> Quantités incluses dans le forfait (seules les surconsommations sont facturées)
          <strong class="ms-3">Actes supplémentaires :</strong> Facturés intégralement
        </div>

        <!-- Conteneur pour les actes inclus (forfait) -->
        <div id="actes-inclus-section" style="display: none;">
          <h6 class="text-info mb-3"><i class="bi bi-gift me-2"></i>Actes inclus dans le forfait</h6>
          <div id="actes-inclus-container"></div>
          <hr class="my-4">
        </div>

        <!-- Actes supplémentaires -->
        <h6 class="text-primary mb-3"><i class="bi bi-plus-circle me-2"></i>Actes supplémentaires</h6>
        <div id="actes-supplementaires-container"></div>
        
        <button type="button" id="add-acte" class="btn btn-outline-primary">
          <i class="bi bi-plus"></i> Ajouter un acte
        </button>

        <!-- Totaux des actes -->
        <div class="row mt-4 p-3 bg-light rounded">
          <div class="col-md-4">
            <div class="text-info fw-bold">
              <i class="bi bi-gift me-1"></i>
              Suppléments actes inclus : <span id="supplementsActesInclus">0.00 DA</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-primary fw-bold">
              <i class="bi bi-clipboard-check me-1"></i>
              Total actes supplémentaires : <span id="totalActesSupp">0.00 DA</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="fs-5 fw-bold text-success">
              <i class="bi bi-calculator me-1"></i>
              Total actes : <span id="totalActesGlobal">0.00 DA</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. PRODUITS UNIFIÉS -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-warning text-dark">
        <i class="bi bi-box-seam me-2"></i>Gestion des produits
        <div class="float-end">
          <small class="opacity-75">Inclus + Supplémentaires</small>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-warning">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Produits inclus :</strong> Ajustez selon la consommation réelle (seules les surconsommations sont facturées)
          <strong class="ms-3">Produits supplémentaires :</strong> Non inclus, facturés intégralement
        </div>

        <!-- Conteneur pour les produits inclus -->
        <div id="produits-inclus-section" style="display: none;">
          <h6 class="text-success mb-3"><i class="bi bi-gift me-2"></i>Produits inclus</h6>
          <div id="produits-inclus-container"></div>
          <hr class="my-4">
        </div>

        <!-- Produits supplémentaires -->
        <h6 class="text-warning mb-3"><i class="bi bi-plus-circle me-2"></i>Produits supplémentaires</h6>
        <div id="produits-supplementaires-container"></div>

        <button type="button" id="add-produit-supp" class="btn btn-outline-warning">
          <i class="bi bi-plus"></i> Ajouter un produit supplémentaire
        </button>

        <!-- Totaux des produits -->
        <div class="row mt-4 p-3 bg-light rounded">
          <div class="col-md-4">
            <div class="text-success fw-bold">
              <i class="bi bi-gift me-1"></i>
              Suppléments produits inclus : <span id="supplementsProduitsInclus">0.00 DA</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-warning fw-bold">
              <i class="bi bi-box-seam me-1"></i>
              Total produits supplémentaires : <span id="totalProduitsSupp">0.00 DA</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="fs-5 fw-bold text-success">
              <i class="bi bi-calculator me-1"></i>
              Total produits : <span id="totalProduitsGlobal">0.00 DA</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. Gestion des paiements -->
    <div class="card shadow-sm mb-4 border-info">
      <div class="card-header bg-info text-white">
        <i class="bi bi-cash-stack me-2"></i>Gestion des paiements
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold" for="montantPayeCaisse">
              <i class="bi bi-currency-exchange me-1"></i>Montant payé à la caisse
            </label>
            <div class="input-group">
              <input type="number" name="montant_paye_caisse" id="montantPayeCaisse" class="form-control"
                     value="{{ form_data.montant_paye_caisse|default:'0' }}" min="0" step="0.01" placeholder="0.00">
              <span class="input-group-text">DA</span>
            </div>
          </div>
          
          <div class="col-md-6">
            <label class="form-label fw-semibold">Notes sur le paiement</label>
            <textarea name="notes_paiement" class="form-control" rows="3"
                      placeholder="Notes sur les modalités de paiement...">{{ form_data.notes_paiement|default:'' }}</textarea>
          </div>
        </div>

        <!-- Analyse du paiement -->
        <div class="mt-4" id="analysePaiement" style="display: none;">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card border-primary">
                <div class="card-body text-center">
                  <h6 class="text-primary"><i class="bi bi-receipt"></i> À facturer</h6>
                  <h5 class="text-primary" id="montantFacture">0.00 DA</h5>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-info">
                <div class="card-body text-center">
                  <h6 class="text-info"><i class="bi bi-cash"></i> Payé</h6>
                  <h5 class="text-info" id="montantPaye">0.00 DA</h5>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card" id="cardStatut">
                <div class="card-body text-center">
                  <h6 id="titreStatut"><i class="bi bi-calculator"></i> Statut</h6>
                  <h5 id="montantStatut">0.00 DA</h5>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 6. Récapitulatif final -->
    <div class="card shadow-sm mb-4 border-success">
      <div class="card-header bg-success text-white">
        <i class="bi bi-calculator me-2"></i>Récapitulatif final
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-lg-8">
            <table class="table table-borderless">
              <tr>
                <td><i class="bi bi-building me-2"></i>Prix du bloc/forfait :</td>
                <td class="text-end fw-bold"><span id="prixBloc">0.00</span> DA</td>
              </tr>
              <tr>
                <td><i class="bi bi-clipboard-check me-2"></i>Total actes :</td>
                <td class="text-end fw-bold"><span id="recapActes">0.00</span> DA</td>
              </tr>
              <tr>
                <td><i class="bi bi-box-seam me-2"></i>Total produits :</td>
                <td class="text-end fw-bold"><span id="recapProduits">0.00</span> DA</td>
              </tr>
              <tr class="table-success fw-bold fs-5">
                <td><i class="bi bi-currency-exchange me-2"></i>TOTAL GÉNÉRAL :</td>
                <td class="text-end"><span id="totalGeneral">0.00</span> DA</td>
              </tr>
            </table>
          </div>
          
          <div class="col-lg-4">
            <div class="p-4 bg-light rounded text-center">
              <h6 class="mb-3">Situation financière</h6>
              <div id="statutFinancier">
                <div class="fs-4 fw-bold" id="libelle-statut">En attente</div>
                <div class="mt-2" id="montant-action" style="display: none;">
                  <span id="action-text"></span>
                  <div class="fs-5 fw-bold" id="montant-action-value">0.00 DA</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-end gap-3 mb-5">
      <button type="button" class="btn btn-secondary btn-lg" onclick="history.back()">
        <i class="bi bi-x-lg me-2"></i>Annuler
      </button>
      <button type="submit" class="btn btn-success btn-lg">
        <i class="bi bi-check-lg me-2"></i>Créer la location
      </button>
    </div>
  </form>
</div>

<!-- Templates -->
<template id="acte-inclus-template">
  <div class="card mb-3 acte-inclus-item border-info" data-acte-id="{acte_id}" data-index="{index}">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <strong>{nom_acte}</strong>
          <input type="hidden" name="actes_inclus[id][]" value="{acte_id}">
          <input type="hidden" name="actes_inclus[quantite_incluse][]" value="{quantite_incluse}">
          <input type="hidden" name="actes_inclus[prix_unitaire][]" value="{prix_unitaire}">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Qté utilisée</label>
          <input type="number" name="actes_inclus[quantite_utilisee][]" 
                 class="form-control quantite-acte-inclus" value="{quantite_incluse}" min="0" step="1">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Qté incluse</label>
          <div class="text-center">
            <span class="badge bg-success fs-6">{quantite_incluse}</span>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Prix unitaire</label>
          <div class="text-end small">{prix_unitaire} DA</div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Écart</label>
          <div class="text-center">
            <span class="ecart-acte badge bg-secondary">0</span>
          </div>
        </div>
        <div class="col-md-1">
          <label class="form-label small">Impact</label>
          <div class="text-end fw-bold impact-acte">0.00 DA</div>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="acte-supplementaire-template">
  <div class="card mb-3 acte-supp-item" data-index="{index}">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <label class="form-label small">Acte</label>
          <select name="actes_supp[id][]" class="form-select acte-supp-select" required>
            <option value="">-- Choisir un acte --</option>
            {% for acte in actes_location %}
            <option value="{{ acte.id }}" data-prix="{{ acte.prix }}">
              {{ acte.nom }} ({{ acte.prix|floatformat:2 }} DA)
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Quantité</label>
          <input type="number" name="actes_supp[quantite][]" class="form-control quantite-acte-supp" min="1" value="1">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Prix unitaire</label>
          <div class="input-group">
            <input type="text" name="actes_supp[prix][]" class="form-control prix-acte-supp text-end" readonly>
            <span class="input-group-text small">DA</span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Total</label>
          <div class="text-end fw-bold fs-5 total-acte-supp">0.00 DA</div>
        </div>
        <div class="col-md-1">
          <label class="form-label small">&nbsp;</label>
          <button type="button" class="btn btn-danger btn-sm remove-acte-supp d-block">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="produit-inclus-template">
  <div class="card mb-2 produit-inclus-item border-success" data-produit-id="{produit_id}" data-index="{index}">
    <div class="card-body py-2">
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <strong>{nom_produit}</strong>
          <input type="hidden" name="produits_inclus[id][]" value="{produit_id}">
          <input type="hidden" name="produits_inclus[quantite_incluse][]" value="{quantite_incluse}">
          <input type="hidden" name="produits_inclus[prix_unitaire][]" value="{prix_unitaire}">
          <div class="small text-muted">{source_info}</div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Qté utilisée</label>
          <div class="input-group input-group-sm">
            <input type="number" name="produits_inclus[quantite_utilisee][]" 
                   class="form-control quantite-produit-inclus" value="{quantite_incluse}" min="0" step="0.1">
            <button type="button" class="btn btn-outline-secondary reset-produit-inclus" 
                    data-original="{quantite_incluse}" title="Reset">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Qté incluse</label>
          <div class="text-center">
            <span class="badge bg-success">{quantite_incluse}</span>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Prix unitaire</label>
          <div class="text-end small">{prix_unitaire} DA</div>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Écart</label>
          <div class="text-center">
            <span class="ecart-produit badge bg-secondary">0</span>
          </div>
        </div>
        <div class="col-md-1">
          <label class="form-label small">Impact</label>
          <div class="text-end fw-bold small impact-produit">0.00 DA</div>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="produit-supplementaire-template">
  <div class="card mb-2 produit-supp-item" data-index="{index}">
    <div class="card-body py-2">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <label class="form-label small">Produit</label>
          <select name="produits_supp[id][]" class="form-select form-select-sm produit-supp-select" required>
            <option value="">-- Choisir un produit --</option>
            {options_produits}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small">Quantité</label>
          <input type="number" name="produits_supp[quantite][]" class="form-control form-control-sm quantite-produit-supp" min="0.1" step="0.1" value="1">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Prix unitaire</label>
          <div class="input-group input-group-sm">
            <input type="text" name="produits_supp[prix][]" class="form-control prix-produit-supp text-end" readonly>
            <span class="input-group-text">DA</span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label small">Total</label>
          <div class="text-end fw-bold total-produit-supp">0.00 DA</div>
        </div>
        <div class="col-md-1">
          <label class="form-label small">&nbsp;</label>
          <button type="button" class="btn btn-danger btn-sm remove-produit-supp d-block">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Scripts modulaires -->
<script src="{% static 'js/choices.min.js' %}"></script>

<!-- 1. Configuration et utilitaires -->
<script>
// Configuration globale
window.LocationConfig = {
    AJAX_URLS: {
        blocs: "{% url 'medical:ajax_get_all_blocs_data' %}",
        forfaits: "{% url 'medical:ajax_get_all_forfaits_data' %}",
        actes: "{% url 'medical:ajax_get_all_actes_data' %}",
        produits_supp: "{% url 'medical:ajax_get_produits_supplementaires' %}",
        bloc_detail: "{% url 'medical:ajax_get_bloc_produits' bloc_id=0 %}".replace('0', ''),
        forfait_detail: "{% url 'medical:ajax_get_forfait_produits' forfait_id=0 %}".replace('0', ''),
        acte_detail: "{% url 'medical:ajax_get_acte_produits' acte_id=0 %}".replace('0', '')
    }
};

// Variables globales
window.LocationCounters = {
    acteInclus: 0,
    acteSupp: 0,
    produitInclus: 0,
    produitSupp: 0
};

window.LocationCache = {
    blocs: {},
    forfaits: {},
    actes: [],
    produitsSupp: []
};
</script>

<!-- 2. Utilitaires -->
<script>
window.LocationUtils = {
    toNumber: (v, fallback = 0) => {
        const n = typeof v === 'number' ? v : parseFloat(String(v).replace(',', '.'));
        return isNaN(n) ? fallback : n;
    },
    
    formatDA: n => LocationUtils.toNumber(n).toFixed(2) + ' DA',
    
    updateElement: (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    },
    
    setLoading: (element, show) => {
        if (element) element.style.display = show ? 'block' : 'none';
    },
    
    createElement: (template, replacements) => {
        let html = template.innerHTML;
        for (const [key, value] of Object.entries(replacements)) {
            const regex = new RegExp(`\\{${key}\\}`, 'g');
            html = html.replace(regex, value);
        }
        const div = document.createElement('div');
        div.innerHTML = html;
        return div.firstElementChild;
    }
};
</script>

<!-- 3. Gestionnaire de données -->
<script>
window.LocationDataManager = {
    async loadAll() {
        try {
            const [blocsRes, forfaitsRes, actesRes, produitsRes] = await Promise.all([
                fetch(LocationConfig.AJAX_URLS.blocs).then(r => r.json()),
                fetch(LocationConfig.AJAX_URLS.forfaits).then(r => r.json()),
                fetch(LocationConfig.AJAX_URLS.actes).then(r => r.json()),
                fetch(LocationConfig.AJAX_URLS.produits_supp).then(r => r.json())
            ]);

            if (blocsRes.success) LocationCache.blocs = blocsRes.blocs;
            if (forfaitsRes.success) LocationCache.forfaits = forfaitsRes.forfaits;
            if (actesRes.success) LocationCache.actes = actesRes.actes;
            if (produitsRes.success) LocationCache.produitsSupp = produitsRes.produits;

            return true;
        } catch (error) {
            console.error('Erreur lors du chargement des données:', error);
            alert('Erreur lors du chargement des données. Veuillez rafraîchir la page.');
            return false;
        }
    },

    async loadActeDetails(acteId) {
        let acteData = LocationCache.actes.find(a => a.id == acteId);
        
        if (!acteData?.produits_inclus) {
            try {
                const url = LocationConfig.AJAX_URLS.acte_detail.replace('0', acteId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    if (acteData) {
                        acteData.produits_inclus = result.produits || [];
                    } else {
                        acteData = {
                            id: acteId,
                            nom: result.nom || 'Acte inconnu',
                            produits_inclus: result.produits || []
                        };
                        LocationCache.actes.push(acteData);
                    }
                }
            } catch (error) {
                console.error(`Erreur lors du chargement des produits de l'acte ${acteId}:`, error);
                return null;
            }
        }
        
        return acteData;
    }
};
</script>

<!-- 4. Gestionnaire des actes inclus -->
<script>
window.LocationActesInclus = {
    async charger(forfaitId) {
        const section = document.getElementById('actes-inclus-section');
        const container = document.getElementById('actes-inclus-container');
        
        if (!section || !container) return;

        container.innerHTML = '';
        
        let forfaitData = LocationCache.forfaits[forfaitId];
        
        if (!forfaitData) {
            try {
                const url = LocationConfig.AJAX_URLS.forfait_detail.replace('0', forfaitId);
                const response = await fetch(url);
                forfaitData = await response.json();
                LocationCache.forfaits[forfaitId] = forfaitData;
            } catch (error) {
                console.error('Erreur lors du chargement des actes inclus:', error);
            }
        }

        const actesInclus = forfaitData?.actes_inclus || [];
        
        if (!actesInclus.length) {
            section.style.display = 'none';
            return;
        }

        actesInclus.forEach((acte, index) => {
            this.ajouterActeInclus(acte, index);
        });

        section.style.display = 'block';
        this.calculerTotal();
    },

    ajouterActeInclus(acte, index) {
        const container = document.getElementById('actes-inclus-container');
        const template = document.getElementById('acte-inclus-template');
        
        if (!template || !container) return;

        const element = LocationUtils.createElement(template, {
            acte_id: acte.id,
            index: index,
            nom_acte: acte.nom,
            quantite_incluse: acte.quantite_incluse || 0,
            prix_unitaire: (acte.prix_standard || 0).toFixed(2)
        });
        
        container.appendChild(element);
        
        const quantiteInput = element.querySelector('.quantite-acte-inclus');
        if (quantiteInput) {
            quantiteInput.addEventListener('input', () => this.onQuantiteChange(element));
        }
    },

    onQuantiteChange(element) {
        const quantiteInput = element.querySelector('.quantite-acte-inclus');
        const quantiteUtilisee = LocationUtils.toNumber(quantiteInput.value, 0);
        const quantiteIncluse = LocationUtils.toNumber(element.querySelector('[name="actes_inclus[quantite_incluse][]"]').value, 0);
        const prixUnitaire = LocationUtils.toNumber(element.querySelector('[name="actes_inclus[prix_unitaire][]"]').value, 0);
        const acteId = element.dataset.acteId;

        const ecart = quantiteUtilisee - quantiteIncluse;
        const impact = Math.max(0, ecart) * prixUnitaire;

        const ecartEl = element.querySelector('.ecart-acte');
        const impactEl = element.querySelector('.impact-acte');

        if (ecartEl) {
            ecartEl.textContent = ecart.toFixed(0);
            ecartEl.className = 'ecart-acte badge ' + 
                (ecart > 0 ? 'bg-danger' : (ecart < 0 ? 'bg-success' : 'bg-secondary'));
        }
        
        if (impactEl) {
            impactEl.textContent = impact.toFixed(2) + ' DA';
            impactEl.className = 'text-end fw-bold impact-acte ' + 
                (impact > 0 ? 'text-danger' : 'text-dark');
        }

        this.mettreAJourProduitsActe(acteId, quantiteUtilisee, quantiteIncluse);
        this.calculerTotal();
    },

    mettreAJourProduitsActe(acteId, nouvelleQuantiteActe, quantiteIncluseActe) {
        const forfaitSelected = document.querySelector('[name="forfait"]:checked');
        if (!forfaitSelected) return;

        const forfaitId = forfaitSelected.value;
        const forfaitData = LocationCache.forfaits[forfaitId];
        if (!forfaitData) return;

        const acte = forfaitData.actes_inclus?.find(a => a.id == acteId);
        if (!acte || !acte.produits_inclus) return;

        console.log(`Mise à jour des produits de l'acte ${acte.nom}: ${quantiteIncluseActe} → ${nouvelleQuantiteActe}`);

        document.querySelectorAll('#produits-inclus-container .produit-inclus-item').forEach(produitElement => {
            const produitId = produitElement.dataset.produitId;

            if (!this.produitEstLieAActe(produitElement, acteId, acte.nom)) return;

            const produitActe = acte.produits_inclus.find(p => p.id == produitId);
            if (!produitActe) return;

            this.ajusterQuantitesProduit(produitElement, produitActe, nouvelleQuantiteActe, quantiteIncluseActe, acte);
        });
    },

    produitEstLieAActe(produitElement, acteId, acteNom) {
        const hasSourceClass = produitElement.classList.contains('source-acte_inclus') ||
                              produitElement.classList.contains('source-mixte') ||
                              produitElement.classList.contains('source-multiple_actes');

        if (!hasSourceClass) return false;

        const actesSourceIds = produitElement.dataset.actesSourceIds;
        if (actesSourceIds && actesSourceIds.split(',').includes(acteId.toString())) {
            return true;
        }

        const badges = produitElement.querySelectorAll('.badge');
        for (const badge of badges) {
            if (badge.textContent.includes(acteNom)) return true;
        }

        return false;
    },

    ajusterQuantitesProduit(produitElement, produitActe, nouvelleQuantiteActe, quantiteIncluseActe, acte) {
        const quantiteInput = produitElement.querySelector('.quantite-produit-inclus');
        const quantiteIncluseInput = produitElement.querySelector('[name="produits_inclus[quantite_incluse][]"]');
        const resetBtn = produitElement.querySelector('.reset-produit-inclus');
        const badgeIncluse = produitElement.querySelector('.badge.bg-success');

        if (!quantiteInput || !quantiteIncluseInput || !resetBtn) {
            console.warn('Éléments manquants dans le produit:', produitElement);
            return;
        }

        const quantiteUnitaire = LocationUtils.toNumber(produitActe.quantite_defaut, 0);
        const ancienneQuantiteTotaleIncluse = quantiteUnitaire * quantiteIncluseActe;
        const nouvelleQuantiteTotaleIncluse = quantiteUnitaire * nouvelleQuantiteActe;

        const quantiteIncluseActuelle = LocationUtils.toNumber(quantiteIncluseInput.value, 0);
        const quantiteUtiliseeActuelle = LocationUtils.toNumber(quantiteInput.value, 0);

        const differenceQuantite = nouvelleQuantiteTotaleIncluse - ancienneQuantiteTotaleIncluse;
        const nouvelleQuantiteIncluse = Math.max(0, quantiteIncluseActuelle + differenceQuantite);

        quantiteIncluseInput.value = nouvelleQuantiteIncluse.toFixed(1);
        resetBtn.dataset.original = nouvelleQuantiteIncluse.toFixed(1);

        if (Math.abs(quantiteUtiliseeActuelle - quantiteIncluseActuelle) < 0.1) {
            quantiteInput.value = nouvelleQuantiteIncluse.toFixed(1);
        } else {
            const ratio = quantiteIncluseActuelle > 0 ? (quantiteUtiliseeActuelle / quantiteIncluseActuelle) : 1;
            quantiteInput.value = Math.max(0, nouvelleQuantiteIncluse * ratio).toFixed(1);
        }

        if (badgeIncluse) {
            badgeIncluse.textContent = nouvelleQuantiteIncluse.toFixed(1);
        }

        this.mettreAJourBadgesDetail(produitElement, acte, nouvelleQuantiteTotaleIncluse);
        LocationProduitsInclus.onQuantiteChange(produitElement);

        console.log(`Produit ${produitActe.nom}: incluse ${quantiteIncluseActuelle} → ${nouvelleQuantiteIncluse}, utilisée ${quantiteUtiliseeActuelle} → ${quantiteInput.value}`);
    },

    mettreAJourBadgesDetail(produitElement, acte, nouvelleQuantite) {
        const sourceInfo = produitElement.querySelector('.mt-1');
        if (!sourceInfo) return;

        const badges = sourceInfo.querySelectorAll('.badge.bg-info');
        badges.forEach(badge => {
            if (badge.textContent.includes(acte.nom)) {
                const parts = badge.textContent.split(':');
                if (parts.length === 2) {
                    badge.textContent = `${parts[0].trim()}: ${nouvelleQuantite.toFixed(1)}`;
                }
            }
        });
    },

    calculerTotal() {
        let total = 0;
        document.querySelectorAll('#actes-inclus-container .impact-acte').forEach(el => {
            const value = parseFloat(el.textContent.replace(' DA', '')) || 0;
            total += value;
        });

        LocationUtils.updateElement('supplementsActesInclus', LocationUtils.formatDA(total));
        LocationCalculs.calculerTotal();
    },

    viderEtRecharger() {
        const section = document.getElementById('actes-inclus-section');
        const container = document.getElementById('actes-inclus-container');
        
        if (container) container.innerHTML = '';
        if (section) section.style.display = 'none';
        
        this.calculerTotal();
    }
};
</script>

<!-- 5. Gestionnaire des actes supplémentaires -->
<script>
window.LocationActesSupplementaires = {
    ajouter() {
        const container = document.getElementById('actes-supplementaires-container');
        const template = document.getElementById('acte-supplementaire-template');
        
        if (!template || !container) return null;

        const element = LocationUtils.createElement(template, {
            index: LocationCounters.acteSupp
        });
        
        element.dataset.index = LocationCounters.acteSupp;
        container.appendChild(element);
        this.initElement(element);
        LocationCounters.acteSupp++;
        
        return element;
    },

    initElement(element) {
        const select = element.querySelector('.acte-supp-select');
        const quantiteInput = element.querySelector('.quantite-acte-supp');
        const prixInput = element.querySelector('.prix-acte-supp');
        const removeBtn = element.querySelector('.remove-acte-supp');

        if (select) {
            select.addEventListener('change', () => {
                const option = select.options[select.selectedIndex];
                if (option?.value && prixInput) {
                    prixInput.value = LocationUtils.toNumber(option.dataset.prix, 0).toFixed(2);
                    this.chargerProduitsActe(option.value, element);
                } else if (prixInput) {
                    prixInput.value = '';
                    this.supprimerProduitsActe(element);
                }
                this.calculerTotalElement(element);
            });
        }

        if (quantiteInput) {
            quantiteInput.addEventListener('input', () => {
                this.calculerTotalElement(element);
                this.mettreAJourQuantitesProduitsActe(element);
            });
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                this.supprimerProduitsActe(element);
                element.remove();
                this.calculerTotal();
            });
        }
    },

    async chargerProduitsActe(acteId, acteElement) {
        if (!acteId) return;

        const acteData = await LocationDataManager.loadActeDetails(acteId);
        if (!acteData?.produits_inclus?.length) {
            console.log(`Aucun produit trouvé pour l'acte ${acteId}`);
            return;
        }

        acteElement.dataset.acteId = acteId;
        acteElement.dataset.produitsCharges = 'true';

        const quantiteActe = LocationUtils.toNumber(acteElement.querySelector('.quantite-acte-supp')?.value, 1);

        acteData.produits_inclus.forEach(produitActe => {
            this.ajouterProduitActeSupplementaire(produitActe, acteData, quantiteActe, acteElement);
        });

        console.log(`${acteData.produits_inclus.length} produits ajoutés pour l'acte ${acteData.nom}`);
    },

    ajouterProduitActeSupplementaire(produitActe, acteData, quantiteActe, acteElement) {
        const container = document.getElementById('produits-supplementaires-container');
        const template = document.getElementById('produit-supplementaire-template');
        
        if (!template || !container) return;

        const quantiteProduit = LocationUtils.toNumber(produitActe.quantite_defaut, 0) * quantiteActe;

        const optionsHtml = LocationCache.produitsSupp.map(p => 
            `<option value="${p.id}" data-prix="${LocationUtils.toNumber(p.prix, 0)}" ${p.id == produitActe.id ? 'selected' : ''}>
                ${p.code ? p.code + ' - ' : ''}${p.nom} (${LocationUtils.toNumber(p.prix, 0).toFixed(2)} DA)
            </option>`
        ).join('');

        const element = LocationUtils.createElement(template, {
            index: LocationCounters.produitSupp,
            options_produits: optionsHtml
        });
        
        element.classList.add('produit-from-acte-supp');
        element.dataset.sourceActeId = acteData.id;
        element.dataset.sourceActeElement = acteElement.dataset.index || LocationCounters.acteSupp - 1;
        element.dataset.quantiteUnitaire = produitActe.quantite_defaut || 0;

        const cardBody = element.querySelector('.card-body');
        if (cardBody) {
            const badge = document.createElement('div');
            badge.className = 'mb-2';
            badge.innerHTML = `<span class="badge bg-info"><i class="bi bi-link me-1"></i>Via acte: ${acteData.nom}</span>`;
            cardBody.insertBefore(badge, cardBody.firstChild);
        }

        container.appendChild(element);
        
        const quantiteInput = element.querySelector('.quantite-produit-supp');
        const prixInput = element.querySelector('.prix-produit-supp');
        
        if (quantiteInput) {
            quantiteInput.value = quantiteProduit.toFixed(1);
        }
        
        if (prixInput) {
            prixInput.value = LocationUtils.toNumber(produitActe.prix_unitaire, 0).toFixed(2);
        }

        LocationProduitsSupplementaires.initElement(element);
        LocationProduitsSupplementaires.calculerTotalElement(element);
        
        LocationCounters.produitSupp++;
    },

    supprimerProduitsActe(acteElement) {
        const acteId = acteElement.dataset.acteId;
        const acteIndex = acteElement.dataset.index;
        
        if (!acteId && !acteIndex) return;

        const produitsASupprimer = document.querySelectorAll(
            `.produit-from-acte-supp[data-source-acte-id="${acteId}"], ` +
            `.produit-from-acte-supp[data-source-acte-element="${acteIndex}"]`
        );

        produitsASupprimer.forEach(produit => {
            produit.remove();
        });

        delete acteElement.dataset.produitsCharges;
        delete acteElement.dataset.acteId;

        LocationProduitsSupplementaires.calculerTotal();
    },

    mettreAJourQuantitesProduitsActe(acteElement) {
        const acteId = acteElement.dataset.acteId;
        const acteIndex = acteElement.dataset.index;
        const nouvelleQuantiteActe = LocationUtils.toNumber(acteElement.querySelector('.quantite-acte-supp')?.value, 1);
        
        if (!acteId && !acteIndex) return;

        const produitsAssocies = document.querySelectorAll(
            `.produit-from-acte-supp[data-source-acte-id="${acteId}"], ` +
            `.produit-from-acte-supp[data-source-acte-element="${acteIndex}"]`
        );

        produitsAssocies.forEach(produitElement => {
            const quantiteUnitaire = LocationUtils.toNumber(produitElement.dataset.quantiteUnitaire, 0);
            const nouvelleQuantiteProduit = quantiteUnitaire * nouvelleQuantiteActe;
            
            const quantiteInput = produitElement.querySelector('.quantite-produit-supp');
            if (quantiteInput) {
                quantiteInput.value = nouvelleQuantiteProduit.toFixed(1);
                LocationProduitsSupplementaires.calculerTotalElement(produitElement);
            }
        });
    },

    calculerTotalElement(element) {
        const prix = LocationUtils.toNumber(element.querySelector('.prix-acte-supp')?.value, 0);
        const quantite = LocationUtils.toNumber(element.querySelector('.quantite-acte-supp')?.value, 0);
        const total = prix * quantite;

        const totalEl = element.querySelector('.total-acte-supp');
        if (totalEl) totalEl.textContent = total.toFixed(2) + ' DA';

        this.calculerTotal();
    },

    calculerTotal() {
        let total = 0;
        document.querySelectorAll('#actes-supplementaires-container .total-acte-supp').forEach(el => {
            const value = parseFloat(el.textContent.replace(' DA', '')) || 0;
            total += value;
        });

        LocationUtils.updateElement('totalActesSupp', LocationUtils.formatDA(total));
        LocationCalculs.calculerTotal();
    }
};
</script>

<!-- 6. Gestionnaire des produits inclus -->
<script>
window.LocationProduitsInclus = {
    async charger(id, type) {
        if (!id) return;

        const section = document.getElementById('produits-inclus-section');
        const container = document.getElementById('produits-inclus-container');
        
        if (!section || !container) return;

        container.innerHTML = '';

        let data = type === 'bloc' ? LocationCache.blocs[id] : LocationCache.forfaits[id];

        if (!data) {
            try {
                const url = (type === 'bloc' ? LocationConfig.AJAX_URLS.bloc_detail : LocationConfig.AJAX_URLS.forfait_detail)
                    .replace('0', id);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    data = { 
                        produits_inclus: result.produits || [],
                        actes_inclus: result.actes_inclus || result.actes || []
                    };
                    if (type === 'bloc') LocationCache.blocs[id] = data;
                    else LocationCache.forfaits[id] = data;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
            }
        }

        let produitsInclus = [...(data?.produits_inclus || [])];

        if (type === 'forfait') {
            const actesInclus = data?.actes_inclus || [];
            
            console.log(`Forfait ${id}: ${actesInclus.length} actes inclus trouvés`);

            for (const acte of actesInclus) {
                console.log(`Acte: ${acte.nom}, Produits: ${acte.produits_inclus?.length || 0}`);
                await this.ajouterProduitsActe(acte, produitsInclus);
            }

            console.log(`Total produits après consolidation: ${produitsInclus.length}`);
        }

        if (!produitsInclus.length) {
            section.style.display = 'none';
            return;
        }

        produitsInclus.sort((a, b) => {
            const sourceOrder = { 'direct': 1, 'acte_inclus': 2, 'mixte': 3 };
            return (sourceOrder[a.source] || 4) - (sourceOrder[b.source] || 4);
        });

        produitsInclus.forEach((produit, index) => {
            this.ajouterProduitInclus(produit, index);
        });

        section.style.display = 'block';
        this.calculerTotal();
    },

    async ajouterProduitsActe(acte, produitsExistants) {
        let produitsActe = acte.produits_inclus || [];

        if (!produitsActe.length) {
            let acteData = LocationCache.actes.find(a => a.id === acte.id);
            
            if (!acteData?.produits_inclus) {
                try {
                    const url = LocationConfig.AJAX_URLS.acte_detail.replace('0', acte.id);
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.success) {
                        if (acteData) {
                            acteData.produits_inclus = result.produits || [];
                        } else {
                            acteData = {
                                id: acte.id,
                                nom: acte.nom,
                                produits_inclus: result.produits || []
                            };
                            LocationCache.actes.push(acteData);
                        }
                        produitsActe = acteData.produits_inclus;
                    }
                } catch (error) {
                    console.error(`Erreur lors du chargement des produits de l'acte ${acte.id}:`, error);
                    return;
                }
            } else {
                produitsActe = acteData.produits_inclus;
            }
        }

        produitsActe.forEach(produitActe => {
            const quantiteUnitaire = LocationUtils.toNumber(produitActe.quantite_defaut, 0);
            const quantiteTotale = quantiteUnitaire * LocationUtils.toNumber(acte.quantite_incluse, 0);
            
            const existant = produitsExistants.find(p => p.id === produitActe.id);
            if (existant) {
                const ancienneQuantite = LocationUtils.toNumber(existant.quantite_defaut, 0);
                existant.quantite_defaut = ancienneQuantite + quantiteTotale;
                
                if (existant.source === 'direct') {
                    existant.source = 'mixte';
                    existant.sources_detaillees = [
                        { type: 'direct', quantite: ancienneQuantite },
                        { type: 'acte', nom: acte.nom, acte_id: acte.id, quantite: quantiteTotale, quantite_unitaire: quantiteUnitaire }
                    ];
                } else if (existant.source === 'acte_inclus') {
                    existant.source = 'multiple_actes';
                    if (!existant.sources_detaillees) {
                        existant.sources_detaillees = [
                            { type: 'acte', nom: existant.acte_source, quantite: ancienneQuantite }
                        ];
                    }
                    existant.sources_detaillees.push({
                        type: 'acte',
                        nom: acte.nom,
                        acte_id: acte.id,
                        quantite: quantiteTotale,
                        quantite_unitaire: quantiteUnitaire
                    });
                } else if (existant.source === 'mixte' || existant.source === 'multiple_actes') {
                    if (!existant.sources_detaillees) existant.sources_detaillees = [];
                    existant.sources_detaillees.push({
                        type: 'acte',
                        nom: acte.nom,
                        acte_id: acte.id,
                        quantite: quantiteTotale,
                        quantite_unitaire: quantiteUnitaire
                    });
                }
            } else {
                produitsExistants.push({
                    ...produitActe,
                    quantite_defaut: quantiteTotale,
                    source: 'acte_inclus',
                    acte_source: acte.nom,
                    acte_source_id: acte.id,
                    quantite_unitaire_acte: quantiteUnitaire,
                    sources_detaillees: [{
                        type: 'acte',
                        nom: acte.nom,
                        acte_id: acte.id,
                        quantite: quantiteTotale,
                        quantite_unitaire: quantiteUnitaire
                    }]
                });
            }
        });
    },

    ajouterProduitInclus(produit, index) {
        const container = document.getElementById('produits-inclus-container');
        const template = document.getElementById('produit-inclus-template');
        
        if (!template || !container) return;

        const source = produit.source || 'direct';
        let sourceInfo = '';
        let badgeColor = 'bg-primary';
        
        switch (source) {
            case 'direct':
                sourceInfo = 'Inclus directement';
                badgeColor = 'bg-primary';
                break;
            case 'acte_inclus':
                sourceInfo = `Via acte: ${produit.acte_source}`;
                badgeColor = 'bg-info';
                break;
            case 'mixte':
                sourceInfo = 'Direct + Actes';
                badgeColor = 'bg-warning text-dark';
                break;
            case 'multiple_actes':
                const nombreActes = produit.sources_detaillees?.filter(s => s.type === 'acte').length || 0;
                sourceInfo = `Via ${nombreActes} acte(s)`;
                badgeColor = 'bg-info';
                break;
            default:
                sourceInfo = 'Source inconnue';
                badgeColor = 'bg-secondary';
        }

        let detailSources = '';
        if (produit.sources_detaillees && produit.sources_detaillees.length > 1) {
            detailSources = '<div class="mt-1">';
            produit.sources_detaillees.forEach(detail => {
                if (detail.type === 'direct') {
                    detailSources += `<span class="badge bg-primary me-1">Direct: ${detail.quantite}</span>`;
                } else if (detail.type === 'acte') {
                    detailSources += `<span class="badge bg-info me-1">${detail.nom}: ${detail.quantite}</span>`;
                }
            });
            detailSources += '</div>';
        }

        const element = LocationUtils.createElement(template, {
            produit_id: produit.id,
            index: index,
            nom_produit: produit.nom,
            quantite_incluse: produit.quantite_defaut || 0,
            prix_unitaire: (produit.prix_unitaire || 0).toFixed(2),
            source_info: `<span class="badge ${badgeColor}">${sourceInfo}</span>${detailSources}`
        });
        
        element.classList.add(`source-${source}`);
        
        if (produit.sources_detaillees) {
            const actesIds = produit.sources_detaillees
                .filter(s => s.type === 'acte' && s.acte_id)
                .map(s => s.acte_id)
                .join(',');
            if (actesIds) {
                element.dataset.actesSourceIds = actesIds;
            }
        } else if (produit.acte_source_id) {
            element.dataset.actesSourceIds = produit.acte_source_id.toString();
        }

        container.appendChild(element);
        
        const quantiteInput = element.querySelector('.quantite-produit-inclus');
        const resetBtn = element.querySelector('.reset-produit-inclus');
        
        if (quantiteInput) {
            quantiteInput.addEventListener('input', () => this.onQuantiteChange(element));
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.resetQuantite(element));
        }
    },

    onQuantiteChange(element) {
        const quantiteInput = element.querySelector('.quantite-produit-inclus');
        const quantiteUtilisee = LocationUtils.toNumber(quantiteInput.value, 0);
        const quantiteIncluse = LocationUtils.toNumber(element.querySelector('[name="produits_inclus[quantite_incluse][]"]').value, 0);
        const prixUnitaire = LocationUtils.toNumber(element.querySelector('[name="produits_inclus[prix_unitaire][]"]').value, 0);

        const ecart = quantiteUtilisee - quantiteIncluse;
        const impact = Math.max(0, ecart) * prixUnitaire;

        const ecartEl = element.querySelector('.ecart-produit');
        const impactEl = element.querySelector('.impact-produit');

        if (ecartEl) {
            ecartEl.textContent = ecart.toFixed(1);
            ecartEl.className = 'ecart-produit badge ' + 
                (ecart > 0 ? 'bg-danger' : (ecart < 0 ? 'bg-success' : 'bg-secondary'));
        }
        
        if (impactEl) {
            impactEl.textContent = impact.toFixed(2) + ' DA';
            impactEl.className = 'text-end fw-bold small impact-produit ' + 
                (impact > 0 ? 'text-danger' : 'text-dark');
        }

        const resetBtn = element.querySelector('.reset-produit-inclus');
        if (resetBtn) {
            if (ecart !== 0) {
                resetBtn.classList.remove('btn-outline-secondary');
                resetBtn.classList.add('btn-warning');
                resetBtn.title = `Écart: ${ecart.toFixed(1)} - Reset vers ${quantiteIncluse}`;
            } else {
                resetBtn.classList.remove('btn-warning');
                resetBtn.classList.add('btn-outline-secondary');
                resetBtn.title = 'Quantité correcte';
            }
        }

        this.calculerTotal();
    },

    resetQuantite(element) {
        const resetBtn = element.querySelector('.reset-produit-inclus');
        const quantiteInput = element.querySelector('.quantite-produit-inclus');
        const quantiteOriginale = LocationUtils.toNumber(resetBtn.dataset.original, 0);
        
        if (quantiteInput) {
            quantiteInput.value = quantiteOriginale;
            this.onQuantiteChange(element);
        }
    },

    calculerTotal() {
        let supplements = 0;
        
        document.querySelectorAll('#produits-inclus-container .impact-produit').forEach(el => {
            const value = parseFloat(el.textContent.replace(' DA', '')) || 0;
            if (value > 0) supplements += value;
        });

        LocationUtils.updateElement('supplementsProduitsInclus', LocationUtils.formatDA(supplements));
        LocationCalculs.calculerTotal();
    },

    viderEtRecharger() {
        const section = document.getElementById('produits-inclus-section');
        const container = document.getElementById('produits-inclus-container');
        
        if (container) container.innerHTML = '';
        if (section) section.style.display = 'none';
        
        this.calculerTotal();
    }
};
</script>

<!-- 7. Gestionnaire des produits supplémentaires -->
<script>
window.LocationProduitsSupplementaires = {
    ajouter() {
        const container = document.getElementById('produits-supplementaires-container');
        const template = document.getElementById('produit-supplementaire-template');
        
        if (!template || !container) return;

        const optionsHtml = LocationCache.produitsSupp.map(p => 
            `<option value="${p.id}" data-prix="${LocationUtils.toNumber(p.prix, 0)}">
                ${p.code ? p.code + ' - ' : ''}${p.nom} (${LocationUtils.toNumber(p.prix, 0).toFixed(2)} DA)
            </option>`
        ).join('');

        const element = LocationUtils.createElement(template, {
            index: LocationCounters.produitSupp,
            options_produits: optionsHtml
        });
        
        container.appendChild(element);
        this.initElement(element);
        LocationCounters.produitSupp++;
    },

    initElement(element) {
        const select = element.querySelector('.produit-supp-select');
        const quantiteInput = element.querySelector('.quantite-produit-supp');
        const prixInput = element.querySelector('.prix-produit-supp');
        const removeBtn = element.querySelector('.remove-produit-supp');

        if (select) {
            select.addEventListener('change', () => {
                const option = select.options[select.selectedIndex];
                if (option?.value && prixInput) {
                    prixInput.value = LocationUtils.toNumber(option.dataset.prix, 0).toFixed(2);
                } else if (prixInput) {
                    prixInput.value = '';
                }
                this.calculerTotalElement(element);
            });
        }

        if (quantiteInput) {
            quantiteInput.addEventListener('input', () => this.calculerTotalElement(element));
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                element.remove();
                this.calculerTotal();
            });
        }
    },

    calculerTotalElement(element) {
        const prix = LocationUtils.toNumber(element.querySelector('.prix-produit-supp')?.value, 0);
        const quantite = LocationUtils.toNumber(element.querySelector('.quantite-produit-supp')?.value, 0);
        const total = prix * quantite;

        const totalEl = element.querySelector('.total-produit-supp');
        if (totalEl) totalEl.textContent = total.toFixed(2) + ' DA';

        this.calculerTotal();
    },

    calculerTotal() {
        let total = 0;
        document.querySelectorAll('#produits-supplementaires-container .total-produit-supp').forEach(el => {
            const value = parseFloat(el.textContent.replace(' DA', '')) || 0;
            total += value;
        });

        LocationUtils.updateElement('totalProduitsSupp', LocationUtils.formatDA(total));
        LocationCalculs.calculerTotal();
    }
};
</script>

<!-- 8. Gestionnaire des calculs -->
<script>
window.LocationCalculs = {
    calculerPrixBloc() {
        const blocSelected = document.querySelector('input[name="bloc"]:checked');
        const dureeInput = document.getElementById('dureeReelle');
        const typeTarif = document.querySelector('input[name="type_tarification"]:checked')?.value;

        if (!blocSelected || !dureeInput?.value) {
            LocationUtils.updateElement('prixBloc', '0.00');
            return 0;
        }

        const blocId = blocSelected.value;
        const duree = LocationUtils.toNumber(dureeInput.value, 0);
        const bloc = LocationCache.blocs[blocId];
        
        if (!bloc) {
            LocationUtils.updateElement('prixBloc', '0.00');
            return 0;
        }

        let prix = 0;
        if (typeTarif === 'FORFAIT') {
            const forfaitSelected = document.querySelector('input[name="forfait"]:checked');
            if (forfaitSelected) {
                const forfaitId = forfaitSelected.value;
                const forfait = LocationCache.forfaits[forfaitId];
                if (forfait) {
                    prix = LocationUtils.toNumber(forfait.prix, 0);
                    if (duree > LocationUtils.toNumber(forfait.duree, 0)) {
                        const minutesSupp = duree - LocationUtils.toNumber(forfait.duree, 0);
                        const tranches = Math.ceil(minutesSupp / 30);
                        prix += tranches * LocationUtils.toNumber(bloc.prix_supplement_30min, 0);
                    }
                }
            }
        } else {
            prix = LocationUtils.toNumber(bloc.prix_base, 0);
            if (duree > 90) {
                const minutesSupp = duree - 90;
                const tranches = Math.ceil(minutesSupp / 30);
                prix += tranches * LocationUtils.toNumber(bloc.prix_supplement_30min, 0);
            }
        }

        LocationUtils.updateElement('prixBloc', prix.toFixed(2));
        return prix;
    },

    calculerTotal() {
        const prixBloc = this.calculerPrixBloc();
        
        const supplementsActesInclus = parseFloat((document.getElementById('supplementsActesInclus')?.textContent || '0 DA').replace(' DA', '')) || 0;
        const totalActesSupp = parseFloat((document.getElementById('totalActesSupp')?.textContent || '0 DA').replace(' DA', '')) || 0;
        const totalActes = supplementsActesInclus + totalActesSupp;
        
        const supplementsProduitsInclus = parseFloat((document.getElementById('supplementsProduitsInclus')?.textContent || '0 DA').replace(' DA', '')) || 0;
        const totalProduitsSupp = parseFloat((document.getElementById('totalProduitsSupp')?.textContent || '0 DA').replace(' DA', '')) || 0;
        const totalProduits = supplementsProduitsInclus + totalProduitsSupp;

        LocationUtils.updateElement('totalActesGlobal', LocationUtils.formatDA(totalActes));
        LocationUtils.updateElement('totalProduitsGlobal', LocationUtils.formatDA(totalProduits));
        LocationUtils.updateElement('recapActes', totalActes.toFixed(2));
        LocationUtils.updateElement('recapProduits', totalProduits.toFixed(2));

        const totalGeneral = prixBloc + totalActes + totalProduits;
        LocationUtils.updateElement('totalGeneral', totalGeneral.toFixed(2));

        this.calculerStatutPaiement(totalGeneral);
    },

    calculerStatutPaiement(montantFacture) {
        const montantPaye = LocationUtils.toNumber(document.getElementById('montantPayeCaisse')?.value, 0);
        const difference = montantPaye - montantFacture;

        const analysePaiement = document.getElementById('analysePaiement');
        const cardStatut = document.getElementById('cardStatut');
        const statutFinancier = document.getElementById('libelle-statut');
        const montantAction = document.getElementById('montant-action');

        if (montantPaye > 0 || montantFacture > 0) {
            analysePaiement.style.display = 'block';

            LocationUtils.updateElement('montantFacture', LocationUtils.formatDA(montantFacture));
            LocationUtils.updateElement('montantPaye', LocationUtils.formatDA(montantPaye));

            if (montantPaye === 0) {
                cardStatut.className = 'card border-secondary';
                statutFinancier.textContent = 'Aucun paiement';
                statutFinancier.className = 'fs-4 fw-bold text-secondary';
                montantAction.style.display = 'none';
            } else if (difference > 0) {
                cardStatut.className = 'card border-success';
                statutFinancier.textContent = 'Surplus';
                statutFinancier.className = 'fs-4 fw-bold text-success';
                montantAction.style.display = 'block';
                document.getElementById('action-text').textContent = 'À verser au médecin :';
                document.getElementById('montant-action-value').textContent = LocationUtils.formatDA(difference);
            } else if (difference < 0) {
                cardStatut.className = 'card border-warning';
                statutFinancier.textContent = 'Complément requis';
                statutFinancier.className = 'fs-4 fw-bold text-warning';
                montantAction.style.display = 'block';
                document.getElementById('action-text').textContent = 'Dû par le médecin :';
                document.getElementById('montant-action-value').textContent = LocationUtils.formatDA(Math.abs(difference));
            } else {
                cardStatut.className = 'card border-primary';
                statutFinancier.textContent = 'Équilibré';
                statutFinancier.className = 'fs-4 fw-bold text-primary';
                montantAction.style.display = 'none';
            }
        } else {
            analysePaiement.style.display = 'none';
            statutFinancier.textContent = 'En attente';
            statutFinancier.className = 'fs-4 fw-bold text-muted';
            montantAction.style.display = 'none';
        }
    }
};
</script>

<!-- 9. Gestionnaire principal -->
<script>
window.LocationManager = {
    async init() {
        const dataLoaded = await LocationDataManager.loadAll();
        if (!dataLoaded) return;

        this.initializeInterface();
        this.initializeFlatpickr();
        this.attachEventListeners();
    },

    initializeInterface() {
        const currentType = document.querySelector('[name="type_tarification"]:checked')?.value || 'DUREE';
        this.chooseTarif(currentType);

        const blocChecked = document.querySelector('[name="bloc"]:checked');
        if (blocChecked && currentType === 'DUREE') {
            LocationProduitsInclus.charger(blocChecked.value, 'bloc');
        }

        if (currentType === 'FORFAIT') {
            const forfaitChecked = document.querySelector('[name="forfait"]:checked');
            if (forfaitChecked) {
                LocationActesInclus.charger(forfaitChecked.value);
                LocationProduitsInclus.charger(forfaitChecked.value, 'forfait');
            }
        }

        LocationCalculs.calculerTotal();
    },

    initializeFlatpickr() {
        flatpickr("#datetimepicker", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            time_24hr: true,
            locale: { firstDayOfWeek: 7 },
            defaultDate: document.getElementById("date_operation").value + " " + 
                       (document.getElementById("heure_operation").value || "00:00"),
            onChange: function(selectedDates, dateStr) {
                const [date, time] = dateStr.split(" ");
                document.getElementById("date_operation").value = date;
                document.getElementById("heure_operation").value = time;
            }
        });
    },

    attachEventListeners() {
        document.getElementById('add-acte')?.addEventListener('click', () => {
            LocationActesSupplementaires.ajouter();
        });

        document.getElementById('add-produit-supp')?.addEventListener('click', () => 
            LocationProduitsSupplementaires.ajouter()
        );

        document.getElementById('dureeReelle')?.addEventListener('input', () => {
            LocationCalculs.calculerTotal();
        });

        document.getElementById('montantPayeCaisse')?.addEventListener('input', () => {
            LocationCalculs.calculerTotal();
        });

        document.getElementById('prestationBlocForm')?.addEventListener('submit', this.validateForm);
    },

    selectBloc(element, inputId) {
        document.querySelectorAll('.card.pricing-card').forEach(card => {
            if (card.querySelector('[name="bloc"]')) {
                card.classList.remove('border-primary');
            }
        });
        
        if (element) {
            element.classList.add('border-primary');
        }

        const input = document.getElementById(inputId);
        if (input) input.checked = true;

        const blocId = input?.value;
        const currentType = document.querySelector('[name="type_tarification"]:checked')?.value || 'DUREE';

        LocationActesInclus.viderEtRecharger();
        LocationProduitsInclus.viderEtRecharger();

        if (blocId && currentType === 'DUREE') {
            LocationProduitsInclus.charger(blocId, 'bloc');
        }

        LocationCalculs.calculerTotal();
    },

    selectForfait(element, inputId) {
        document.querySelectorAll('#forfait-selection .pricing-card').forEach(card => {
            card.classList.remove('border-primary');
        });
        
        if (element) {
            element.classList.add('border-primary');
        }

        const input = document.getElementById(inputId);
        if (input) input.checked = true;

        const forfaitId = element?.dataset?.forfaitId || input?.value;
        
        LocationActesInclus.viderEtRecharger();
        LocationProduitsInclus.viderEtRecharger();
        
        if (forfaitId) {
            LocationActesInclus.charger(forfaitId);
            LocationProduitsInclus.charger(forfaitId, 'forfait');
        }

        LocationCalculs.calculerTotal();
    },

    chooseTarif(type) {
        document.querySelectorAll('[name="type_tarification"]').forEach(input => {
            const card = input.closest('.pricing-card');
            if (card) {
                if (input.value === type) {
                    card.classList.add('border-primary');
                } else {
                    card.classList.remove('border-primary');
                }
            }
        });

        const forfaitSelection = document.getElementById('forfait-selection');

        LocationActesInclus.viderEtRecharger();
        LocationProduitsInclus.viderEtRecharger();

        if (type === 'FORFAIT') {
            forfaitSelection?.classList.remove('d-none');

            const forfaitChecked = document.querySelector('[name="forfait"]:checked');
            if (forfaitChecked) {
                LocationActesInclus.charger(forfaitChecked.value);
                LocationProduitsInclus.charger(forfaitChecked.value, 'forfait');
            }
        } else {
            forfaitSelection?.classList.add('d-none');

            const blocChecked = document.querySelector('[name="bloc"]:checked');
            if (blocChecked) {
                LocationProduitsInclus.charger(blocChecked.value, 'bloc');
            }
        }

        const radio = document.getElementById('tarif_' + type.toLowerCase());
        if (radio) radio.checked = true;

        LocationCalculs.calculerTotal();
    },

    validateForm(e) {
        const typeTarif = document.querySelector('[name="type_tarification"]:checked')?.value;
        const nomActeInput = document.getElementById('nomActe');
        const dureeReelle = document.getElementById('dureeReelle');

        if (!dureeReelle?.value || LocationUtils.toNumber(dureeReelle.value, 0) <= 0) {
            e.preventDefault();
            alert('La durée réelle est obligatoire et doit être positive.');
            return false;
        }

        if (!nomActeInput?.value?.trim()) {
            e.preventDefault();
            alert('Le nom de l\'intervention est obligatoire.');
            return false;
        }

        if (typeTarif === 'FORFAIT') {
            const forfait = document.querySelector('[name="forfait"]:checked');
            if (!forfait) {
                e.preventDefault();
                alert('Veuillez sélectionner un forfait pour la tarification forfaitaire.');
                return false;
            }
        }

        return true;
    }
};
</script>

<!-- 10. Initialisation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser Choices.js pour les selects
    if (typeof Choices !== 'undefined') {
        new Choices("#patientSelect", {
            searchEnabled: true,
            removeItemButton: true,
            placeholder: true,
            placeholderValue: "-- Choisir un patient --"
        });
        
        new Choices("#medecinSelect", {
            searchEnabled: true,
            removeItemButton: true,
            placeholder: true,
            placeholderValue: "-- Choisir un médecin --"
        });
    }

    // Initialiser le gestionnaire de location
    LocationManager.init();
});
</script>

<style>
/* Styles améliorés pour l'interface simplifiée */
.pricing-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.pricing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.pricing-card.border-primary {
    background: linear-gradient(135deg, #f0f7ff, white);
    box-shadow: 0 5px 15px rgba(13, 110, 253, 0.2);
    border-width: 2px !important;
}

/* Cartes des sections unifiées */
.card-header.bg-info {
    background: linear-gradient(135deg, #0dcaf0, #31d2f2) !important;
}

.card-header.bg-warning {
    background: linear-gradient(135deg, #ffc107, #ffcd39) !important;
}

/* Styles pour les éléments des actes inclus */
.acte-inclus-item {
    border-left: 4px solid #0dcaf0;
}

.acte-inclus-item .card-body {
    background-color: #f8fcff;
}

/* Styles pour les éléments des produits inclus */
.produit-inclus-item {
    border-left: 4px solid #198754;
}

.produit-inclus-item .card-body {
    background-color: #f8fff9;
}

/* Styles pour les différentes sources de produits */
.source-direct {
    border-left: 4px solid #0d6efd;
}

.source-acte_inclus {
    border-left: 4px solid #0dcaf0;
}

.source-mixte {
    border-left: 4px solid #ffc107;
}

.source-multiple_actes {
    border-left: 4px solid #6f42c1;
}

.source-direct .card-body {
    background-color: #f0f7ff;
}

.source-acte_inclus .card-body {
    background-color: #e7f9ff;
}

.source-mixte .card-body {
    background-color: #fff8e1;
}

.source-multiple_actes .card-body {
    background-color: #f3f0ff;
}

/* Styles pour les produits d'actes supplémentaires */
.produit-from-acte-supp {
    border-left: 4px solid #0dcaf0;
    background-color: #f0f9ff;
}

.produit-from-acte-supp .badge.bg-info {
    animation: fadeInLeft 0.3s ease;
}

@keyframes fadeInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Badges d'écart améliorés */
.badge {
    padding: 0.4rem 0.6rem;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.badge:hover {
    transform: scale(1.05);
}

.badge.bg-danger {
    background-color: #dc3545 !important;
    animation: pulse-danger 2s infinite;
}

.badge.bg-success {
    background-color: #198754 !important;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

.badge.bg-info {
    background-color: #0dcaf0 !important;
}

.badge.bg-warning.text-dark {
    background-color: #ffc107 !important;
    color: #000 !important;
}

@keyframes pulse-danger {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

/* Boutons reset améliorés */
.reset-produit-inclus {
    transition: all 0.3s ease;
    border-left: none !important;
    position: relative;
}

.reset-produit-inclus:hover {
    transform: rotate(180deg);
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
}

.reset-produit-inclus.btn-warning {
    animation: pulse-warning 2s infinite;
}

@keyframes pulse-warning {
    0% { 
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); 
    }
    70% { 
        box-shadow: 0 0 0 6px rgba(255, 193, 7, 0); 
    }
    100% { 
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); 
    }
}

/* Amélioration des couleurs d'impact */
.text-danger {
    color: #dc3545 !important;
    font-weight: 600;
}

.text-success {
    color: #198754 !important;
    font-weight: 600;
}

.text-info {
    color: #0dcaf0 !important;
    font-weight: 600;
}

.text-warning {
    color: #ffc107 !important;
    font-weight: 600;
}

/* Animation des changements */
.impact-acte, .impact-produit {
    transition: color 0.3s ease;
}

.ecart-acte, .ecart-produit {
    transition: all 0.3s ease;
}

/* Totaux en bas des sections */
.bg-light {
    background-color: #f8f9fa !important;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
}

/* Tables responsives améliorées */
.table-responsive {
    border-radius: 0.375rem;
    overflow: hidden;
}

.table {
    margin-bottom: 0;
}

.table td, .table th {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

.table-borderless td {
    border: none;
    padding: 0.5rem 0;
}

.table-borderless tr:last-child td {
    border-top: 2px solid #198754;
    padding-top: 1rem;
    font-size: 1.1rem;
}

/* Amélioration des formulaires */
.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control-sm, .form-select-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Cartes d'analyse de paiement */
#analysePaiement .card {
    transition: all 0.3s ease;
}

#analysePaiement .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Amélioration des alertes */
.alert {
    border-radius: 0.5rem;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.alert-info {
    background-color: #cff4fc;
    color: #055160;
}

.alert-warning {
    background-color: #fff3cd;
    color: #664d03;
}

/* Animation d'apparition */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.acte-inclus-item, .produit-inclus-item, .acte-supp-item, .produit-supp-item {
    animation: fadeInUp 0.3s ease;
}

/* Styles pour les actes et produits supplémentaires */
.acte-supp-item {
    border-left: 4px solid #0d6efd;
}

.acte-supp-item:hover {
    background-color: #f0f7ff;
}

.produit-supp-item {
    border-left: 4px solid #ffc107;
}

.produit-supp-item:hover {
    background-color: #fffbf0;
}

/* Styles pour les totaux */
.fw-bold {
    font-weight: 600 !important;
}

.fs-5 {
    font-size: 1.25rem !important;
}

/* Amélioration des icônes */
.bi {
    font-size: 1rem;
}

.card-header .bi {
    font-size: 1.1rem;
}

.fs-2 .bi {
    font-size: 2rem !important;
}

/* Status cards styling */
.border-success {
    border-color: #198754 !important;
}

.border-warning {
    border-color: #ffc107 !important;
}

.border-primary {
    border-color: #0d6efd !important;
}

.border-secondary {
    border-color: #6c757d !important;
}

/* Amélioration de l'affichage des sources multiples */
.mt-1 .badge {
    font-size: 0.65rem;
    margin-bottom: 0.2rem;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .col-md-1, .col-md-2, .col-md-3, .col-md-4 {
        margin-bottom: 0.5rem;
    }
    
    .card-body .row .col-md-1:last-child,
    .card-body .row .col-md-2:last-child,
    .card-body .row .col-md-3:last-child {
        text-align: center !important;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .fs-5 {
        font-size: 1rem !important;
    }
    
    .fs-4 {
        font-size: 1.1rem !important;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.3rem 0.5rem;
    }
    
    /* Stack cards on mobile */
    .pricing-card {
        margin-bottom: 1rem;
    }
}

/* Améliorations visuelles supplémentaires */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Amélioration des tooltips */
[title] {
    cursor: help;
}

/* Focus states améliorés */
.btn:focus,
.form-control:focus,
.form-select:focus {
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* États de validation */
.is-valid {
    border-color: #198754;
}

.is-invalid {
    border-color: #dc3545;
}

.valid-feedback {
    color: #198754;
}

.invalid-feedback {
    color: #dc3545;
}

/* Améliorations des transitions */
* {
    box-sizing: border-box;
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.slide-in {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(-100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Print styles */
@media print {
    .btn, .alert, .card-header {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        break-inside: avoid;
    }
    
    .table {
        border-collapse: collapse;
    }
    
    .table td, .table th {
        border: 1px solid #000;
        padding: 8px;
    }
}
</style>

{% endblock %}