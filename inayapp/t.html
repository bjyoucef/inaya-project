<!-- Extrait du template floor_plan.html - Fonction JavaScript améliorée pour les séjours courts -->

<script>
    // Fonction améliorée pour afficher les détails du patient avec facturation des séjours courts
    function displayPatientDetails(admission) {
        const formatDate = (dateStr) => {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('fr-FR', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' DA';
        };

        const formatDuration = (hours) => {
            const h = Math.floor(hours);
            const m = Math.floor((hours - h) * 60);
            if (hours < 1) {
                return `${Math.round(hours * 60)}min`;
            } else if (hours < 24) {
                return m > 0 ? `${h}h${m}min` : `${h}h`;
            } else {
                const days = Math.floor(hours / 24);
                const remainingHours = Math.floor(hours % 24);
                return remainingHours > 0 ? `${days}j ${remainingHours}h` : `${days}j`;
            }
        };

        // Créer une timeline financière avec support des séjours courts
        function createFinancialTimelineWithShortStays(admission) {
            let timeline = [];
            let cumulativeCost = 0;

            // 1. Admission initiale
            timeline.push({
                type: 'admission',
                date: new Date(admission.admission_date),
                title: 'Admission initiale',
                details: `Patient admis dans l'hôpital`,
                icon: 'fas fa-sign-in-alt',
                color: 'success',
                cost: 0,
                cumulative: 0
            });

            // 2. Parcours détaillé avec coûts et séjours courts
            if (admission.detailed_journey) {
                admission.detailed_journey.forEach((etape, index) => {
                    const stepCost = etape.period_cost || 0;
                    cumulativeCost = etape.cumulative_cost || (cumulativeCost + stepCost);

                    let titleSuffix = '';
                    let billingInfo = '';

                    if (etape.is_short_stay) {
                        titleSuffix = ' (Séjour court)';
                        billingInfo = `
                        <div class="short-stay-info mt-2">
                            <span class="badge bg-warning">
                                <i class="fas fa-clock me-1"></i>
                                Séjour court: ${formatDuration(etape.duration_hours)}
                            </span>
                            <div class="billing-formula mt-1">
                                <small class="text-muted">${etape.billing_details?.formule || ''}</small>
                            </div>
                        </div>
                    `;
                    } else {
                        billingInfo = `
                        <div class="normal-stay-info mt-2">
                            <span class="badge bg-info">
                                <i class="fas fa-calendar me-1"></i>
                                Séjour normal: ${etape.days} jour(s)
                            </span>
                            <div class="billing-formula mt-1">
                                <small class="text-muted">${etape.billing_details?.formule || ''}</small>
                            </div>
                        </div>
                    `;
                    }

                    timeline.push({
                        type: 'stay_period',
                        date: new Date(etape.start_date),
                        title: `Séjour en ${etape.service}${titleSuffix}`,
                        details: `
                        <div class="financial-details">
                            <div><strong>Lit:</strong> ${etape.bed} - Chambre ${etape.room}</div>
                            <div><strong>Durée:</strong> ${formatDuration(etape.duration_hours)} (${etape.days} jour(s))</div>
                            <div><strong>Prix/nuit:</strong> ${formatCurrency(etape.night_price)}</div>
                            ${billingInfo}
                            <div class="financial-summary mt-2">
                                <strong>Coût période:</strong> <span class="text-success">${formatCurrency(stepCost)}</span>
                            </div>
                        </div>
                    `,
                        icon: etape.is_short_stay ? 'fas fa-clock' : 'fas fa-bed',
                        color: etape.is_current ? 'primary' : (etape.is_short_stay ? 'warning' : 'info'),
                        cost: stepCost,
                        cumulative: cumulativeCost,
                        endDate: etape.end_date ? new Date(etape.end_date) : null,
                        isCurrent: etape.is_current || false,
                        isShortStay: etape.is_short_stay
                    });
                });
            }

            // 3. Transferts (inchangé)
            if (admission.transfers_history) {
                admission.transfers_history.forEach(transfer => {
                    const impactDescription = transfer.financial_impact?.impact_description || '';
                    const priceDiff = transfer.financial_impact?.price_difference || 0;

                    timeline.push({
                        type: 'transfer',
                        date: new Date(transfer.date),
                        title: `Transfert vers ${transfer.to_service || 'service inconnu'}`,
                        details: `
                        <div class="transfer-details">
                            <div><strong>Motif:</strong> ${transfer.reason}</div>
                            <div><strong>De:</strong> ${transfer.from_service || 'N/A'} → <strong>Vers:</strong> ${transfer.to_service || 'N/A'}</div>
                            ${impactDescription ? `<div class="financial-impact ${priceDiff > 0 ? 'text-warning' : priceDiff < 0 ? 'text-success' : 'text-muted'}">
                                <i class="fas fa-chart-line"></i> ${impactDescription}
                            </div>` : ''}
                        </div>
                    `,
                        icon: 'fas fa-exchange-alt',
                        color: priceDiff > 0 ? 'warning' : priceDiff < 0 ? 'success' : 'info',
                        cost: 0,
                        cumulative: cumulativeCost
                    });
                });
            }

            // 4. Sortie (si applicable)
            if (admission.discharge_date) {
                timeline.push({
                    type: 'discharge',
                    date: new Date(admission.discharge_date),
                    title: 'Sortie',
                    details: `
                    <div><strong>Statut:</strong> ${admission.status}</div>
                    <div class="final-cost"><strong>Coût total final:</strong> <span class="text-success fw-bold">${formatCurrency(admission.estimated_cost)}</span></div>
                `,
                    icon: 'fas fa-sign-out-alt',
                    color: 'danger',
                    cost: 0,
                    cumulative: admission.estimated_cost
                });
            }

            timeline.sort((a, b) => a.date - b.date);
            return timeline;
        }

        const financialTimeline = createFinancialTimelineWithShortStays(admission);

        // Structure avec onglet dédié aux séjours courts
        const tabsHtml = `
        <ul class="nav nav-tabs" id="patientTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                    <i class="fas fa-info-circle"></i> Informations générales
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
                    <i class="fas fa-calculator"></i> Facturation détaillée
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="short-stays-tab" data-bs-toggle="tab" data-bs-target="#short-stays" type="button" role="tab">
                    <i class="fas fa-clock"></i> Séjours courts 
                    ${admission.billing_summary?.nombre_sejours_courts > 0 ?
                `<span class="badge bg-warning ms-1">${admission.billing_summary.nombre_sejours_courts}</span>` : ''}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
                    <i class="fas fa-route"></i> Parcours complet
                </button>
            </li>
        </ul>
    `;

        const tabContentHtml = `
        <div class="tab-content mt-3" id="patientTabContent">
            <!-- ONGLET 1: INFORMATIONS GÉNÉRALES -->
            <div class="tab-pane fade show active" id="info" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h5>${admission.patient.last_name} ${admission.patient.first_name}</h5>
                        <p><strong>Date d'admission:</strong> ${formatDate(admission.admission_date)}</p>
                        <p><strong>Durée du séjour:</strong> ${formatDuration(admission.length_of_stay_hours)} (${admission.length_of_stay_days} jour(s))</p>
                        <p><strong>Statut:</strong> <span class="badge bg-primary">${admission.status}</span></p>
                    </div>
                    <div class="col-md-6">
                        ${admission.bed ? `
                            <p><strong>Lit actuel:</strong> ${admission.bed.bed_number} (Chambre ${admission.bed.room.room_number})</p>
                            <p><strong>Service:</strong> ${admission.bed.room.service}</p>
                            <p><strong>Prix/nuit actuel:</strong> ${formatCurrency(admission.bed.room.night_price)}</p>
                        ` : '<p><strong>Lit:</strong> <span class="badge bg-warning">En attente d\'assignation</span></p>'}
                        
                        <div class="cost-summary mt-3 p-3 bg-light rounded">
                            <h6><i class="fas fa-calculator"></i> Résumé financier</h6>
                            <div class="d-flex justify-content-between">
                                <span>Coût total estimé:</span>
                                <strong class="text-success">${formatCurrency(admission.estimated_cost)}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Coût moyen/jour:</span>
                                <span>${formatCurrency(admission.estimated_cost / Math.max(1, admission.length_of_stay_days))}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Coût moyen/heure:</span>
                                <span>${formatCurrency(admission.estimated_cost / Math.max(1, admission.length_of_stay_hours))}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ONGLET 2: FACTURATION DÉTAILLÉE -->
            <div class="tab-pane fade" id="billing" role="tabpanel">
                <div class="financial-breakdown">
                    <h6 class="mb-3"><i class="fas fa-receipt"></i> Détail de la facturation</h6>
                    
                    <!-- Résumé financier avec séjours courts -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="financial-card total">
                                <div class="financial-value">${formatCurrency(admission.estimated_cost)}</div>
                                <div class="financial-label">Coût Total</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="financial-card average">
                                <div class="financial-value">${formatCurrency(admission.estimated_cost / Math.max(1, admission.length_of_stay_hours))}</div>
                                <div class="financial-label">Coût Moyen/Heure</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="financial-card duration">
                                <div class="financial-value">${formatDuration(admission.length_of_stay_hours)}</div>
                                <div class="financial-label">Durée Totale</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="financial-card stats">
                                <div class="financial-value">${(admission.billing_summary?.nombre_sejours_courts || 0) + (admission.billing_summary?.nombre_sejours_normaux || 0)}</div>
                                <div class="financial-label">Nb Périodes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Répartition séjours courts vs normaux -->
                    ${admission.billing_summary ? `
                        <div class="billing-breakdown mb-4">
                            <h6>Répartition par type de séjour</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="breakdown-card short-stays">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-clock text-warning"></i> Séjours courts (&lt;24h)</span>
                                            <span class="badge bg-warning">${admission.billing_summary.nombre_sejours_courts}</span>
                                        </div>
                                        <div class="breakdown-amount">${formatCurrency(admission.billing_summary.sejours_courts.reduce((sum, s) => sum + s.cout_total, 0))}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="breakdown-card normal-stays">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-bed text-info"></i> Séjours normaux (≥24h)</span>
                                            <span class="badge bg-info">${admission.billing_summary.nombre_sejours_normaux}</span>
                                        </div>
                                        <div class="breakdown-amount">${formatCurrency(admission.billing_summary.sejours_normaux.reduce((sum, s) => sum + s.cout_total, 0))}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Détail par période -->
                    <h6 class="mb-3">Facturation par période</h6>
                    <div class="periods-breakdown">
                        ${admission.detailed_journey ? admission.detailed_journey.map((period, index) => `
                            <div class="period-item ${period.is_current ? 'current-period' : ''} ${period.is_short_stay ? 'short-stay-period' : 'normal-stay-period'}">
                                <div class="period-header">
                                    <div class="period-title">
                                        <strong>${period.service}</strong> - Chambre ${period.room}, Lit ${period.bed}
                                        ${period.is_current ? '<span class="badge bg-success ms-2">EN COURS</span>' : ''}
                                        ${period.is_short_stay ? '<span class="badge bg-warning ms-2"><i class="fas fa-clock"></i> Court</span>' : '<span class="badge bg-info ms-2"><i class="fas fa-bed"></i> Normal</span>'}
                                    </div>
                                    <div class="period-cost">
                                        <strong>${formatCurrency(period.period_cost || 0)}</strong>
                                    </div>
                                </div>
                                <div class="period-details">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <small class="text-muted">
                                                Du ${formatDate(period.start_date)} ${period.end_date ? 'au ' + formatDate(period.end_date) : '(en cours)'}
                                                <br>
                                                Durée: ${formatDuration(period.duration_hours)} (${period.days} jour(s))
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <small>Prix nuit: ${formatCurrency(period.night_price)}</small>
                                        </div>
                                    </div>
                                    ${period.billing_details ? `
                                        <div class="billing-formula mt-2 p-2 bg-light rounded">
                                            <strong>Calcul:</strong> <code>${period.billing_details.formule}</code>
                                            ${period.is_short_stay ? `
                                                <div class="short-stay-details mt-1">
                                                    <small class="text-muted">
                                                        Tarif fixe: ${formatCurrency(period.billing_details.tarif_fixe_service)} + 
                                                        Tarif variable: ${formatCurrency(period.billing_details.cout_variable || 0)}
                                                        (${formatCurrency(period.billing_details.tarif_horaire || 0)}/h × ${period.billing_details.duree_heures}h)
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    <div class="cumulative-cost">
                                        <small class="text-muted">Coût cumulé: <strong>${formatCurrency(period.cumulative_cost || 0)}</strong></small>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-muted">Aucun détail de séjour disponible</p>'}
                    </div>
                </div>
            </div>

            <!-- ONGLET 3: SÉJOURS COURTS -->
            <div class="tab-pane fade" id="short-stays" role="tabpanel">
                <div class="short-stays-analysis">
                    <h6 class="mb-3"><i class="fas fa-clock text-warning"></i> Analyse des séjours courts</h6>
                    
                    ${admission.billing_summary && admission.billing_summary.sejours_courts.length > 0 ? `
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Les séjours courts sont facturés avec un tarif fixe + un tarif horaire variable selon la formule de chaque service.
                        </div>
                        
                        <div class="short-stays-list">
                            ${admission.billing_summary.sejours_courts.map((sejour, index) => `
                                <div class="short-stay-card mb-3 p-3 border border-warning rounded">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-clock text-warning me-2"></i>
                                            Séjour court #${index + 1}
                                        </h6>
                                        <span class="badge bg-warning">${formatCurrency(sejour.cout_total)}</span>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Durée:</strong> ${formatDuration(sejour.duree_heures)}</p>
                                            <p class="mb-1"><strong>Service:</strong> ${sejour.service || 'N/A'}</p>
                                            <p class="mb-1"><strong>Prix chambre:</strong> ${formatCurrency(sejour.prix_nuit_applique)}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Tarif fixe:</strong> ${formatCurrency(sejour.tarif_fixe_service)}</p>
                                            <p class="mb-1"><strong>Tarif horaire:</strong> ${formatCurrency(sejour.tarif_horaire)}/h</p>
                                            <p class="mb-1"><strong>Coût variable:</strong> ${formatCurrency(sejour.cout_variable)}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="formula-display mt-2 p-2 bg-light rounded">
                                        <strong>Formule appliquée:</strong>
                                        <code class="d-block">${sejour.formule}</code>
                                    </div>
                                    
                                    <div class="comparison mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Si facturé au tarif normal: ${formatCurrency(sejour.prix_nuit_applique)} 
                                            (économie de ${formatCurrency(sejour.prix_nuit_applique - sejour.cout_total)})
                                        </small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="short-stays-summary mt-4 p-3 bg-warning bg-opacity-10 rounded">
                            <h6><i class="fas fa-calculator text-warning"></i> Résumé des séjours courts</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <div class="stat-value">${admission.billing_summary.nombre_sejours_courts}</div>
                                        <div class="stat-label">Nombre de séjours</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <div class="stat-value">${formatCurrency(admission.billing_summary.sejours_courts.reduce((sum, s) => sum + s.cout_total, 0))}</div>
                                        <div class="stat-label">Coût total</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <div class="stat-value">${formatDuration(admission.billing_summary.sejours_courts.reduce((sum, s) => sum + s.duree_heures, 0))}</div>
                                        <div class="stat-label">Durée totale</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Aucun séjour court détecté. Tous les séjours ont été facturés au tarif normal.
                        </div>
                    `}
                </div>
            </div>

            <!-- ONGLET 4: TIMELINE COMPLÈTE -->
            <div class="tab-pane fade" id="timeline" role="tabpanel">
                <h6 class="mb-3"><i class="fas fa-route"></i> Parcours chronologique avec coûts</h6>
                <div class="financial-timeline">
                    ${financialTimeline.map((event, index) => `
                        <div class="timeline-item ${event.type} ${event.isCurrent ? 'current-event' : ''} ${event.isShortStay ? 'short-stay-event' : ''}">
                            <div class="timeline-marker ${event.isShortStay ? 'short-stay-marker' : ''}">
                                <i class="${event.icon} text-${event.color}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <div class="timeline-date">
                                        ${event.type === 'stay_period' && event.isCurrent ? 'EN COURS' : formatDate(event.date.toISOString())}
                                        ${event.endDate ? ' → ' + formatDate(event.endDate.toISOString()) : ''}
                                    </div>
                                    <div class="timeline-cost">
                                        ${event.cost > 0 ? formatCurrency(event.cost) : ''}
                                        ${event.cumulative > 0 ? `<br><small class="text-muted">Total: ${formatCurrency(event.cumulative)}</small>` : ''}
                                    </div>
                                </div>
                                <div class="timeline-title">${event.title}</div>
                                <div class="timeline-details">${event.details}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

        // Assembler le contenu avec styles CSS supplémentaires pour les séjours courts
        const fullContent = `
        <style>
            /* Styles existants... */
            .financial-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                margin-bottom: 15px;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .financial-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            .financial-card.total { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
            .financial-card.average { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
            .financial-card.duration { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
            .financial-card.stats { background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); }
            
            /* Styles spécifiques aux séjours courts */
            .short-stay-period {
                border-left: 4px solid #ffc107 !important;
                background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 255, 255, 0.1) 100%);
            }
            
            .normal-stay-period {
                border-left: 4px solid #17a2b8 !important;
            }
            
            .short-stay-card {
                background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 255, 255, 0.5) 100%);
                transition: all 0.3s ease;
            }
            .short-stay-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            }
            
            .breakdown-card {
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                transition: all 0.3s ease;
            }
            .breakdown-card:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }
            .breakdown-card.short-stays {
                border-left: 4px solid #ffc107;
            }
            .breakdown-card.normal-stays {
                border-left: 4px solid #17a2b8;
            }
            .breakdown-amount {
                font-size: 1.5rem;
                font-weight: bold;
                margin-top: 8px;
            }
            
            .short-stay-event .timeline-marker {
                border-color: #ffc107;
                background: rgba(255, 193, 7, 0.1);
            }
            
            .formula-display {
                font-family: 'Courier New', monospace;
                font-size: 0.9rem;
            }
            
            .stat-item {
                text-align: center;
                padding: 10px;
            }
            .stat-value {
                font-size: 1.5rem;
                font-weight: bold;
                color: #495057;
            }
            .stat-label {
                font-size: 0.9rem;
                color: #6c757d;
                margin-top: 5px;
            }
            
            /* Badges pour les séjours courts */
            .badge.bg-warning {
                background-color: #ffc107 !important;
                color: #000;
            }
            
            .short-stay-details {
                background: rgba(255, 193, 7, 0.1);
                border-radius: 4px;
                padding: 8px;
            }
            
            /* Responsive */
            @media (max-width: 768px) {
                .financial-card {
                    margin-bottom: 10px;
                }
                .breakdown-card {
                    margin-bottom: 10px;
                }
                .timeline-header {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .timeline-cost {
                    text-align: left;
                    margin-top: 5px;
                }
            }
        </style>
        ${tabsHtml}
        ${tabContentHtml}
    `;

        document.getElementById('patientDetailContent').innerHTML = fullContent;

        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('patientDetailModal'));
        modal.show();
    }

    // Fonction pour simuler les coûts de différentes durées
    async function simulateCostsForService(serviceId, roomPrice = 30000) {
        try {
            const response = await fetch('/hospitalisation/api/simulate-costs/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    service_id: serviceId,
                    prix_chambre: roomPrice,
                    durees_heures: [1, 2, 4, 6, 12, 18, 24, 48, 72]
                })
            });

            const data = await response.json();
            if (data.success) {
                displayCostSimulation(data);
            }
        } catch (error) {
            console.error('Erreur simulation:', error);
        }
    }

    function displayCostSimulation(data) {
        const simulationHtml = `
        <div class="cost-simulation">
            <h6>Simulation de coûts - Service ${data.service.name}</h6>
            <p>Prix chambre: ${data.prix_chambre} DA/nuit | Tarif fixe: ${data.service.tarif_fixe} DA | Seuil: ${data.service.seuil_heures}h</p>
            
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Durée</th>
                            <th>Coût total</th>
                            <th>Coût/heure</th>
                            <th>Mode</th>
                            <th>Formule</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.simulations.map(sim => `
                            <tr class="${sim.est_sejour_court ? 'table-warning' : 'table-info'}">
                                <td>${sim.duree_heures}h</td>
                                <td><strong>${sim.cout_total.toLocaleString()} DA</strong></td>
                                <td>${sim.cout_par_heure.toLocaleString()} DA/h</td>
                                <td>
                                    <span class="badge bg-${sim.est_sejour_court ? 'warning' : 'info'}">
                                        ${sim.est_sejour_court ? 'Court' : 'Normal'}
                                    </span>
                                </td>
                                <td><small>${sim.formule}</small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

        // Afficher dans un modal ou une section dédiée
        console.log('Simulation générée:', simulationHtml);
    }

</script>