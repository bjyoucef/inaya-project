{% extends "layout.html" %}
{% load static custom_filters_medical i18n %}

{% block content %}
<style>
    :root {
        --gradient-primary: linear-gradient(135deg, #2563eb, #3b82f6);
        --gradient-success: linear-gradient(135deg, #10b981, #059669);
        --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
        --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
        --gradient-info: linear-gradient(135deg, #06b6d4, #0891b2);
        --gradient-dark: linear-gradient(135deg, #1f2937, #374151);
        --backdrop-blur: backdrop-filter: blur(10px);
    }

    body {
        background: linear-gradient(135deg, var(--bs-gray-50) 0%, var(--bs-gray-100) 100%);
        font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    }

    /* Gradient Backgrounds */
    .bg-gradient-primary {
        background: var(--gradient-primary) !important;
    }

    .bg-gradient-success {
        background: var(--gradient-success) !important;
    }

    .bg-gradient-warning {
        background: var(--gradient-warning) !important;
    }

    .bg-gradient-danger {
        background: var(--gradient-danger) !important;
    }

    .bg-gradient-info {
        background: var(--gradient-info) !important;
    }

    .bg-gradient-dark {
        background: var(--gradient-dark) !important;
    }

    /* Enhanced Cards */
    .card-enhanced {
        border: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    .card-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* Header with decorative elements */
    .header-main {
        position: relative;
        overflow: hidden;
    }

    .header-main::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(100px, -100px);
    }

    .card-header-enhanced {
        position: relative;
        overflow: hidden;
    }

    .card-header-enhanced::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 150px;
        height: 150px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }

    /* Glassmorphism buttons */
    .btn-glass {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        backdrop-filter: blur(10px);
        transition: all 0.3s;
    }

    .btn-glass:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
    }

    /* Interactive rows */
    .info-row {
        transition: all 0.2s;
        border-radius: 0.5rem;
        margin: 0.25rem 0;
        padding: 0.75rem;
    }

    .info-row:hover {
        background-color: var(--bs-gray-50);
        transform: translateX(0.25rem);
    }

    /* Product items with dynamic styling */
    .product-item {
        border-left: 4px solid var(--bs-success);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .product-item:hover {
        transform: translateY(-2px);
        border-left-color: var(--bs-primary);
    }

    .product-item.supplementaire {
        border-left-color: var(--bs-warning);
    }

    .product-item.economy {
        border-left-color: var(--bs-success);
        background: linear-gradient(135deg, #f0fdf4, white);
    }

    .product-item.surcharge {
        border-left-color: var(--bs-danger);
        background: linear-gradient(135deg, #fef2f2, white);
    }

    /* Animated price highlight */
    .price-highlight {
        position: relative;
        overflow: hidden;
    }

    .price-highlight::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive table */
    .table-enhanced {
        border-collapse: separate;
        border-spacing: 0;
    }

    .table-enhanced th {
        background: var(--bs-gray-100);
        font-weight: 600;
        border: 1px solid var(--bs-gray-200);
    }

    .table-enhanced tbody tr:hover {
        background: var(--bs-gray-50);
    }

    /* Badges with gradients */
    .badge-gradient {
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    /* Fade in animation */
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Print styles */
    @media print {
        .no-print {
            display: none !important;
        }

        .main-container {
            padding: 0;
            max-width: none;
        }

        .card-enhanced {
            box-shadow: none;
            border: 1px solid #ddd;
        }

        .bg-gradient-primary,
        .bg-gradient-success,
        .bg-gradient-info,
        .bg-gradient-warning {
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .header-main h1 {
            font-size: 1.75rem;
        }

        .btn-glass {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }

        .table-enhanced {
            font-size: 0.875rem;
        }
    }
</style>

<div class="container-fluid py-4">
    <!-- Header Principal -->
    <div class="card card-enhanced bg-gradient-primary text-white mb-4 header-main fade-in">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="fw-bold mb-2 position-relative">
                        <i class="bi bi-building me-3"></i>
                        <span id="page-title">{% trans "Détail Location de Bloc" %}</span>
                    </h1>
                    <p class="mb-0 opacity-90 position-relative">
                        {{ location.bloc.nom_bloc }} - {{ location.date_operation|date:"l d F Y" }}
                        <span class="ms-3">
                            <i class="bi bi-file-earmark-text"></i>
                            {% trans "Facture" %} #BL-{{ location.id|stringformat:"05d" }}
                        </span>
                    </p>
                </div>
                <div class="col-lg-4">
                    <div class="d-flex flex-wrap justify-content-end gap-2 position-relative">
                        <button onclick="window.print()" class="btn btn-glass">
                            <i class="bi bi-printer me-2"></i>{% trans "Imprimer" %}
                        </button>
                        <button onclick="downloadPDF()" class="btn btn-glass">
                            <i class="bi bi-download me-2"></i>{% trans "PDF" %}
                        </button>
                        <a href="{% url 'medical:location_bloc_send_whatsapp' location.id %}" target="_blank"
                            class="btn btn-glass">
                            <i class="bi bi-whatsapp me-2"></i>{% trans "WhatsApp" %}
                        </a>
                        <a href="{% url 'medical:location_bloc_list' %}" class="btn btn-glass">
                            <i class="bi bi-arrow-left me-2"></i>{% trans "Retour" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Colonne principale -->
        <div class="col-xl-8">
            <!-- Informations principales -->
            <div class="card card-enhanced fade-in">
                <div class="card-header bg-gradient-dark text-white card-header-enhanced">
                    <div class="row align-items-center position-relative">
                        <div class="col">
                            <h4 class="mb-2">{{ location.nom_acte|default:"Intervention chirurgicale" }}</h4>
                            <p class="mb-0 opacity-90">
                                <i class="bi bi-calendar-event me-2"></i>{{ location.date_operation|date:"l d F Y" }}
                                {% if location.heure_operation %}
                                <i class="bi bi-clock ms-3 me-2"></i>{{ location.heure_operation|time:"H:i" }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-auto">
                            {% if location.duree_reelle %}
                            <span class="badge bg-gradient-danger badge-gradient fs-6">
                                <i class="bi bi-stopwatch"></i>{{ location.duree_reelle }} min
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-row">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-person-circle text-primary me-2"></i>
                                    <span class="fw-semibold text-muted">{% trans "Patient" %}</span>
                                </div>
                                <div>
                                    <a href="{% url 'patients:patient_detail' location.patient.id %}"
                                        class="text-decoration-none fw-bold">
                                        {{ location.patient.nom_complet }}
                                    </a>
                                    {% if location.patient.date_naissance %}
                                    <small class="d-block text-muted">{{ location.patient.date_naissance|date:"d/m/Y"
                                        }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-person-badge text-success me-2"></i>
                                    <span class="fw-semibold text-muted">{% trans "Médecin responsable" %}</span>
                                </div>
                                <div>
                                    Dr. {{ location.medecin.nom_complet }}
                                    {% if location.medecin.specialite %}
                                    <small class="d-block text-muted">{{ location.medecin.specialite }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-building text-info me-2"></i>
                                    <span class="fw-semibold text-muted">{% trans "Bloc opératoire" %}</span>
                                </div>
                                <div>
                                    {{ location.bloc.nom_bloc }}
                                    <small class="d-block text-muted">
                                        {% trans "Tarif" %}: {{ location.bloc.prix_base|floatformat:2 }} DA (90 min)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-row">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-gear text-primary me-2"></i>
                                    <span class="fw-semibold text-muted">{% trans "Type de tarification" %}</span>
                                </div>
                                <div>
                                    {% if location.type_tarification == 'FORFAIT' %}
                                    <span class="badge bg-success badge-gradient">
                                        <i class="bi bi-tag"></i>{% trans "Forfaitaire" %}
                                    </span>
                                    {% if location.forfait %}
                                    <div class="mt-2">
                                        <strong>{{ location.forfait.nom }}</strong>
                                        <small class="d-block text-muted">{{
                                            location.forfait.description|truncatechars:100 }}</small>
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge bg-primary badge-gradient">
                                        <i class="bi bi-clock"></i>{% trans "À la durée" %}
                                    </span>
                                    <small class="d-block text-muted mt-1">{% trans "Prix calculé selon le temps
                                        d'utilisation réel" %}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-stopwatch text-warning me-2"></i>
                                    <span class="fw-semibold text-muted">{% trans "Durée d'intervention" %}</span>
                                </div>
                                <div>
                                    {% if location.duree_reelle %}
                                    <span class="badge bg-gradient-danger badge-gradient">
                                        <i class="bi bi-stopwatch"></i>{{ location.duree_reelle }} min ({% trans
                                        "réelle" %})
                                    </span>
                                    <small class="d-block text-muted mt-1">
                                        {% if location.type_tarification == 'FORFAIT' and location.forfait %}
                                        {% trans "Forfait" %}: {{ location.forfait.duree }} min {% trans "incluses" %}
                                        {% else %}
                                        {% trans "Base" %}: 90 min {% trans "incluses" %}
                                        {% endif %}
                                    </small>
                                    {% elif location.duree_prevue %}
                                    <span class="badge bg-info badge-gradient">
                                        <i class="bi bi-clock-history"></i>{{ location.duree_prevue }} min ({% trans
                                        "prévue" %})
                                    </span>
                                    {% else %}
                                    <span class="text-muted">{% trans "Non définie" %}</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="info-row detail-only">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-person text-muted me-2"></i>
                                    <span class="fw-semibold text-muted">{% trans "Créé par" %}</span>
                                </div>
                                <div>
                                    {{
                                    location.cree_par.get_full_name|default:location.cree_par.username|default:"Système"
                                    }}
                                    <small class="d-block text-muted">{{ location.date_creation|date:"d/m/Y à H:i"
                                        }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if location.observations %}
                    <div class="info-row mt-4 detail-only">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-chat-text text-info me-2"></i>
                            <span class="fw-semibold text-muted">{% trans "Observations" %}</span>
                        </div>
                        <div class="bg-light p-3 rounded-3">
                            {{ location.observations|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Informations de paiement -->
            <div class="card card-enhanced fade-in">
                <div class="card-header bg-gradient-info text-white card-header-enhanced">
                    <h5 class="mb-0 position-relative">
                        <i class="bi bi-cash-stack me-2"></i>{% trans "Informations de paiement" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% with detail_paiement=location.get_detail_paiement %}
                    <div class="row g-4">
                        <!-- Montants principaux -->
                        <div class="col-md-4">
                            <div class="border rounded-3 p-3 h-100">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-receipt me-1"></i>{% trans "Montants" %}
                                </h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{% trans "Montant facturé" %} :</span>
                                    <strong>{{ detail_paiement.montant_facture|floatformat:2 }} DA</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>{% trans "Montant payé" %} :</span>
                                    <strong>{{ detail_paiement.montant_paye|floatformat:2 }} DA</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span>{% trans "Différence" %} :</span>
                                    <strong
                                        class="{% if detail_paiement.difference > 0 %}text-success{% elif detail_paiement.difference < 0 %}text-warning{% else %}text-primary{% endif %}">
                                        {% if detail_paiement.difference > 0 %}+{% endif %}{{
                                        detail_paiement.difference|floatformat:2 }} DA
                                    </strong>
                                </div>
                            </div>
                        </div>

                        <!-- Statut et actions -->
                        <div class="col-md-4">
                            <div class="border rounded-3 p-3 h-100">
                                <h6 class="text-info mb-3">
                                    <i class="bi bi-info-circle me-1"></i>{% trans "Statut" %}
                                </h6>

                                {% if location.statut_paiement == 'EQUILIBRE' %}
                                <div class="alert alert-success mb-3">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>{{ detail_paiement.statut }}</strong><br>
                                    <small>{% trans "Le paiement est équilibré" %}</small>
                                </div>
                                {% elif location.statut_paiement == 'SURPLUS_CLINIQUE' %}
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-arrow-up-circle me-2"></i>
                                    <strong>{{ detail_paiement.statut }}</strong><br>
                                    <small>{{ detail_paiement.surplus_a_verser|floatformat:2 }} DA {% trans "à verser au
                                        médecin" %}</small>
                                </div>
                                {% if not detail_paiement.date_reglement_surplus %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>{% trans "Action requise" %}</strong><br>
                                    {% trans "Surplus non encore versé" %}
                                </div>
                                {% endif %}
                                {% elif location.statut_paiement == 'COMPLEMENT_MEDECIN' %}
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-arrow-down-circle me-2"></i>
                                    <strong>{{ detail_paiement.statut }}</strong><br>
                                    <small>{{ detail_paiement.complement_du_medecin|floatformat:2 }} DA {% trans "dû par
                                        le médecin" %}</small>
                                </div>
                                {% if not detail_paiement.date_reglement_complement %}
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>{% trans "Action requise" %}</strong><br>
                                    {% trans "Complément non encore payé" %}
                                </div>
                                {% endif %}
                                {% else %}
                                <div class="alert alert-secondary mb-3">
                                    <i class="bi bi-dash-circle me-2"></i>
                                    <strong>{{ detail_paiement.statut }}</strong>
                                </div>
                                {% endif %}

                                <div class="text-center">
                                    {% if detail_paiement.is_reglement_complet %}
                                    <span class="badge bg-success badge-gradient fs-6">
                                        <i class="bi bi-check-circle me-1"></i>{% trans "Règlement complet" %}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning badge-gradient fs-6">
                                        <i class="bi bi-clock me-1"></i>{% trans "Règlement en attente" %}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Historique des règlements -->
                        <div class="col-md-4">
                            <div class="border rounded-3 p-3 h-100">
                                <h6 class="text-success mb-3">
                                    <i class="bi bi-calendar-check me-1"></i>{% trans "Règlements" %}
                                </h6>

                                {% if location.date_reglement_surplus %}
                                <div class="mb-2">
                                    <small class="text-muted">{% trans "Surplus versé le" %} :</small><br>
                                    <strong>{{ location.date_reglement_surplus|date:"d/m/Y" }}</strong>
                                    <span class="badge bg-success ms-2">
                                        {{ location.surplus_a_verser|floatformat:2 }} DA
                                    </span>
                                </div>
                                {% endif %}

                                {% if location.date_reglement_complement %}
                                <div class="mb-2">
                                    <small class="text-muted">{% trans "Complément payé le" %} :</small><br>
                                    <strong>{{ location.date_reglement_complement|date:"d/m/Y" }}</strong>
                                    <span class="badge bg-warning ms-2">
                                        {{ location.complement_du_medecin|floatformat:2 }} DA
                                    </span>
                                </div>
                                {% endif %}

                                {% if not location.date_reglement_surplus and not location.date_reglement_complement %}
                                <div class="text-muted text-center">
                                    <i class="bi bi-calendar-x"></i><br>
                                    <small>{% trans "Aucun règlement effectué" %}</small>
                                </div>
                                {% endif %}

                                {% if location.besoin_reglement_surplus and user.is_staff %}
                                <div class="mt-3">
                                    <button class="btn btn-success btn-sm"
                                        onclick="marquerReglementSurplus({{ location.id }})">
                                        <i class="bi bi-check me-1"></i>{% trans "Marquer surplus versé" %}
                                    </button>
                                </div>
                                {% endif %}

                                {% if location.besoin_reglement_complement and user.is_staff %}
                                <div class="mt-3">
                                    <button class="btn btn-warning btn-sm"
                                        onclick="marquerReglementComplement({{ location.id }})">
                                        <i class="bi bi-check me-1"></i>{% trans "Marquer complément payé" %}
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if location.notes_paiement %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-light">
                                <h6><i class="bi bi-sticky me-2"></i>{% trans "Notes sur le paiement" %}</h6>
                                <p class="mb-0">{{ location.notes_paiement|linebreaks }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>

            <!-- Détail des prestations -->
            <div class="card card-enhanced fade-in">
                <div class="card-header bg-gradient-primary text-white card-header-enhanced">
                    <h5 class="mb-0 position-relative">
                        <i class="bi bi-list-ul me-2"></i>
                        <span class="detail-only">{% trans "Actes et prestations" %}</span>
                        <span class="facture-only d-none">{% trans "Détail des prestations" %}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-enhanced">
                            <thead>
                                <tr>
                                    <th>{% trans "Description" %}</th>
                                    <th>{% trans "Détail" %}</th>
                                    <th class="text-center">{% trans "Quantité" %}</th>
                                    <th class="text-end">{% trans "Prix unitaire" %}</th>
                                    <th class="text-end">{% trans "Montant" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Prestation principale -->
                                <tr>
                                    <td>
                                        <strong>
                                            {% if location.type_tarification == 'FORFAIT' %}
                                            {% trans "Forfait" %} {{ location.forfait.nom }}
                                            {% else %}
                                            {% trans "Location bloc" %} {{ location.bloc.nom_bloc }}
                                            {% endif %}
                                        </strong>
                                    </td>
                                    <td>
                                        {% if location.type_tarification == 'FORFAIT' %}
                                        {% if location.duree_reelle > location.forfait.duree %}
                                        {{ location.forfait.duree }} min {% trans "incluses" %} + {{
                                        location.duree_reelle|add:location.forfait.duree|floatformat:0|add:"-"|add:location.forfait.duree|floatformat:0
                                        }} min {% trans "supp." %}
                                        {% else %}
                                        {{ location.forfait.duree }} min {% trans "incluses" %}
                                        {% endif %}
                                        {% else %}
                                        {% if location.duree_reelle > 90 %}
                                        90 min {% trans "incluses" %} + {{ location.duree_reelle|add:"-90" }} min {%
                                        trans "supp." %}
                                        {% else %}
                                        {{ location.duree_reelle|default:90 }} min d'utilisation
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">1</td>
                                    <td class="text-end">{{ location.prix_final|floatformat:2 }} DA</td>
                                    <td class="text-end"><strong>{{ location.prix_final|floatformat:2 }} DA</strong>
                                    </td>
                                </tr>

                                <!-- Actes supplémentaires -->
                                {% for acte_location in location.actes_location.all %}
                                <tr>
                                    <td>
                                        <strong>{{ acte_location.acte.nom }}</strong>
                                        <small class="d-block text-muted">{% trans "Acte supplémentaire" %}</small>
                                    </td>
                                    <td>{{ acte_location.acte.description|truncatechars:60|default:"Acte médical
                                        spécialisé" }}</td>
                                    <td class="text-center">{{ acte_location.quantite }}</td>
                                    <td class="text-end">{{ acte_location.prix_unitaire|floatformat:2 }} DA</td>
                                    <td class="text-end"><strong>{{ acte_location.prix_total|floatformat:2 }}
                                            DA</strong></td>
                                </tr>
                                {% endfor %}

                                <!-- Produits supplémentaires ou avec écart -->
                                {% for consommation in consommations %}
                                {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' or consommation.ecart_quantite >
                                0 %}
                                <tr>
                                    <td>
                                        <strong>{{ consommation.produit.nom }}</strong>
                                        {% if consommation.produit.code_produit %}
                                        <small class="d-block text-muted">{% trans "Code" %}: {{
                                            consommation.produit.code_produit }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' %}
                                        <span class="badge bg-warning">{% trans "Produit supplémentaire" %}</span>
                                        {% else %}
                                        <span class="badge bg-danger">{% trans "Supplément de consommation" %}</span>
                                        <small class="d-block text-muted">{% trans "Écart" %}: +{{
                                            consommation.ecart_quantite|floatformat:1 }} ({% trans "Inclus" %}: {{
                                            consommation.quantite_incluse|floatformat:1 }})</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' %}
                                        {{ consommation.quantite|floatformat:1 }}
                                        {% else %}
                                        {{ consommation.ecart_quantite|floatformat:1 }}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ consommation.prix_unitaire|floatformat:2 }} DA</td>
                                    <td class="text-end">
                                        <strong>
                                            {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' %}
                                            {{ consommation.prix_total|floatformat:2 }} DA
                                            {% else %}
                                            {{ consommation.prix_facturable|floatformat:2 }} DA
                                            {% endif %}
                                        </strong>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end fw-bold">{% trans "TOTAL À PAYER (TTC)" %}</td>
                                    <td class="text-end">
                                        <strong class="fs-5 text-primary">{{
                                            location.montant_total_facture|floatformat:2 }} DA</strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Consommation détaillée des produits (mode détail uniquement) -->
            <div class="card card-enhanced fade-in detail-only">
                <div class="card-header bg-gradient-info text-white card-header-enhanced">
                    <h5 class="mb-0 position-relative">
                        <i class="bi bi-box me-2"></i>{% trans "Consommation détaillée des produits" %}
                        <span class="badge bg-light text-info ms-2">{{ consommations|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Produits inclus dans le bloc -->
                    {% if resume_consommation.bloc %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-building text-primary me-2"></i>
                            {% trans "Produits inclus dans le bloc" %} ({{ resume_consommation.bloc|length }})
                        </h6>
                        <div class="row">
                            {% for produit_data in resume_consommation.bloc %}
                            <div class="col-lg-6 mb-3">
                                <div
                                    class="product-item p-3 {% if produit_data.est_economie %}economy{% elif produit_data.ecart > 0 %}surcharge{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                            <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                                <small class="text-muted">
                                                    <i class="bi bi-box me-1"></i>{% trans "Inclus" %}: {{
                                                    produit_data.quantite_incluse }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-graph-up me-1"></i>{% trans "Consommé" %}: {{
                                                    produit_data.quantite_consommee }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-currency-dollar me-1"></i>{{
                                                    produit_data.prix_unitaire|floatformat:2 }} DA/u
                                                </small>
                                            </div>
                                            {% if produit_data.ecart != 0 %}
                                            <div class="mt-2">
                                                {% if produit_data.ecart > 0 %}
                                                <span class="badge bg-gradient-danger badge-gradient">
                                                    <i class="bi bi-plus-circle me-1"></i>
                                                    {% trans "Supplément" %}: +{{ produit_data.ecart|floatformat:1 }} =
                                                    +{{ produit_data.prix_ecart|floatformat:2 }} DA
                                                </span>
                                                {% else %}
                                                <span class="badge bg-gradient-success badge-gradient">
                                                    <i class="bi bi-dash-circle me-1"></i>
                                                    {% trans "Économie" %}: {{ produit_data.ecart|floatformat:1 }} = {{
                                                    produit_data.prix_ecart|floatformat:2 }} DA
                                                </span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <span
                                                class="badge {% if produit_data.ecart > 0 %}bg-danger{% elif produit_data.ecart < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                                {{ produit_data.quantite_consommee }}x
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Produits inclus dans le forfait -->
                    {% if resume_consommation.forfait %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-tag text-success me-2"></i>
                            {% trans "Produits inclus dans le forfait" %} ({{ resume_consommation.forfait|length }})
                        </h6>
                        <div class="row">
                            {% for produit_data in resume_consommation.forfait %}
                            <div class="col-lg-6 mb-3">
                                <div
                                    class="product-item p-3 {% if produit_data.est_economie %}economy{% elif produit_data.ecart > 0 %}surcharge{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                            <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                                <small class="text-muted">
                                                    <i class="bi bi-box me-1"></i>{% trans "Inclus" %}: {{
                                                    produit_data.quantite_incluse }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-graph-up me-1"></i>{% trans "Consommé" %}: {{
                                                    produit_data.quantite_consommee }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-currency-dollar me-1"></i>{{
                                                    produit_data.prix_unitaire|floatformat:2 }} DA/u
                                                </small>
                                            </div>
                                            {% if produit_data.ecart != 0 %}
                                            <div class="mt-2">
                                                {% if produit_data.ecart > 0 %}
                                                <span class="badge bg-gradient-danger badge-gradient">
                                                    <i class="bi bi-plus-circle me-1"></i>
                                                    {% trans "Supplément" %}: +{{ produit_data.ecart|floatformat:1 }} =
                                                    +{{ produit_data.prix_ecart|floatformat:2 }} DA
                                                </span>
                                                {% else %}
                                                <span class="badge bg-gradient-success badge-gradient">
                                                    <i class="bi bi-dash-circle me-1"></i>
                                                    {% trans "Économie" %}: {{ produit_data.ecart|floatformat:1 }} = {{
                                                    produit_data.prix_ecart|floatformat:2 }} DA
                                                </span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <span
                                                class="badge {% if produit_data.ecart > 0 %}bg-danger{% elif produit_data.ecart < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                                {{ produit_data.quantite_consommee }}x
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Produits inclus dans les actes -->
                    {% for acte_nom, produits_acte in resume_consommation.actes.items %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-clipboard-check text-warning me-2"></i>
                            {% trans "Produits inclus dans" %} "{{ acte_nom }}" ({{ produits_acte|length }})
                        </h6>
                        <div class="row">
                            {% for produit_data in produits_acte %}
                            <div class="col-lg-6 mb-3">
                                <div
                                    class="product-item p-3 {% if produit_data.est_economie %}economy{% elif produit_data.ecart > 0 %}surcharge{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                            <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                                <small class="text-muted">
                                                    <i class="bi bi-box me-1"></i>{% trans "Inclus" %}: {{
                                                    produit_data.quantite_incluse }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-graph-up me-1"></i>{% trans "Consommé" %}: {{
                                                    produit_data.quantite_consommee }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-currency-dollar me-1"></i>{{
                                                    produit_data.prix_unitaire|floatformat:2 }} DA/u
                                                </small>
                                            </div>
                                            {% if produit_data.ecart != 0 %}
                                            <div class="mt-2">
                                                {% if produit_data.ecart > 0 %}
                                                <span class="badge bg-gradient-danger badge-gradient">
                                                    <i class="bi bi-plus-circle me-1"></i>
                                                    {% trans "Supplément" %}: +{{ produit_data.ecart|floatformat:1 }} =
                                                    +{{ produit_data.prix_ecart|floatformat:2 }} DA
                                                </span>
                                                {% else %}
                                                <span class="badge bg-gradient-success badge-gradient">
                                                    <i class="bi bi-dash-circle me-1"></i>
                                                    {% trans "Économie" %}: {{ produit_data.ecart|floatformat:1 }} = {{
                                                    produit_data.prix_ecart|floatformat:2 }} DA
                                                </span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <span
                                                class="badge {% if produit_data.ecart > 0 %}bg-danger{% elif produit_data.ecart < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                                {{ produit_data.quantite_consommee }}x
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    {% if resume_consommation.supplementaires %}
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-plus-circle text-danger me-2"></i>
                            {% trans "Produits supplémentaires" %} ({{ resume_consommation.supplementaires|length }})
                        </h6>
                        <div class="row">
                            {% for produit_data in resume_consommation.supplementaires %}
                            <div class="col-lg-6 mb-3">
                                <div class="product-item supplementaire p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                            <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                                <small class="text-muted">
                                                    <i class="bi bi-graph-up me-1"></i>{% trans "Quantité" %}: {{
                                                    produit_data.quantite_consommee }}
                                                </small>
                                                <small class="text-muted">
                                                    <i class="bi bi-currency-dollar me-1"></i>{{
                                                    produit_data.prix_unitaire|floatformat:2 }} DA/u
                                                </small>
                                            </div>
                                            <div class="mt-2">
                                                <span class="badge bg-warning badge-gradient">
                                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                                    {% trans "Total" %}: {{ produit_data.prix_total|floatformat:2 }} DA
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-warning fs-6">{{ produit_data.quantite_consommee
                                                }}x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Produits inclus (non facturés) - Mode facture uniquement -->
            {% if consommations %}
            <div class="card card-enhanced fade-in facture-only d-none">
                <div class="card-header bg-gradient-success text-white card-header-enhanced">
                    <h5 class="mb-0 position-relative">
                        <i class="bi bi-box me-2"></i>{% trans "Produits inclus (non facturés)" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for consommation in consommations %}
                        {% if consommation.source_inclusion != 'SUPPLEMENTAIRE' and consommation.ecart_quantite <= 0 %}
                            <div class="col-md-6 mb-3">
                            <div class="product-item p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ consommation.produit.nom }}</strong>
                                        {% if consommation.produit.code_produit %}
                                        <small class="d-block text-muted">{% trans "Code" %}: {{
                                            consommation.produit.code_produit }}</small>
                                        {% endif %}
                                        <small class="d-block text-success">
                                            {% trans "Source" %}:
                                            {% if consommation.source_inclusion == 'BLOC' %}{% trans "Inclus dans le
                                            bloc" %}
                                            {% elif consommation.source_inclusion == 'FORFAIT' %}{% trans "Inclus dans
                                            le forfait" %}
                                            {% elif consommation.source_inclusion == 'ACTE' %}{% trans "Inclus dans
                                            l'acte" %}
                                            {% endif %}
                                        </small>
                                        {% if consommation.ecart_quantite < 0 %} <small class="d-block text-success">
                                            <i class="bi bi-arrow-down me-1"></i>{% trans "Économie" %}: {{
                                            consommation.economie|floatformat:2 }} DA
                                            </small>
                                            {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success">{{ consommation.quantite|floatformat:1 }}x</span>
                                        <small class="d-block text-muted">{{ consommation.prix_unitaire|floatformat:2 }}
                                            DA/u</small>
                                    </div>
                                </div>
                            </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% if resume_consommation.totaux.economies > 0 %}
                <div class="p-3 bg-success bg-opacity-10 rounded-3 border border-success border-opacity-25">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-success mb-1">
                                <i class="bi bi-piggy-bank me-2"></i>{% trans "Économies réalisées" %}
                            </h6>
                            <small class="text-muted">{% trans "Produits non consommés ou sous-consommés" %}</small>
                        </div>
                        <div class="col-auto">
                            <div class="text-success fw-bold fs-5">{{ resume_consommation.totaux.economies|floatformat:2
                                }} DA</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Détails du forfait (mode détail uniquement) -->
        {% if location.type_tarification == 'FORFAIT' and location.forfait %}
        <div class="card card-enhanced fade-in detail-only">
            <div class="card-header bg-gradient-success text-white card-header-enhanced">
                <h5 class="mb-0 position-relative">
                    <i class="bi bi-tag me-2"></i>{% trans "Détails du forfait" %} - {{ location.forfait.nom }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-currency-dollar text-success me-2"></i>
                                <span class="fw-semibold text-muted">{% trans "Prix du forfait" %}</span>
                            </div>
                            <div class="fs-5 fw-bold text-success">{{ location.forfait.prix|floatformat:2 }} DA</div>
                        </div>
                        <div class="info-row">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-clock text-info me-2"></i>
                                <span class="fw-semibold text-muted">{% trans "Durée incluse" %}</span>
                            </div>
                            <div class="fs-5 fw-bold text-info">{{ location.forfait.duree }} minutes</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% if location.duree_reelle > location.forfait.duree %}
                        <div class="info-row">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                <span class="fw-semibold text-muted">{% trans "Dépassement" %}</span>
                            </div>
                            <div>
                                <span class="badge bg-warning badge-gradient fs-6">
                                    +{{
                                    location.duree_reelle|add:location.forfait.duree|floatformat:0|add:"-"|add:location.forfait.duree|floatformat:0
                                    }} minutes
                                </span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-plus-circle text-danger me-2"></i>
                                <span class="fw-semibold text-muted">{% trans "Supplément durée" %}</span>
                            </div>
                            <div class="fs-5 fw-bold text-danger">{{ location.prix_supplement_duree|floatformat:2 }} DA
                            </div>
                        </div>
                        {% else %}
                        <div class="info-row">
                            <div class="text-center">
                                <span class="badge bg-gradient-success badge-gradient fs-5 p-3">
                                    <i class="bi bi-check-circle me-2"></i>
                                    {% trans "Dans les limites du forfait" %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if location.forfait.description %}
                <div class="info-row mt-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-info-circle text-info me-2"></i>
                        <span class="fw-semibold text-muted">{% trans "Description" %}</span>
                    </div>
                    <div class="bg-light p-3 rounded-3">
                        {{ location.forfait.description|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Historique des modifications (mode détail uniquement) -->
        {% if location.audits.exists %}
        <div class="card card-enhanced fade-in detail-only">
            <div class="card-header bg-gradient-info text-white card-header-enhanced">
                <h5 class="mb-0 position-relative">
                    <i class="bi bi-clock-history me-2"></i>{% trans "Historique des modifications" %}
                    <span class="badge bg-light text-info ms-2">{{ location.audits.count }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% for audit in location.audits.all|slice:":5" %}
                <div class="d-flex justify-content-between align-items-start mb-3 p-3 bg-light rounded-3">
                    <div class="flex-grow-1">
                        <h6 class="mb-1 text-primary">{{ audit.champ|title }}</h6>
                        <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                            {% if audit.ancienne_valeur %}
                            <span class="badge bg-danger">{{ audit.ancienne_valeur|truncatechars:30 }}</span>
                            <i class="bi bi-arrow-right text-muted"></i>
                            {% endif %}
                            <span class="badge bg-success">{{ audit.nouvelle_valeur|truncatechars:30 }}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">
                            <strong>{{ audit.user.get_full_name|default:audit.user.username|default:"Système"
                                }}</strong>
                            <br>{{ audit.date_modification|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                </div>
                {% endfor %}
                {% if location.audits.count > 5 %}
                <div class="text-center mt-3">
                    <small class="text-muted">{% trans "Et" %} {{ location.audits.count|add:"-5" }} {% trans "autres
                        modifications..." %}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar droite -->
    <div class="col-xl-4">
        <!-- Prix final avec animation -->
        <div class="card card-enhanced fade-in">
            <div class="card-body bg-gradient-success text-white price-highlight p-4">
                <h3 class="mb-3 position-relative">
                    <i class="bi bi-currency-dollar me-2"></i>
                    <span class="detail-only">{% trans "Prix final de la location" %}</span>
                    <span class="facture-only d-none">{% trans "Total de la facture" %}</span>
                </h3>
                <h2 class="mb-3 position-relative fw-bold">{{ location.montant_total_facture|floatformat:2 }} DA</h2>
                <div class="d-flex flex-column gap-2 position-relative">
                    <small class="opacity-75">{% trans "Toutes taxes comprises" %}</small>
                    <small class="opacity-75 facture-only d-none">
                        {% trans "Facture" %} #BL-{{ location.id|stringformat:"05d" }}
                    </small>
                    {% if location.prix_supplement_duree > 0 %}
                    <small class="opacity-75 detail-only">
                        <i class="bi bi-clock me-1"></i>
                        {% trans "dont" %} {{ location.prix_supplement_duree|floatformat:2 }} DA {% trans "de supplément
                        durée" %}
                    </small>
                    {% endif %}
                    {% if location.montant_total_actes > 0 %}
                    <small class="opacity-75 detail-only">
                        <i class="bi bi-clipboard-check me-1"></i>
                        {% trans "dont" %} {{ location.montant_total_actes|floatformat:2 }} DA {% trans "d'actes" %}
                    </small>
                    {% endif %}
                    {% if location.montant_total_produits_supplementaires > 0 %}
                    <small class="opacity-75 detail-only">
                        <i class="bi bi-plus-circle me-1"></i>
                        {% trans "dont" %} {{ location.montant_total_produits_supplementaires|floatformat:2 }} DA {%
                        trans "de produits supplémentaires" %}
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card card-enhanced fade-in no-print">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-gear me-2"></i>{% trans "Actions disponibles" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'medical:location_bloc_edit' location.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-2"></i>{% trans "Modifier la location" %}
                    </a>
                    <button onclick="window.print()" class="btn btn-outline-success">
                        <i class="bi bi-printer me-2"></i>{% trans "Imprimer" %}
                    </button>
                    <button onclick="downloadPDF()" class="btn btn-outline-info">
                        <i class="bi bi-download me-2"></i>{% trans "Télécharger PDF" %}
                    </button>
                    <a href="{% url 'medical:location_bloc_send_whatsapp' location.id %}" target="_blank"
                        class="btn btn-success">
                        <i class="bi bi-whatsapp me-2"></i>{% trans "Envoyer via WhatsApp" %}
                    </a>
                    <hr>
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                        data-bs-target="#deleteModal">
                        <i class="bi bi-trash me-2"></i>{% trans "Supprimer la location" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Détail du calcul de prix -->
        {% with location.get_detail_calcul_prix as detail_prix %}
        <div class="card card-enhanced fade-in">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-calculator me-2"></i>{% trans "Détail du calcul" %}
                </h5>
            </div>
            <div class="card-body">
                {% if detail_prix.type == 'forfait' %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span>{% trans "Prix forfait" %} {{ detail_prix.forfait_nom }}</span>
                    <strong class="text-success">{{ detail_prix.prix_forfait|floatformat:2 }} DA</strong>
                </div>
                <div class="d-flex justify-content-between text-muted small py-1">
                    <span><i class="bi bi-clock me-1"></i>{% trans "Durée incluse" %}: {{ detail_prix.duree_incluse }}
                        min</span>
                    <span><i class="bi bi-stopwatch me-1"></i>{% trans "Durée utilisée" %}: {{
                        detail_prix.duree_utilisee }} min</span>
                </div>
                {% if detail_prix.avec_supplement %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span>{% trans "Supplément" %} ({{ detail_prix.tranches_supplementaires }} × 30min)</span>
                    <strong class="text-warning">+{{ detail_prix.prix_supplement_total|floatformat:2 }} DA</strong>
                </div>
                <div class="d-flex justify-content-between text-muted small py-1">
                    <span>{{ detail_prix.minutes_supplementaires }} min {% trans "supplémentaires" %}</span>
                    <span>{{ detail_prix.prix_supplement_30min|floatformat:2 }} DA/30min</span>
                </div>
                {% endif %}
                {% elif detail_prix.type == 'duree' %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span>{% trans "Prix de base" %} (90 min)</span>
                    <strong class="text-primary">{{ detail_prix.prix_base|floatformat:2 }} DA</strong>
                </div>
                {% if detail_prix.minutes_supplementaires %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span>{% trans "Supplément" %} ({{ detail_prix.tranches_supplementaires }} × 30min)</span>
                    <strong class="text-info">+{{ detail_prix.prix_supplement_total|floatformat:2 }} DA</strong>
                </div>
                <div class="d-flex justify-content-between text-muted small py-1">
                    <span>{{ detail_prix.minutes_supplementaires }} min {% trans "supplémentaires" %}</span>
                    <span>{{ detail_prix.prix_supplement_30min|floatformat:2 }} DA/30min</span>
                </div>
                {% endif %}
                {% endif %}

                {% if detail_prix.montant_actes > 0 %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span><i class="bi bi-clipboard-check me-1"></i>{% trans "Actes supplémentaires" %}</span>
                    <strong class="text-primary">{{ detail_prix.montant_actes|floatformat:2 }} DA</strong>
                </div>
                {% endif %}

                {% if resume_consommation.totaux.ecarts_produits > 0 %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span><i class="bi bi-plus-circle me-1"></i>{% trans "Suppléments produits inclus" %}</span>
                    <strong class="text-danger">{{ resume_consommation.totaux.ecarts_produits|floatformat:2 }}
                        DA</strong>
                </div>
                {% endif %}

                {% if resume_consommation.totaux.economies > 0 %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span><i class="bi bi-dash-circle me-1"></i>{% trans "Économies produits" %}</span>
                    <strong class="text-success">-{{ resume_consommation.totaux.economies|floatformat:2 }} DA</strong>
                </div>
                {% endif %}

                {% if detail_prix.montant_produits_supplementaires > 0 %}
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <span><i class="bi bi-box me-1"></i>{% trans "Produits supplémentaires" %}</span>
                    <strong class="text-warning">{{ detail_prix.montant_produits_supplementaires|floatformat:2 }}
                        DA</strong>
                </div>
                {% endif %}

                <div class="d-flex justify-content-between align-items-center py-3 border-top mt-2">
                    <strong class="fs-5">{% trans "Total facturé" %}</strong>
                    <strong class="fs-4 text-success">{{ detail_prix.montant_total|floatformat:2 }} DA</strong>
                </div>
            </div>
        </div>
        {% endwith %}
    </div>
</div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2 text-danger"></i>{% trans "Confirmer la suppression" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="lead">{% trans "Êtes-vous sûr de vouloir supprimer cette location de bloc ?" %}</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{% trans "Attention" %} :</strong> {% trans "Cette action est irréversible et supprimera
                    toutes les données associées." %}
                </div>
                <div class="bg-light p-4 rounded-3">
                    <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>{% trans "Détails de la location" %} :</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>{% trans "Acte" %} :</strong> {{ location.nom_acte|default:"Non spécifié" }}<br>
                            <strong>{% trans "Patient" %} :</strong> {{ location.patient.nom_complet }}<br>
                            <strong>{% trans "Date" %} :</strong> {{ location.date_operation|date:"d/m/Y" }}<br>
                        </div>
                        <div class="col-md-6">
                            <strong>{% trans "Bloc" %} :</strong> {{ location.bloc.nom_bloc }}<br>
                            <strong>{% trans "Durée" %} :</strong> {{ location.duree_reelle|default:"Non définie" }}
                            min<br>
                            <strong>{% trans "Montant" %} :</strong> {{ location.montant_total_facture|floatformat:2 }}
                            DA
                        </div>
                    </div>
                </div>

                <!-- Données qui seront supprimées -->
                <div class="mt-4">
                    <h6 class="text-danger"><i class="bi bi-trash me-2"></i>{% trans "Données qui seront supprimées" %}
                        :</h6>
                    <ul class="list-unstyled">
                        {% if location.actes_location.exists %}
                        <li><i class="bi bi-clipboard-check me-2 text-danger"></i>{{ location.actes_location.count }} {%
                            trans "acte(s) associé(s)" %}</li>
                        {% endif %}
                        {% if consommations %}
                        <li><i class="bi bi-box me-2 text-danger"></i>{{ consommations|length }} {% trans
                            "consommation(s) de produits" %}</li>
                        {% endif %}
                        {% if location.audits.exists %}
                        <li><i class="bi bi-clock-history me-2 text-danger"></i>{{ location.audits.count }} {% trans
                            "entrée(s) d'historique" %}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-2"></i>{% trans "Annuler" %}
                </button>
                <form method="post" action="{% url 'medical:location_bloc_delete' location.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>{% trans "Supprimer définitivement" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Configuration Bootstrap 5
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Utilitaire pour les notifications Toast
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toast = createToastElement(message, type);
            toastContainer.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toastContainer.removeChild(toast);
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        function createToastElement(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
            return toast;
        }

        // Fonction de téléchargement PDF optimisée
        window.downloadPDF = function () {
            showToast('{% trans "Préparation du téléchargement PDF..." %}', 'info');

            const url = "{% url 'medical:location_bloc_export_pdf' location.id %}";

            // Utilisation de fetch pour une meilleure gestion des erreurs
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur réseau');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = `Facture_BL-{{ location.id|stringformat:"05d" }}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(link.href);
                    showToast('{% trans "Téléchargement réussi." %}', 'success');
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showToast('{% trans "Erreur lors du téléchargement PDF." %}', 'danger');
                });
        };

        // Fonctions pour marquer les règlements
        window.marquerReglementSurplus = function (locationId) {
            if (confirm('{% trans "Confirmer que le surplus a été versé au médecin ?" %}')) {
                fetch(`/medical/location/${locationId}/reglement-surplus/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('{% trans "Surplus marqué comme versé." %}', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast('{% trans "Erreur lors de la mise à jour." %}', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast('{% trans "Erreur de communication." %}', 'danger');
                    });
            }
        };

        window.marquerReglementComplement = function (locationId) {
            if (confirm('{% trans "Confirmer que le complément a été payé par le médecin ?" %}')) {
                fetch(`/medical/location/${locationId}/reglement-complement/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('{% trans "Complément marqué comme payé." %}', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast('{% trans "Erreur lors de la mise à jour." %}', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast('{% trans "Erreur de communication." %}', 'danger');
                    });
            }
        };

        // Animation d'entrée progressive pour les cartes
        const cards = document.querySelectorAll('.card-enhanced');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });

        // Amélioration de la confirmation de suppression avec double-clic
        const deleteButton = document.querySelector('#deleteModal .btn-danger[type="submit"]');
        if (deleteButton) {
            let clickCount = 0;
            const originalText = deleteButton.innerHTML;

            deleteButton.addEventListener('click', function (e) {
                clickCount++;
                if (clickCount === 1) {
                    e.preventDefault();
                    this.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>{% trans "Cliquez encore pour confirmer" %}';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-warning');

                    setTimeout(() => {
                        clickCount = 0;
                        this.innerHTML = originalText;
                        this.classList.remove('btn-warning');
                        this.classList.add('btn-danger');
                    }, 3000);
                }
            });
        }

        // Smooth scroll pour les liens internes
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Auto-dismiss des alertes après 10 secondes
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                if (bsAlert) {
                    bsAlert.close();
                }
            });
        }, 10000);

        // Amélioration des interactions hover pour les cartes
        const interactiveCards = document.querySelectorAll('.card-enhanced');
        interactiveCards.forEach(card => {
            card.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-4px)';
            });

            card.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(-2px)';
            });
        });

        // Gestion du focus pour l'accessibilité
        const focusableElements = document.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        focusableElements.forEach(element => {
            element.addEventListener('focus', function () {
                this.style.outline = '2px solid var(--bs-primary)';
                this.style.outlineOffset = '2px';
            });

            element.addEventListener('blur', function () {
                this.style.outline = '';
                this.style.outlineOffset = '';
            });
        });

        // Optimisation pour l'impression
        window.addEventListener('beforeprint', function () {
            document.querySelectorAll('.detail-only').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.facture-only').forEach(el => {
                el.style.display = 'none';
            });
        });

        window.addEventListener('afterprint', function () {
            document.querySelectorAll('.detail-only').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.facture-only').forEach(el => {
                el.style.display = 'none';
            });
        });

        // Gestion des états de chargement pour les boutons
        const actionButtons = document.querySelectorAll('.btn:not([data-bs-toggle])');
        actionButtons.forEach(button => {
            if (button.onclick || button.href) {
                button.addEventListener('click', function () {
                    if (!this.classList.contains('btn-secondary')) {
                        const originalContent = this.innerHTML;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{% trans "Chargement..." %}';
                        this.disabled = true;

                        setTimeout(() => {
                            this.innerHTML = originalContent;
                            this.disabled = false;
                        }, 2000);
                    }
                });
            }
        });

        console.log('{% trans "Interface optimisée chargée avec succès" %}');
    });
</script>

{% endblock %}