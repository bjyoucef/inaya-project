{% extends "layout.html" %}
{% load static custom_filters_medical i18n %}

{% block content %}
<style>
    :root {
        --primary-color: #2563eb;
        --primary-light: #3b82f6;
        --success-color: #10b981;
        --success-light: #059669;
        --warning-color: #f59e0b;
        --warning-light: #d97706;
        --danger-color: #ef4444;
        --info-color: #06b6d4;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
    }

    body {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--gray-800);
        line-height: 1.6;
    }

    .main-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    /* Header unifié */
    .unified-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        border-radius: 1.25rem;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
    }

    .unified-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(100px, -100px);
    }

    .unified-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.75rem;
        letter-spacing: -0.025em;
        position: relative;
        z-index: 1;
    }

    .unified-header .subtitle {
        opacity: 0.9;
        font-size: 1.125rem;
        position: relative;
        z-index: 1;
    }

    .header-actions {
        position: relative;
        z-index: 1;
    }

    .btn-header {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        backdrop-filter: blur(10px);
        transition: all 0.3s;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        margin: 0 0.25rem;
    }

    .btn-header:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    /* Cards */
    .detail-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        margin-bottom: 2rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
    }

    .detail-header {
        background: linear-gradient(135deg, var(--gray-800), var(--gray-700));
        color: white;
        padding: 1.75rem 2rem;
        position: relative;
        overflow: hidden;
    }

    .detail-header.bg-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    }

    .detail-header.bg-success {
        background: linear-gradient(135deg, var(--success-color), var(--success-light));
    }

    .detail-header.bg-info {
        background: linear-gradient(135deg, var(--info-color), #0891b2);
    }

    .detail-header.bg-warning {
        background: linear-gradient(135deg, var(--warning-color), var(--warning-light));
    }

    .detail-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 150px;
        height: 150px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }

    .detail-header h4,
    .detail-header h5 {
        position: relative;
        z-index: 1;
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .detail-header p {
        position: relative;
        z-index: 1;
        opacity: 0.9;
        margin-bottom: 0;
    }

    /* Info rows */
    .info-row {
        padding: 1.25rem 0;
        border-bottom: 1px solid var(--gray-100);
        transition: all 0.2s;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-row:hover {
        background: var(--gray-50);
        margin: 0 -2rem;
        padding-left: 2rem;
        padding-right: 2rem;
        border-radius: 0.5rem;
    }

    .info-label {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-value {
        font-size: 1.1rem;
        color: var(--gray-900);
        font-weight: 500;
    }

    /* Facture table */
    .facture-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .facture-table th {
        background: var(--gray-100);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border: 1px solid var(--gray-200);
    }

    .facture-table td {
        padding: 1rem;
        border: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .facture-table tbody tr:hover {
        background: var(--gray-50);
    }

    .facture-table tfoot td {
        background: var(--gray-100);
        font-weight: 700;
    }

    /* Status badges */
    .status-badge-large {
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
        border-radius: 2rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-sm);
    }

    .duration-badge {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 2rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-sm);
    }

    /* Product items */
    .product-item,
    .acte-item {
        background: linear-gradient(135deg, var(--gray-50), white);
        border: 1px solid var(--gray-200);
        border-radius: 1rem;
        padding: 1.25rem;
        margin: 0.75rem 0;
        border-left: 4px solid var(--success-color);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .product-item:hover,
    .acte-item:hover {
        background: white;
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
        border-left-color: var(--primary-color);
    }

    .product-item.supplementaire {
        border-left-color: var(--warning-color);
    }

    .product-item.economy {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #f0fdf4, white);
    }

    .product-item.surcharge {
        border-left-color: var(--danger-color);
        background: linear-gradient(135deg, #fef2f2, white);
    }

    /* Price highlight */
    .price-highlight {
        background: linear-gradient(135deg, var(--success-color), var(--success-light));
        color: white;
        padding: 2.5rem;
        border-radius: 1.25rem;
        text-align: center;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
    }

    .price-highlight::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .price-highlight h2,
    .price-highlight h3 {
        position: relative;
        z-index: 1;
        font-weight: 900;
        margin-bottom: 1rem;
    }

    .price-highlight small {
        position: relative;
        z-index: 1;
        opacity: 0.9;
    }

    /* Badges */
    .badge {
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .badge.bg-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light)) !important;
    }

    .badge.bg-success {
        background: linear-gradient(135deg, var(--success-color), var(--success-light)) !important;
    }

    .badge.bg-warning {
        background: linear-gradient(135deg, var(--warning-color), var(--warning-light)) !important;
    }

    .badge.bg-info {
        background: linear-gradient(135deg, var(--info-color), #0891b2) !important;
    }

    .badge.bg-danger {
        background: linear-gradient(135deg, var(--danger-color), #dc2626) !important;
    }

    /* Buttons */
    .btn {
        border-radius: 0.75rem;
        font-weight: 600;
        padding: 0.875rem 1.75rem;
        transition: all 0.3s;
        border: none;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }

    .btn-outline-primary:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
    }

    .btn-outline-success {
        border: 2px solid var(--success-color);
        color: var(--success-color);
        background: transparent;
    }

    .btn-outline-success:hover {
        background: var(--success-color);
        color: white;
        transform: translateY(-2px);
    }

    .btn-outline-danger {
        border: 2px solid var(--danger-color);
        color: var(--danger-color);
        background: transparent;
    }

    .btn-outline-danger:hover {
        background: var(--danger-color);
        color: white;
        transform: translateY(-2px);
    }

    /* Mode d'affichage */
    .view-mode-switch {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2rem;
        padding: 0.5rem;
        display: inline-flex;
        gap: 0.25rem;
    }

    .view-mode-btn {
        padding: 0.5rem 1rem;
        border-radius: 1.5rem;
        background: transparent;
        color: white;
        border: none;
        font-weight: 600;
        transition: all 0.3s;
        cursor: pointer;
    }

    .view-mode-btn.active {
        background: rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-sm);
    }

    /* Mode facture spécifique */
    .facture-mode .detail-card {
        page-break-inside: avoid;
    }

    .facture-mode .no-print {
        display: none !important;
    }

    /* Utility classes */
    .text-primary {
        color: var(--primary-color) !important;
    }

    .text-success {
        color: var(--success-color) !important;
    }

    .text-warning {
        color: var(--warning-color) !important;
    }

    .text-danger {
        color: var(--danger-color) !important;
    }

    .text-info {
        color: var(--info-color) !important;
    }

    .text-muted {
        color: var(--gray-500) !important;
    }

    .bg-light-custom {
        background: linear-gradient(135deg, var(--gray-50), white) !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .main-container {
            padding: 1rem;
        }

        .unified-header {
            padding: 2rem 1.5rem;
        }

        .unified-header h1 {
            font-size: 2rem;
        }

        .detail-card .card-body {
            padding: 1.5rem;
        }

        .header-actions {
            margin-top: 1rem;
        }

        .btn-header {
            margin: 0.25rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }

        .facture-table {
            font-size: 0.875rem;
        }

        .facture-table th,
        .facture-table td {
            padding: 0.75rem 0.5rem;
        }
    }

    /* Animations */
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Print styles */
    @media print {
        .no-print {
            display: none !important;
        }

        .main-container {
            padding: 0;
            max-width: none;
        }

        .detail-card {
            box-shadow: none;
            border: 1px solid #ddd;
            margin-bottom: 1rem;
            page-break-inside: avoid;
        }

        .unified-header {
            background: #2563eb !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }

        .price-highlight {
            background: #10b981 !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
    }

    /* Montant indicators */
    .montant-economie {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        color: #166534;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 700;
    }

    .montant-supplement {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 700;
    }
</style>

<div class="main-container">
    <!-- En-tête unifié -->
    <div class="unified-header fade-in">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1>
                    <i class="bi bi-building me-3"></i>
                    <span id="page-title">{% trans "Détail Location de Bloc" %}</span>
                </h1>
                <p class="subtitle">
                    {{ location.bloc.nom_bloc }} - {{ location.date_operation|date:"l d F Y" }}
                    <span class="ms-3">
                        <i class="bi bi-file-earmark-text"></i>
                        {% trans "Facture" %} #BL-{{ location.id|stringformat:"05d" }}
                    </span>
                </p>
            </div>
            <div class="col-lg-4">
                <div class="header-actions text-end">
                    <!-- Mode switch -->
                    <div class="view-mode-switch mb-3 no-print">
                        <button class="view-mode-btn active" data-mode="detail" id="detail-mode-btn">
                            <i class="bi bi-info-circle me-1"></i>{% trans "Détail" %}
                        </button>
                        <button class="view-mode-btn" data-mode="facture" id="facture-mode-btn">
                            <i class="bi bi-file-earmark-text me-1"></i>{% trans "Facture" %}
                        </button>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex flex-wrap justify-content-end gap-2">
                        <button onclick="window.print()" class="btn-header">
                            <i class="bi bi-printer me-2"></i>{% trans "Imprimer" %}
                        </button>
                        <button onclick="downloadPDF()" class="btn btn-outline-info">
                            <i class="bi bi-download me-2"></i>{% trans "Télécharger PDF" %}
                        </button>
                        <a href="{% url 'medical:location_bloc_send_whatsapp' location.id %}" target="_blank"
                            class="btn btn-success">
                            <i class="bi bi-whatsapp me-2"></i>{% trans "Envoyer via WhatsApp" %}
                        </a>
                        <hr>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                            data-bs-target="#deleteModal">
                            <i class="bi bi-trash me-2"></i>{% trans "Supprimer la location" %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Détail du calcul de prix -->
            {% with location.get_detail_calcul_prix as detail_prix %}
            <div class="detail-card fade-in">
                <div class="detail-header bg-light-custom text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-calculator me-2"></i>{% trans "Détail du calcul" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if detail_prix.type == 'forfait' %}
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span>{% trans "Prix forfait" %} {{ detail_prix.forfait_nom }}</span>
                        <strong class="text-success">{{ detail_prix.prix_forfait|floatformat:2 }} DA</strong>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span><i class="bi bi-clock me-1"></i>{% trans "Durée incluse" %}: {{ detail_prix.duree_incluse
                            }} min</span>
                        <span><i class="bi bi-stopwatch me-1"></i>{% trans "Durée utilisée" %}: {{
                            detail_prix.duree_utilisee }} min</span>
                    </div>
                    {% if detail_prix.avec_supplement %}
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span>{% trans "Supplément" %} ({{ detail_prix.tranches_supplementaires }} × 30min)</span>
                        <strong class="text-warning">+{{ detail_prix.prix_supplement_total|floatformat:2 }} DA</strong>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>{{ detail_prix.minutes_supplementaires }} min {% trans "supplémentaires" %}</span>
                        <span>{{ detail_prix.prix_supplement_30min|floatformat:2 }} DA/30min</span>
                    </div>
                    {% endif %}
                    {% elif detail_prix.type == 'duree' %}
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span>{% trans "Prix de base" %} (90 min)</span>
                        <strong class="text-primary">{{ detail_prix.prix_base|floatformat:2 }} DA</strong>
                    </div>
                    {% if detail_prix.minutes_supplementaires %}
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span>{% trans "Supplément" %} ({{ detail_prix.tranches_supplementaires }} × 30min)</span>
                        <strong class="text-info">+{{ detail_prix.prix_supplement_total|floatformat:2 }} DA</strong>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>{{ detail_prix.minutes_supplementaires }} min {% trans "supplémentaires" %}</span>
                        <span>{{ detail_prix.prix_supplement_30min|floatformat:2 }} DA/30min</span>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if detail_prix.montant_actes > 0 %}
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-clipboard-check me-1"></i>{% trans "Actes supplémentaires" %}</span>
                        <strong class="text-primary">{{ detail_prix.montant_actes|floatformat:2 }} DA</strong>
                    </div>
                    {% endif %}

                    {% if resume_consommation.totaux.ecarts_produits > 0 %}
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-plus-circle me-1"></i>{% trans "Suppléments produits inclus" %}</span>
                        <strong class="text-danger">{{ resume_consommation.totaux.ecarts_produits|floatformat:2 }}
                            DA</strong>
                    </div>
                    {% endif %}

                    {% if resume_consommation.totaux.economies > 0 %}
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-dash-circle me-1"></i>{% trans "Économies produits" %}</span>
                        <strong class="text-success">-{{ resume_consommation.totaux.economies|floatformat:2 }}
                            DA</strong>
                    </div>
                    {% endif %}

                    {% if detail_prix.montant_produits_supplementaires > 0 %}
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span><i class="bi bi-box me-1"></i>{% trans "Produits supplémentaires" %}</span>
                        <strong class="text-warning">{{ detail_prix.montant_produits_supplementaires|floatformat:2 }}
                            DA</strong>
                    </div>
                    {% endif %}

                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <strong class="fs-5">{% trans "Total facturé" %}</strong>
                        <strong class="fs-4 text-success">{{ detail_prix.montant_total|floatformat:2 }} DA</strong>
                    </div>
                </div>
            </div>
            {% endwith %}
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2 text-danger"></i>{% trans "Confirmer la suppression" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="lead">{% trans "Êtes-vous sûr de vouloir supprimer cette location de bloc ?" %}</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{% trans "Attention" %} :</strong> {% trans "Cette action est irréversible et supprimera
                    toutes les données associées." %}
                </div>
                <div class="bg-light-custom p-4 rounded-3">
                    <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>{% trans "Détails de la location" %} :</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>{% trans "Acte" %} :</strong> {{ location.nom_acte|default:"Non spécifié" }}<br>
                            <strong>{% trans "Patient" %} :</strong> {{ location.patient.nom_complet }}<br>
                            <strong>{% trans "Date" %} :</strong> {{ location.date_operation|date:"d/m/Y" }}<br>
                        </div>
                        <div class="col-md-6">
                            <strong>{% trans "Bloc" %} :</strong> {{ location.bloc.nom_bloc }}<br>
                            <strong>{% trans "Durée" %} :</strong> {{ location.duree_reelle|default:"Non définie" }}
                            min<br>
                            <strong>{% trans "Montant" %} :</strong> {{ location.montant_total_facture|floatformat:2 }}
                            DA
                        </div>
                    </div>
                </div>

                <!-- Données qui seront supprimées -->
                <div class="mt-4">
                    <h6 class="text-danger"><i class="bi bi-trash me-2"></i>{% trans "Données qui seront supprimées" %}
                        :</h6>
                    <ul class="list-unstyled">
                        {% if location.actes_location.exists %}
                        <li><i class="bi bi-clipboard-check me-2 text-danger"></i>{{ location.actes_location.count }} {%
                            trans "acte(s) associé(s)" %}</li>
                        {% endif %}
                        {% if consommations %}
                        <li><i class="bi bi-box me-2 text-danger"></i>{{ consommations|length }} {% trans
                            "consommation(s) de produits" %}</li>
                        {% endif %}
                        {% if location.audits.exists %}
                        <li><i class="bi bi-clock-history me-2 text-danger"></i>{{ location.audits.count }} {% trans
                            "entrée(s) d'historique" %}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-2"></i>{% trans "Annuler" %}
                </button>
                <form method="post" action="{% url 'medical:location_bloc_delete' location.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>{% trans "Supprimer définitivement" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Gestion des modes d'affichage
        const detailModeBtn = document.getElementById('detail-mode-btn');
        const factureModeBtn = document.getElementById('facture-mode-btn');
        const pageTitle = document.getElementById('page-title');
        const body = document.body;

        function switchToDetailMode() {
            // Activer le bouton détail
            detailModeBtn.classList.add('active');
            factureModeBtn.classList.remove('active');

            // Changer le titre
            pageTitle.textContent = '{% trans "Détail Location de Bloc" %}';

            // Afficher/masquer les éléments
            document.querySelectorAll('.detail-only').forEach(el => {
                el.style.display = '';
            });
            document.querySelectorAll('.facture-only').forEach(el => {
                el.style.display = 'none';
            });

            // Retirer la classe facture-mode
            body.classList.remove('facture-mode');
        }

        function switchToFactureMode() {
            // Activer le bouton facture
            factureModeBtn.classList.add('active');
            detailModeBtn.classList.remove('active');

            // Changer le titre
            pageTitle.textContent = '{% trans "Facture - Location de Bloc" %}';

            // Afficher/masquer les éléments
            document.querySelectorAll('.detail-only').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.facture-only').forEach(el => {
                el.style.display = '';
            });

            // Ajouter la classe facture-mode
            body.classList.add('facture-mode');
        }

        // Event listeners pour les boutons de mode
        detailModeBtn.addEventListener('click', switchToDetailMode);
        factureModeBtn.addEventListener('click', switchToFactureMode);

        // Notifications
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
            toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
            document.body.appendChild(toast);

            if (window.bootstrap && bootstrap.Toast) {
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                toast.addEventListener('hidden.bs.toast', () => {
                    document.body.removeChild(toast);
                });
            }
        }

        // Fonction pour télécharger le PDF
        window.downloadPDF = function () {
            const url = "{% url 'medical:location_bloc_export_pdf' location.id %}";
            showNotification('{% trans "Préparation du téléchargement PDF..." %}', 'info');

            try {
                const link = document.createElement('a');
                link.href = url;
                link.download = `Facture_BL-{{ location.id|stringformat:"05d" }}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('{% trans "Téléchargement lancé." %}', 'success');
            } catch (err) {
                showNotification('{% trans "Erreur lors du téléchargement PDF." %}', 'danger');
            }
        };

        // Animation d'entrée progressive pour les cards
        const cards = document.querySelectorAll('.detail-card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });

        // Smooth scroll pour les liens internes
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Tooltip pour les badges
        const badges = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        badges.forEach(badge => {
            if (window.bootstrap && bootstrap.Tooltip) {
                new bootstrap.Tooltip(badge);
            }
        });

        // Confirmation avant suppression avec double-clic
        const deleteButton = document.querySelector('#deleteModal .btn-danger[type="submit"]');
        if (deleteButton) {
            let clickCount = 0;
            deleteButton.addEventListener('click', function (e) {
                clickCount++;
                if (clickCount === 1) {
                    e.preventDefault();
                    this.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>{% trans "Cliquez encore pour confirmer" %}';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-warning');

                    setTimeout(() => {
                        clickCount = 0;
                        this.innerHTML = '<i class="bi bi-trash me-2"></i>{% trans "Supprimer définitivement" %}';
                        this.classList.remove('btn-warning');
                        this.classList.add('btn-danger');
                    }, 3000);
                }
            });
        }

        // Fonction pour copier les détails dans le presse-papiers
        window.copyDetails = function () {
            const details = `
Location de Bloc - {{ location.bloc.nom_bloc }}
Date: {{ location.date_operation|date:"d/m/Y" }}
Patient: {{ location.patient.nom_complet }}
Médecin: Dr. {{ location.medecin.nom_complet }}
Durée: {{ location.duree_reelle|default:"--" }} minutes
Total: {{ location.montant_total_facture|floatformat:2 }} DA
        `.trim();

            navigator.clipboard.writeText(details).then(() => {
                showNotification('{% trans "Détails copiés dans le presse-papiers" %}', 'success');
            });
        };

        // Impression optimisée
        window.addEventListener('beforeprint', function () {
            // Basculer automatiquement en mode facture pour l'impression
            if (!body.classList.contains('facture-mode')) {
                switchToFactureMode();
                // Flag pour revenir au mode précédent après impression
                window.wasInDetailMode = true;
            }
        });

        window.addEventListener('afterprint', function () {
            // Revenir au mode détail si on y était avant
            if (window.wasInDetailMode) {
                switchToDetailMode();
                window.wasInDetailMode = false;
            }
        });

        // Raccourcis clavier
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'p':
                        e.preventDefault();
                        window.print();
                        break;
                    case 'd':
                        e.preventDefault();
                        switchToDetailMode();
                        break;
                    case 'f':
                        e.preventDefault();
                        switchToFactureMode();
                        break;
                    case 's':
                        e.preventDefault();
                        window.downloadPDF();
                        break;
                }
            }
        });

        // Auto-dismiss des alertes après 5 secondes
        setTimeout(function () {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function (alert) {
                if (window.bootstrap && bootstrap.Alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            });
        }, 5000);
    });
</script>

{% endblock %}="btn-header">
<i class="bi bi-download me-2"></i>{% trans "PDF" %}
</button>
<a href="{% url 'medical:location_bloc_send_whatsapp' location.id %}" target="_blank" class="btn-header">
    <i class="bi bi-whatsapp me-2"></i>{% trans "WhatsApp" %}
</a>
<a href="{% url 'medical:location_bloc_list' %}" class="btn-header">
    <i class="bi bi-arrow-left me-2"></i>{% trans "Retour" %}
</a>
</div>
</div>
</div>
</div>
</div>

<div class="row g-4">
    <!-- Colonne principale -->
    <div class="col-xl-8 col-lg-7">

        <!-- Informations principales -->
        <div class="detail-card fade-in">
            <div class="detail-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-2">{{ location.nom_acte|default:"Intervention chirurgicale" }}</h4>
                        <p class="mb-0">
                            <i class="bi bi-calendar-event me-2"></i>{{ location.date_operation|date:"l d F Y" }}
                            {% if location.heure_operation %}
                            <i class="bi bi-clock ms-3 me-2"></i>{{ location.heure_operation|time:"H:i" }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-auto">
                        {% if location.duree_reelle %}
                        <span class="duration-badge">
                            <i class="bi bi-stopwatch"></i>{{ location.duree_reelle }} min
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person-circle text-primary"></i>
                                {% trans "Patient" %}
                            </div>
                            <div class="info-value">
                                <a href="{% url 'patients:patient_detail' location.patient.id %}"
                                    class="text-decoration-none text-primary fw-bold">
                                    {{ location.patient.nom_complet }}
                                </a>
                                {% if location.patient.date_naissance %}
                                <small class="d-block text-muted">{{ location.patient.date_naissance|date:"d/m/Y"
                                    }}</small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-person-badge text-success"></i>
                                {% trans "Médecin responsable" %}
                            </div>
                            <div class="info-value">
                                Dr. {{ location.medecin.nom_complet }}
                                {% if location.medecin.specialite %}
                                <small class="d-block text-muted">{{ location.medecin.specialite }}</small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-building text-info"></i>
                                {% trans "Bloc opératoire" %}
                            </div>
                            <div class="info-value">
                                {{ location.bloc.nom_bloc }}
                                <small class="d-block text-muted">
                                    {% trans "Tarif" %}: {{ location.bloc.prix_base|floatformat:2 }} DA (90 min)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-gear text-primary"></i>
                                {% trans "Type de tarification" %}
                            </div>
                            <div class="info-value">
                                {% if location.type_tarification == 'FORFAIT' %}
                                <span class="badge bg-success">
                                    <i class="bi bi-tag"></i>{% trans "Forfaitaire" %}
                                </span>
                                {% if location.forfait %}
                                <div class="mt-1">
                                    <strong>{{ location.forfait.nom }}</strong>
                                    <small class="d-block text-muted">{{ location.forfait.description|truncatechars:100
                                        }}</small>
                                </div>
                                {% endif %}
                                {% else %}
                                <span class="badge bg-primary">
                                    <i class="bi bi-clock"></i>{% trans "À la durée" %}
                                </span>
                                <small class="d-block text-muted mt-1">{% trans "Prix calculé selon le temps
                                    d'utilisation réel" %}</small>
                                {% endif %}
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-label">
                                <i class="bi bi-stopwatch text-warning"></i>
                                {% trans "Durée d'intervention" %}
                            </div>
                            <div class="info-value">
                                {% if location.duree_reelle %}
                                <span class="duration-badge">
                                    <i class="bi bi-stopwatch"></i>{{ location.duree_reelle }} min ({% trans "réelle"
                                    %})
                                </span>
                                <small class="d-block text-muted mt-1">
                                    {% if location.type_tarification == 'FORFAIT' and location.forfait %}
                                    {% trans "Forfait" %}: {{ location.forfait.duree }} min {% trans "incluses" %}
                                    {% else %}
                                    {% trans "Base" %}: 90 min {% trans "incluses" %}
                                    {% endif %}
                                </small>
                                {% elif location.duree_prevue %}
                                <span class="badge bg-info">
                                    <i class="bi bi-clock-history"></i>{{ location.duree_prevue }} min ({% trans
                                    "prévue" %})
                                </span>
                                {% else %}
                                <span class="text-muted">{% trans "Non définie" %}</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="info-row detail-only">
                            <div class="info-label">
                                <i class="bi bi-person text-muted"></i>
                                {% trans "Créé par" %}
                            </div>
                            <div class="info-value">
                                {{ location.cree_par.get_full_name|default:location.cree_par.username|default:"Système"
                                }}
                                <small class="d-block text-muted">{{ location.date_creation|date:"d/m/Y à H:i"
                                    }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                {% if location.observations %}
                <div class="info-row mt-4 detail-only">
                    <div class="info-label">
                        <i class="bi bi-chat-text text-info"></i>
                        {% trans "Observations" %}
                    </div>
                    <div class="info-value">
                        <div class="bg-light-custom p-3 rounded-3">
                            {{ location.observations|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Détail des prestations - Table facture -->
        <div class="detail-card fade-in">
            <div class="detail-header bg-primary">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    <span class="detail-only">{% trans "Actes et prestations" %}</span>
                    <span class="facture-only" style="display: none;">{% trans "Détail des prestations" %}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="facture-table">
                        <thead>
                            <tr>
                                <th>{% trans "Description" %}</th>
                                <th>{% trans "Détail" %}</th>
                                <th class="text-center">{% trans "Quantité" %}</th>
                                <th class="text-end">{% trans "Prix unitaire" %}</th>
                                <th class="text-end">{% trans "Montant" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Prestation principale -->
                            <tr>
                                <td>
                                    <strong>
                                        {% if location.type_tarification == 'FORFAIT' %}
                                        {% trans "Forfait" %} {{ location.forfait.nom }}
                                        {% else %}
                                        {% trans "Location bloc" %} {{ location.bloc.nom_bloc }}
                                        {% endif %}
                                    </strong>
                                </td>
                                <td>
                                    {% if location.type_tarification == 'FORFAIT' %}
                                    {% if location.duree_reelle > location.forfait.duree %}
                                    {{ location.forfait.duree }} min {% trans "incluses" %} + {{
                                    location.duree_reelle|add:location.forfait.duree|floatformat:0|add:"-"|add:location.forfait.duree|floatformat:0
                                    }} min {% trans "supp." %}
                                    {% else %}
                                    {{ location.forfait.duree }} min {% trans "incluses" %}
                                    {% endif %}
                                    {% else %}
                                    {% if location.duree_reelle > 90 %}
                                    90 min {% trans "incluses" %} + {{ location.duree_reelle|add:"-90" }} min {% trans
                                    "supp." %}
                                    {% else %}
                                    {{ location.duree_reelle|default:90 }} min d'utilisation
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-center">1</td>
                                <td class="text-end">{{ location.prix_final|floatformat:2 }} DA</td>
                                <td class="text-end"><strong>{{ location.prix_final|floatformat:2 }} DA</strong></td>
                            </tr>

                            <!-- Actes supplémentaires -->
                            {% for acte_location in location.actes_location.all %}
                            <tr>
                                <td>
                                    <strong>{{ acte_location.acte.nom }}</strong>
                                    <small class="d-block text-muted">{% trans "Acte supplémentaire" %}</small>
                                </td>
                                <td>{{ acte_location.acte.description|truncatechars:60|default:"Acte médical spécialisé"
                                    }}</td>
                                <td class="text-center">{{ acte_location.quantite }}</td>
                                <td class="text-end">{{ acte_location.prix_unitaire|floatformat:2 }} DA</td>
                                <td class="text-end"><strong>{{ acte_location.prix_total|floatformat:2 }} DA</strong>
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Produits supplémentaires ou avec écart -->
                            {% for consommation in consommations %}
                            {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' or consommation.ecart_quantite > 0
                            %}
                            <tr>
                                <td>
                                    <strong>{{ consommation.produit.nom }}</strong>
                                    {% if consommation.produit.code_produit %}
                                    <small class="d-block text-muted">{% trans "Code" %}: {{
                                        consommation.produit.code_produit }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' %}
                                    <span class="badge bg-warning">{% trans "Produit supplémentaire" %}</span>
                                    {% else %}
                                    <span class="badge bg-danger">{% trans "Supplément de consommation" %}</span>
                                    <small class="d-block text-muted">{% trans "Écart" %}: +{{
                                        consommation.ecart_quantite|floatformat:1 }} ({% trans "Inclus" %}: {{
                                        consommation.quantite_incluse|floatformat:1 }})</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' %}
                                    {{ consommation.quantite|floatformat:1 }}
                                    {% else %}
                                    {{ consommation.ecart_quantite|floatformat:1 }}
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ consommation.prix_unitaire|floatformat:2 }} DA</td>
                                <td class="text-end">
                                    <strong>
                                        {% if consommation.source_inclusion == 'SUPPLEMENTAIRE' %}
                                        {{ consommation.prix_total|floatformat:2 }} DA
                                        {% else %}
                                        {{ consommation.prix_facturable|floatformat:2 }} DA
                                        {% endif %}
                                    </strong>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end fw-bold">{% trans "TOTAL À PAYER (TTC)" %}</td>
                                <td class="text-end"><strong class="fs-5 text-primary">{{
                                        location.montant_total_facture|floatformat:2 }} DA</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Consommation détaillée des produits (mode détail uniquement) -->
        <div class="detail-card fade-in detail-only">
            <div class="detail-header bg-info">
                <h5 class="mb-0">
                    <i class="bi bi-box me-2"></i>{% trans "Consommation détaillée des produits" %}
                    <span class="badge bg-light text-info ms-2">{{ consommations|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- Produits inclus dans le bloc -->
                {% if resume_consommation.bloc %}
                <div class="product-list mb-4">
                    <h6 class="mb-3">
                        <i class="bi bi-building text-primary"></i>
                        {% trans "Produits inclus dans le bloc" %} ({{ resume_consommation.bloc|length }})
                    </h6>
                    <div class="row">
                        {% for produit_data in resume_consommation.bloc %}
                        <div class="col-lg-6">
                            <div
                                class="product-item {% if produit_data.est_economie %}economy{% elif produit_data.ecart > 0 %}surcharge{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-box me-1"></i>{% trans "Inclus" %}: {{
                                                produit_data.quantite_incluse }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-graph-up me-1"></i>{% trans "Consommé" %}: {{
                                                produit_data.quantite_consommee }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-currency-dollar me-1"></i>{{
                                                produit_data.prix_unitaire|floatformat:2 }} DA/u
                                            </small>
                                        </div>
                                        {% if produit_data.ecart != 0 %}
                                        <div class="mt-2">
                                            {% if produit_data.ecart > 0 %}
                                            <span class="montant-supplement">
                                                <i class="bi bi-plus-circle me-1"></i>
                                                {% trans "Supplément" %}: +{{ produit_data.ecart|floatformat:1 }} = +{{
                                                produit_data.prix_ecart|floatformat:2 }} DA
                                            </span>
                                            {% else %}
                                            <span class="montant-economie">
                                                <i class="bi bi-dash-circle me-1"></i>
                                                {% trans "Économie" %}: {{ produit_data.ecart|floatformat:1 }} = {{
                                                produit_data.prix_ecart|floatformat:2 }} DA
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span
                                            class="badge {% if produit_data.ecart > 0 %}bg-danger{% elif produit_data.ecart < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                            {{ produit_data.quantite_consommee }}x
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Produits inclus dans le forfait -->
                {% if resume_consommation.forfait %}
                <div class="product-list mb-4">
                    <h6 class="mb-3">
                        <i class="bi bi-tag text-success"></i>
                        {% trans "Produits inclus dans le forfait" %} ({{ resume_consommation.forfait|length }})
                    </h6>
                    <div class="row">
                        {% for produit_data in resume_consommation.forfait %}
                        <div class="col-lg-6">
                            <div
                                class="product-item {% if produit_data.est_economie %}economy{% elif produit_data.ecart > 0 %}surcharge{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-box me-1"></i>{% trans "Inclus" %}: {{
                                                produit_data.quantite_incluse }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-graph-up me-1"></i>{% trans "Consommé" %}: {{
                                                produit_data.quantite_consommee }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-currency-dollar me-1"></i>{{
                                                produit_data.prix_unitaire|floatformat:2 }} DA/u
                                            </small>
                                        </div>
                                        {% if produit_data.ecart != 0 %}
                                        <div class="mt-2">
                                            {% if produit_data.ecart > 0 %}
                                            <span class="montant-supplement">
                                                <i class="bi bi-plus-circle me-1"></i>
                                                {% trans "Supplément" %}: +{{ produit_data.ecart|floatformat:1 }} = +{{
                                                produit_data.prix_ecart|floatformat:2 }} DA
                                            </span>
                                            {% else %}
                                            <span class="montant-economie">
                                                <i class="bi bi-dash-circle me-1"></i>
                                                {% trans "Économie" %}: {{ produit_data.ecart|floatformat:1 }} = {{
                                                produit_data.prix_ecart|floatformat:2 }} DA
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span
                                            class="badge {% if produit_data.ecart > 0 %}bg-danger{% elif produit_data.ecart < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                            {{ produit_data.quantite_consommee }}x
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Produits inclus dans les actes -->
                {% for acte_nom, produits_acte in resume_consommation.actes.items %}
                <div class="product-list mb-4">
                    <h6 class="mb-3">
                        <i class="bi bi-clipboard-check text-warning"></i>
                        {% trans "Produits inclus dans" %} "{{ acte_nom }}" ({{ produits_acte|length }})
                    </h6>
                    <div class="row">
                        {% for produit_data in produits_acte %}
                        <div class="col-lg-6">
                            <div
                                class="product-item {% if produit_data.est_economie %}economy{% elif produit_data.ecart > 0 %}surcharge{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-box me-1"></i>{% trans "Inclus" %}: {{
                                                produit_data.quantite_incluse }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-graph-up me-1"></i>{% trans "Consommé" %}: {{
                                                produit_data.quantite_consommee }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-currency-dollar me-1"></i>{{
                                                produit_data.prix_unitaire|floatformat:2 }} DA/u
                                            </small>
                                        </div>
                                        {% if produit_data.ecart != 0 %}
                                        <div class="mt-2">
                                            {% if produit_data.ecart > 0 %}
                                            <span class="montant-supplement">
                                                <i class="bi bi-plus-circle me-1"></i>
                                                {% trans "Supplément" %}: +{{ produit_data.ecart|floatformat:1 }} = +{{
                                                produit_data.prix_ecart|floatformat:2 }} DA
                                            </span>
                                            {% else %}
                                            <span class="montant-economie">
                                                <i class="bi bi-dash-circle me-1"></i>
                                                {% trans "Économie" %}: {{ produit_data.ecart|floatformat:1 }} = {{
                                                produit_data.prix_ecart|floatformat:2 }} DA
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <span
                                            class="badge {% if produit_data.ecart > 0 %}bg-danger{% elif produit_data.ecart < 0 %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                                            {{ produit_data.quantite_consommee }}x
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <!-- Produits supplémentaires -->
                {% if resume_consommation.supplementaires %}
                <div class="product-list">
                    <h6 class="mb-3">
                        <i class="bi bi-plus-circle text-danger"></i>
                        {% trans "Produits supplémentaires" %} ({{ resume_consommation.supplementaires|length }})
                    </h6>
                    <div class="row">
                        {% for produit_data in resume_consommation.supplementaires %}
                        <div class="col-lg-6">
                            <div class="product-item supplementaire">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ produit_data.produit }}</h6>
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <small class="text-muted">
                                                <i class="bi bi-graph-up me-1"></i>{% trans "Quantité" %}: {{
                                                produit_data.quantite_consommee }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-currency-dollar me-1"></i>{{
                                                produit_data.prix_unitaire|floatformat:2 }} DA/u
                                            </small>
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge bg-warning">
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                {% trans "Total" %}: {{ produit_data.prix_total|floatformat:2 }} DA
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-warning fs-6">{{ produit_data.quantite_consommee
                                            }}x</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Produits inclus (non facturés) - Mode facture uniquement -->
        {% if consommations %}
        <div class="detail-card fade-in facture-only" style="display: none;">
            <div class="detail-header bg-success">
                <h5 class="mb-0">
                    <i class="bi bi-box me-2"></i>{% trans "Produits inclus (non facturés)" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for consommation in consommations %}
                    {% if consommation.source_inclusion != 'SUPPLEMENTAIRE' and consommation.ecart_quantite <= 0 %} <div
                        class="col-md-6 mb-3">
                        <div class="product-item p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ consommation.produit.nom }}</strong>
                                    {% if consommation.produit.code_produit %}
                                    <small class="d-block text-muted">{% trans "Code" %}: {{
                                        consommation.produit.code_produit }}</small>
                                    {% endif %}
                                    <small class="d-block text-success">
                                        {% trans "Source" %}:
                                        {% if consommation.source_inclusion == 'BLOC' %}{% trans "Inclus dans le bloc"
                                        %}
                                        {% elif consommation.source_inclusion == 'FORFAIT' %}{% trans "Inclus dans le
                                        forfait" %}
                                        {% elif consommation.source_inclusion == 'ACTE' %}{% trans "Inclus dans l'acte"
                                        %}
                                        {% endif %}
                                    </small>
                                    {% if consommation.ecart_quantite < 0 %} <small class="d-block text-success">
                                        <i class="bi bi-arrow-down me-1"></i>{% trans "Économie" %}: {{
                                        consommation.economie|floatformat:2 }} DA
                                        </small>
                                        {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">{{ consommation.quantite|floatformat:1 }}x</span>
                                    <small class="d-block text-muted">{{ consommation.prix_unitaire|floatformat:2 }}
                                        DA/u</small>
                                </div>
                            </div>
                        </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% if resume_consommation.totaux.economies > 0 %}
            <div class="p-3 bg-success bg-opacity-10 rounded-3 border border-success border-opacity-25">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="text-success mb-1">
                            <i class="bi bi-piggy-bank me-2"></i>{% trans "Économies réalisées" %}
                        </h6>
                        <small class="text-muted">{% trans "Produits non consommés ou sous-consommés" %}</small>
                    </div>
                    <div class="col-auto">
                        <div class="text-success fw-bold fs-5">{{ resume_consommation.totaux.economies|floatformat:2 }}
                            DA</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Détails du forfait (mode détail uniquement) -->
    {% if location.type_tarification == 'FORFAIT' and location.forfait %}
    <div class="detail-card fade-in detail-only">
        <div class="detail-header bg-success">
            <h5 class="mb-0">
                <i class="bi bi-tag me-2"></i>{% trans "Détails du forfait" %} - {{ location.forfait.nom }}
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-row">
                        <div class="info-label">
                            <i class="bi bi-currency-dollar text-success"></i>
                            {% trans "Prix du forfait" %}
                        </div>
                        <div class="info-value">{{ location.forfait.prix|floatformat:2 }} DA</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">
                            <i class="bi bi-clock text-info"></i>
                            {% trans "Durée incluse" %}
                        </div>
                        <div class="info-value">{{ location.forfait.duree }} minutes</div>
                    </div>
                </div>
                <div class="col-md-6">
                    {% if location.duree_reelle > location.forfait.duree %}
                    <div class="info-row">
                        <div class="info-label">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            {% trans "Dépassement" %}
                        </div>
                        <div class="info-value">
                            <span class="badge bg-warning">
                                +{{
                                location.duree_reelle|add:location.forfait.duree|floatformat:0|add:"-"|add:location.forfait.duree|floatformat:0
                                }} minutes
                            </span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">
                            <i class="bi bi-plus-circle text-danger"></i>
                            {% trans "Supplément durée" %}
                        </div>
                        <div class="info-value text-danger">
                            <strong>{{ location.prix_supplement_duree|floatformat:2 }} DA</strong>
                        </div>
                    </div>
                    {% else %}
                    <div class="info-row">
                        <div class="info-value">
                            <span class="badge bg-success status-badge-large">
                                <i class="bi bi-check-circle"></i>
                                {% trans "Dans les limites du forfait" %}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if location.forfait.description %}
            <div class="info-row mt-3">
                <div class="info-label">
                    <i class="bi bi-info-circle text-info"></i>
                    {% trans "Description" %}
                </div>
                <div class="info-value">
                    <div class="bg-light-custom p-3 rounded-3">
                        {{ location.forfait.description|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Historique des modifications (mode détail uniquement) -->
    {% if location.audits.exists %}
    <div class="detail-card fade-in detail-only">
        <div class="detail-header bg-info">
            <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>{% trans "Historique des modifications" %}
                <span class="badge bg-light text-info ms-2">{{ location.audits.count }}</span>
            </h5>
        </div>
        <div class="card-body">
            {% for audit in location.audits.all|slice:":5" %}
            <div class="d-flex justify-content-between align-items-start mb-3 p-3 bg-light-custom rounded-3">
                <div class="flex-grow-1">
                    <h6 class="mb-1 text-primary">{{ audit.champ|title }}</h6>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        {% if audit.ancienne_valeur %}
                        <span class="badge bg-danger">{{ audit.ancienne_valeur|truncatechars:30 }}</span>
                        <i class="bi bi-arrow-right text-muted"></i>
                        {% endif %}
                        <span class="badge bg-success">{{ audit.nouvelle_valeur|truncatechars:30 }}</span>
                    </div>
                </div>
                <div class="text-end">
                    <small class="text-muted">
                        <strong>{{ audit.user.get_full_name|default:audit.user.username|default:"Système" }}</strong>
                        <br>{{ audit.date_modification|date:"d/m/Y H:i" }}
                    </small>
                </div>
            </div>
            {% endfor %}
            {% if location.audits.count > 5 %}
            <div class="text-center mt-3">
                <small class="text-muted">{% trans "Et" %} {{ location.audits.count|add:"-5" }} {% trans "autres
                    modifications..." %}</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Sidebar droite -->
<div class="col-xl-4 col-lg-5">
    <!-- Prix final -->
    <div class="detail-card fade-in">
        <div class="price-highlight">
            <h3 class="mb-3">
                <i class="bi bi-currency-dollar me-2"></i>
                <span class="detail-only">{% trans "Prix final de la location" %}</span>
                <span class="facture-only" style="display: none;">{% trans "Total de la facture" %}</span>
            </h3>
            <h2 class="mb-3">{{ location.montant_total_facture|floatformat:2 }} DA</h2>
            <div class="d-flex flex-column gap-2">
                <small class="opacity-75">{% trans "Toutes taxes comprises" %}</small>
                <small class="opacity-75 facture-only" style="display: none;">
                    {% trans "Facture" %} #BL-{{ location.id|stringformat:"05d" }}
                </small>
                {% if location.prix_supplement_duree > 0 %}
                <small class="opacity-75 detail-only">
                    <i class="bi bi-clock me-1"></i>
                    {% trans "dont" %} {{ location.prix_supplement_duree|floatformat:2 }} DA {% trans "de supplément
                    durée" %}
                </small>
                {% endif %}
                {% if location.montant_total_actes > 0 %}
                <small class="opacity-75 detail-only">
                    <i class="bi bi-clipboard-check me-1"></i>
                    {% trans "dont" %} {{ location.montant_total_actes|floatformat:2 }} DA {% trans "d'actes" %}
                </small>
                {% endif %}
                {% if location.montant_total_produits_supplementaires > 0 %}
                <small class="opacity-75 detail-only">
                    <i class="bi bi-plus-circle me-1"></i>
                    {% trans "dont" %} {{ location.montant_total_produits_supplementaires|floatformat:2 }} DA {% trans
                    "de produits supplémentaires" %}
                </small>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="detail-card fade-in no-print">
        <div class="detail-header bg-light-custom text-dark">
            <h5 class="mb-0">
                <i class="bi bi-gear me-2"></i>{% trans "Actions disponibles" %}
            </h5>
        </div>
        <div class="card-body">
            <div class="d-grid gap-3">
                <a href="{% url 'medical:location_bloc_edit' location.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil me-2"></i>{% trans "Modifier la location" %}
                </a>
                <button onclick="window.print()" class="btn btn-outline-success">
                    <i class="bi bi-printer me-2"></i>{% trans "Imprimer" %}
                </button>
                <button onclick="downloadPDF()" class