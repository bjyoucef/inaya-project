<!-- commandes/commande_list.html -->
{% extends "layout.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h1>Liste des bons de commande</h1>
  <a href="{% url 'pharmacies:commande_create' %}" class="btn btn-primary mb-3">
    <i class="fas fa-plus"></i> Nouvelle commande
  </a>

  <table class="table table-striped table-hover">
    <thead class="thead-dark">
      <tr>
        <th>Numéro</th>
        <th>Fournisseur</th>
        <th>Date</th>
        <th>Statut</th>
        <th>Montant total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for commande in commandes %}
      <tr>
        <td>{{ commande.numero_commande }}</td>
        <td>{{ commande.fournisseur }}</td>
        <td>{{ commande.date_commande|date:"d/m/Y" }}</td>
        <td>
          <span class="badge badge-{{ commande.get_status_badge }}">
            {{ commande.get_statut_display }}
          </span>
        </td>
        <td>{{ commande.montant_total|floatformat:2 }} DA</td>
        <td>
          <div class="d-flex gap-1 flex-wrap">
            <!-- Bouton Voir -->
            <a href="{{ commande.get_absolute_url }}" 
               class="btn btn-sm btn-info"
               title="Détails">
              <i class="fas fa-eye"></i>
            </a>

            <!-- Bouton Modifier -->
            <a href="{% url 'pharmacies:commande_update' commande.pk %}" 
               class="btn btn-sm btn-warning"
               title="Modifier">
              <i class="fas fa-edit"></i>
            </a>

            <!-- Sélecteur de statut -->
            <form method="post" 
                  action="{% url 'pharmacies:commande_update_statut' commande.pk %}"
                  class="d-inline">
              {% csrf_token %}
              <select name="statut" 
                      class="form-select form-select-sm" 
                      onchange="this.form.submit()"
                      title="Changer le statut">
                {% for value, display in commande.STATUT_CHOICES %}
                <option value="{{ value }}" 
                        {% if commande.statut == value %}selected{% endif %}>
                  {{ display }}
                </option>
                {% endfor %}
              </select>
            </form>

            <!-- Bouton Créer BL -->
            {% if commande.statut == 'VALIDE' %}
            <a href="{% url 'pharmacies:livraison_create' commande_pk=commande.pk %}"
               class="btn btn-sm btn-success"
               title="Créer bon de livraison">
              <i class="fas fa-truck"></i>
            </a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center">Aucune commande trouvée</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  {% include 'includes/pagination.html' %}
</div>
{% endblock %}